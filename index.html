<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4f46e5">
    <title>Finanzas Familiares</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- üîê Sistema de Configuraci√≥n Simplificado -->
    <script>
        // üöÄ Sistema simplificado - secure-config.js maneja toda la configuraci√≥n
        console.log('üîê Sistema de configuraci√≥n simplificado iniciado');

        // üîÑ Funci√≥n para esperar que se cargue la configuraci√≥n
        function waitForConfiguration() {
            return new Promise((resolve) => {
                const checkConfig = () => {
                    if (window.APP_CONFIG && window.firebaseConfig) {
                        console.log('‚úÖ Configuraci√≥n cargada correctamente');
                        resolve(true);
                    } else {
                        setTimeout(checkConfig, 100);
                    }
                };
                checkConfig();
            });
        }

        // üöÄ Inicializaci√≥n simplificada
        async function initializeSimplified() {
            console.log('üîÑ Esperando configuraci√≥n de secure-config.js...');
            await waitForConfiguration();
            console.log('‚úÖ Configuraci√≥n lista, inicializando aplicaci√≥n...');
            initializeApp();
        }

        // üéØ Iniciar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeSimplified();
                // Detectar entorno de testing despu√©s de la inicializaci√≥n
                setTimeout(() => {
                    window.detectTestingEnvironment();
                }, 200);
            });
        } else {
            initializeSimplified();
            // Detectar entorno de testing despu√©s de la inicializaci√≥n
            setTimeout(() => {
                window.detectTestingEnvironment();
            }, 200);
        }

        // üöÄ Funci√≥n simplificada para inicializar la aplicaci√≥n
        function initializeApp() {
            console.log('üîÑ Inicializando aplicaci√≥n...');

            if (window.firebaseConfig && typeof initializeConfiguration === 'function') {
                if (initializeConfiguration()) {
                    console.log('‚úÖ Configuraci√≥n inicializada, cargando autenticaci√≥n.');
                    if (typeof initAuth === 'function') {
                        initAuth();
                    } else {
                        console.error('‚ùå La funci√≥n initAuth no est√° definida.');
                    }
                } else {
                    console.error('‚ùå Fall√≥ initializeConfiguration.');
                }
            } else {
                console.error('‚ùå Configuraci√≥n de Firebase no disponible o initializeConfiguration no definida.');
            }
        }

        // üîê Sistema simplificado - secure-config.js maneja toda la configuraci√≥n
        console.log('üîê Configuraci√≥n manejada por secure-config.js');

        // üîç Funci√≥n de diagn√≥stico global para debugging
        window.diagnosticarBackups = async function() {
            console.log('üîç Ejecutando diagn√≥stico del sistema de backups...');

            if (!automaticBackupSystem) {
                console.error('‚ùå Sistema de backups no inicializado');
                return {
                    error: 'Sistema de backups no inicializado',
                    solution: 'Intenta abrir el panel de backups primero'
                };
            }

            try {
                const diagnostics = await automaticBackupSystem.runDiagnostics();
                console.log('üìä Resultados del diagn√≥stico:', diagnostics);
                return diagnostics;
            } catch (error) {
                console.error('‚ùå Error ejecutando diagn√≥stico:', error);
                return {
                    error: error.message,
                    solution: 'Verifica la consola para m√°s detalles'
                };
            }
        };

        // üß™ Funci√≥n de prueba r√°pida global
        window.probarBackups = async function() {
            console.log('üß™ Ejecutando prueba r√°pida del sistema de backups...');

            if (!automaticBackupSystem) {
                console.error('‚ùå Sistema de backups no inicializado');
                return false;
            }

            try {
                const testBackupId = await automaticBackupSystem.performTestBackup();
                console.log('‚úÖ Prueba exitosa. Backup de prueba:', testBackupId);
                return true;
            } catch (error) {
                console.error('‚ùå Error en prueba:', error);
                return false;
            }
        };

        // üìä Funci√≥n de diagn√≥stico para Dashboard Predictivo
        window.diagnosticarDashboard = async function() {
            console.log('üìä Ejecutando diagn√≥stico del Dashboard Predictivo...');

            const diagnostics = {
                timestamp: new Date().toISOString(),
                system: {
                    chartJsAvailable: typeof Chart !== 'undefined',
                    predictiveAnalyticsEngineAvailable: typeof PredictiveAnalyticsEngine !== 'undefined',
                    predictiveDashboardAvailable: typeof PredictiveDashboard !== 'undefined',
                    userAuthenticated: firebase.auth()?.currentUser ? true : false,
                    transactionsCount: getTransactions ? getTransactions().length : 0
                },
                instances: {
                    predictiveAnalyticsEngine: !!predictiveAnalyticsEngine,
                    predictiveDashboard: !!predictiveDashboard,
                    engineInitialized: predictiveAnalyticsEngine?.initialized || false
                }
            };

            console.log('üìä Diagn√≥stico del Dashboard Predictivo:', diagnostics);
            return diagnostics;
        };

        // üß™ Funci√≥n de prueba para Dashboard Predictivo
        window.probarDashboard = async function() {
            console.log('üß™ Ejecutando prueba del Dashboard Predictivo...');

            try {
                const diagnostics = await diagnosticarDashboard();

                if (!diagnostics.system.chartJsAvailable) {
                    console.error('‚ùå Chart.js no disponible');
                    return false;
                }

                if (!diagnostics.system.predictiveAnalyticsEngineAvailable) {
                    console.error('‚ùå PredictiveAnalyticsEngine no disponible');
                    return false;
                }

                if (!diagnostics.system.predictiveDashboardAvailable) {
                    console.error('‚ùå PredictiveDashboard no disponible');
                    return false;
                }

                if (diagnostics.system.transactionsCount === 0) {
                    console.warn('‚ö†Ô∏è No hay transacciones para analizar');
                    return false;
                }

                // Intentar abrir el dashboard
                await openPredictiveDashboard();
                console.log('‚úÖ Dashboard Predictivo funcionando correctamente');
                return true;

            } catch (error) {
                console.error('‚ùå Error en prueba del dashboard:', error);
                return false;
            }
        };

        // üß™ Funciones globales de testing para debugging
        window.ejecutarTests = async function() {
            console.log('üß™ Ejecutando todos los tests...');

            if (!testRunner) {
                console.error('‚ùå Test Runner no inicializado');
                return false;
            }

            try {
                const results = await testRunner.runAllTests();
                console.log('‚úÖ Tests completados:', results);
                return results;
            } catch (error) {
                console.error('‚ùå Error ejecutando tests:', error);
                return false;
            }
        };

        // üîß Funci√≥n para detectar entorno de testing y hacer visible el elemento #app
        window.enableTestingMode = function() {
            console.log('üß™ Habilitando modo de testing...');
            const appElement = document.getElementById('app');
            if (appElement) {
                // Remover la clase 'hidden' para hacer visible el elemento durante tests
                appElement.classList.remove('hidden');
                // Asegurar que el elemento sea visible
                appElement.style.display = 'block';
                console.log('‚úÖ Elemento #app ahora visible para testing');
                return true;
            } else {
                console.error('‚ùå Elemento #app no encontrado');
                return false;
            }
        };

        // üîß Funci√≥n para restaurar el modo normal
        window.disableTestingMode = function() {
            console.log('üîÑ Restaurando modo normal...');
            const appElement = document.getElementById('app');
            if (appElement) {
                // Restaurar la clase 'hidden' si no hay usuario autenticado
                if (!firebase.auth()?.currentUser) {
                    appElement.classList.add('hidden');
                    appElement.style.display = '';
                }
                console.log('‚úÖ Modo normal restaurado');
                return true;
            } else {
                console.error('‚ùå Elemento #app no encontrado');
                return false;
            }
        };

        // üíæ Funci√≥n para inicializar sistemas necesarios para testing
        window.initializeSystemsForTesting = async function() {
            console.log('üíæ Inicializando sistemas para testing...');

            try {
                // Inicializar sistema de backups si no existe
                if (!automaticBackupSystem && typeof AutomaticBackupSystem !== 'undefined') {
                    console.log('üíæ Inicializando AutomaticBackupSystem para testing...');
                    automaticBackupSystem = new AutomaticBackupSystem();

                    // Inicializar completamente para que funcionen los diagn√≥sticos
                    try {
                        const initialized = await automaticBackupSystem.initialize();
                        if (initialized) {
                            console.log('‚úÖ AutomaticBackupSystem completamente inicializado para testing');
                        } else {
                            console.warn('‚ö†Ô∏è AutomaticBackupSystem parcialmente inicializado para testing');
                        }
                    } catch (initError) {
                        console.warn('‚ö†Ô∏è Error inicializando AutomaticBackupSystem completamente, usando inicializaci√≥n b√°sica:', initError.message);
                        // Configurar propiedades m√≠nimas necesarias para testing
                        automaticBackupSystem.initialized = true;
                        automaticBackupSystem.settings = {
                            autoBackupEnabled: true,
                            backupFrequency: 'daily',
                            maxBackupsToKeep: 7
                        };
                    }
                }

                // Inicializar sistema de exportaci√≥n si no existe
                if (!multiExportSystem && typeof MultiExportSystem !== 'undefined') {
                    console.log('üì§ Inicializando MultiExportSystem para testing...');
                    multiExportSystem = new MultiExportSystem();
                    console.log('‚úÖ MultiExportSystem inicializado para testing');
                }

                // Inicializar UI de backups si no existe
                if (!backupManagementUI && typeof BackupManagementUI !== 'undefined') {
                    console.log('üé® Inicializando BackupManagementUI para testing...');
                    backupManagementUI = new BackupManagementUI();
                    console.log('‚úÖ BackupManagementUI inicializado para testing');
                }

                console.log('‚úÖ Sistemas inicializados para testing');
                return true;
            } catch (error) {
                console.error('‚ùå Error inicializando sistemas para testing:', error);
                return false;
            }
        };

        // üß™ Auto-detectar si estamos en entorno de testing
        window.detectTestingEnvironment = function() {
            // Detectar si estamos ejecutando tests basado en varios indicadores
            const isTestingEnvironment =
                // Solo activar modo testing si se llama expl√≠citamente
                (window.isTestingMode === true) ||
                // O si se est√° ejecutando desde una funci√≥n de testing espec√≠fica
                (window.location.href.includes('execute-tests')) ||
                // O si se detecta una ejecuci√≥n manual de tests
                (window.manualTestExecution === true);

            if (isTestingEnvironment) {
                console.log('üß™ Entorno de testing detectado, habilitando modo testing...');
                setTimeout(() => {
                    window.enableTestingMode();
                    // üíæ Inicializar sistemas para testing
                    window.initializeSystemsForTesting();
                }, 100);
            }

            return isTestingEnvironment;
        };

        window.ejecutarTestSuite = async function(suiteName) {
            console.log(`üß™ Ejecutando suite: ${suiteName}...`);

            if (!testRunner) {
                console.error('‚ùå Test Runner no inicializado');
                return false;
            }

            try {
                const results = await testRunner.runSuite(suiteName);
                console.log(`‚úÖ Suite ${suiteName} completada:`, results);
                return results;
            } catch (error) {
                console.error(`‚ùå Error ejecutando suite ${suiteName}:`, error);
                return false;
            }
        };

        window.estadoTesting = function() {
            console.log('üß™ Estado del sistema de testing:');

            const estado = {
                clases: {
                    TestingFramework: typeof TestingFramework !== 'undefined',
                    TestRunner: typeof TestRunner !== 'undefined',
                    TestingUI: typeof TestingUI !== 'undefined',
                    expect: typeof expect !== 'undefined'
                },
                instancias: {
                    testingFramework: !!testingFramework,
                    testRunner: !!testRunner,
                    testingUI: !!testingUI,
                    windowAppTests: !!window.appTests
                },
                datos: {
                    suitesDisponibles: testingFramework ? Array.from(testingFramework.suites.keys()) : [],
                    totalTests: testingFramework ? testingFramework.results.total : 0,
                    ultimosResultados: testingFramework ? testingFramework.results : null
                }
            };

            console.log(estado);
            return estado;
        };

        window.diagnosticarTesting = function() {
            console.log('üîç Diagn√≥stico completo del sistema de testing:');

            const diagnostico = {
                timestamp: new Date().toISOString(),
                scripts: {
                    'testing-framework.js': typeof TestingFramework !== 'undefined',
                    'assertions.js': typeof expect !== 'undefined',
                    'test-runner.js': typeof TestRunner !== 'undefined',
                    'test-ui.js': typeof TestingUI !== 'undefined',
                    'app-tests.js': !!window.appTests
                },
                variables: {
                    testingFramework: !!testingFramework,
                    testRunner: !!testRunner,
                    testingUI: !!testingUI
                },
                boton: {
                    existe: false, // Bot√≥n Testing eliminado de la interfaz
                    visible: false,
                    eventListener: 'Bot√≥n eliminado - no aplicable'
                }
            };

            console.log(diagnostico);

            // Verificar si hay errores
            const errores = [];
            if (!diagnostico.scripts['testing-framework.js']) errores.push('testing-framework.js no cargado');
            if (!diagnostico.scripts['assertions.js']) errores.push('assertions.js no cargado');
            if (!diagnostico.scripts['test-runner.js']) errores.push('test-runner.js no cargado');
            if (!diagnostico.scripts['test-ui.js']) errores.push('test-ui.js no cargado');
            if (!diagnostico.scripts['app-tests.js']) errores.push('app-tests.js no cargado');
            if (!diagnostico.variables.testingFramework) errores.push('testingFramework no inicializado');
            if (!diagnostico.variables.testRunner) errores.push('testRunner no inicializado');
            if (!diagnostico.variables.testingUI) errores.push('testingUI no inicializado');
            // Bot√≥n testing-panel-btn eliminado intencionalmente de la interfaz

            if (errores.length > 0) {
                console.error('‚ùå Errores encontrados:', errores);
            } else {
                console.log('‚úÖ Sistema de testing parece estar correcto');
            }

            return diagnostico;
        };

        window.probarBotonTesting = function() {
            console.log('üß™ Bot√≥n Testing eliminado de la interfaz');
            console.log('‚ÑπÔ∏è El bot√≥n Testing fue removido para simplificar la interfaz de usuario');
            return false; // Bot√≥n no disponible
        };

        window.forzarInicializacionTesting = function() {
            console.log('üîß Forzando inicializaci√≥n del sistema de testing...');

            try {
                // Verificar que las clases est√©n disponibles
                if (typeof TestingFramework === 'undefined') {
                    console.error('‚ùå TestingFramework no disponible');
                    return false;
                }

                if (typeof TestRunner === 'undefined') {
                    console.error('‚ùå TestRunner no disponible');
                    return false;
                }

                if (typeof TestingUI === 'undefined') {
                    console.error('‚ùå TestingUI no disponible');
                    return false;
                }

                // Forzar inicializaci√≥n
                testingFramework = window.appTests;

                if (testingFramework) {
                    testRunner = new TestRunner();
                    testRunner.initialize(testingFramework);

                    testingUI = new TestingUI();
                    testingUI.initialize(testRunner);

                    // Event listener del bot√≥n Testing removido - bot√≥n eliminado de la interfaz

                    console.log('‚úÖ Sistema de testing forzado exitosamente');
                    return true;
                } else {
                    console.error('‚ùå window.appTests no disponible');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error forzando inicializaci√≥n:', error);
                return false;
            }
        };





        // üîê Medidas de seguridad adicionales
        if (window.location.hostname === 'alvaretto.github.io') {
            console.log('üõ°Ô∏è Medidas de seguridad activas:');
            console.log('  ‚Ä¢ API Key restringida solo para alvaretto.github.io');
            console.log('  ‚Ä¢ Firebase con reglas de autenticaci√≥n estrictas');
            console.log('  ‚Ä¢ Acceso a datos limitado por UID espec√≠ficos');
            console.log('  ‚Ä¢ Configuraci√≥n optimizada para uso familiar');
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .prose-dark { color: #d1d5db; }
        .prose-dark h2, .prose-dark h3, .prose-dark strong { color: #f9fafb; }
        .prose-dark ul > li::before { background-color: #9ca3af; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        .chat-bubble-user { background-color: #4f46e5; color: white; }
        .chat-bubble-ai { background-color: #e5e7eb; color: #1f2937; }
        .dark .chat-bubble-ai { background-color: #374151; color: #d1d5db; }

        /* Mejoras para formularios extensos */
        .modal-content {
            scroll-behavior: smooth;
        }

        .form-section {
            transition: all 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .progress-dot {
            transition: all 0.3s ease;
        }

        .progress-dot.active {
            transform: scale(1.2);
        }

        .specific-field {
            transition: all 0.2s ease;
        }

        .specific-field:focus-within {
            transform: translateY(-1px);
        }

        /* Scroll personalizado */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        /* Animaciones suaves para campos din√°micos */
        .dynamic-field {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* üì± OPTIMIZACIONES ESPEC√çFICAS PARA M√ìVILES ANDROID */

        /* Mejora de usabilidad t√°ctil */
        .touch-manipulation {
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* Tama√±o m√≠nimo para elementos t√°ctiles (44px recomendado por Google) */
        button, .btn, [role="button"] {
            min-height: 44px;
            min-width: 44px;
        }

        /* Espaciado mejorado para m√≥viles */
        @media (max-width: 640px) {
            /* Contenedor principal con padding optimizado */
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }

            /* Botones de herramientas con mejor espaciado */
            .flex.gap-2.flex-wrap {
                gap: 0.75rem;
                justify-content: center;
            }

            /* Botones m√°s grandes en m√≥viles */
            .flex.gap-2.flex-wrap button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                min-height: 48px;
                border-radius: 0.75rem;
            }

            /* T√≠tulos m√°s compactos */
            h1 {
                font-size: 1.5rem;
                line-height: 2rem;
            }

            h2 {
                font-size: 1.25rem;
                line-height: 1.75rem;
            }

            /* Tarjetas con mejor espaciado */
            .bg-white.rounded-2xl.shadow-lg,
            .bg-slate-800.rounded-2xl.shadow-lg {
                margin-bottom: 1rem;
                padding: 1rem;
            }

            /* Bot√≥n flotante m√°s accesible */
            #add-transaction-btn {
                bottom: 1.5rem;
                right: 1.5rem;
                width: 56px;
                height: 56px;
            }

            /* Modales optimizados para m√≥viles */
            .modal-backdrop .bg-white,
            .modal-backdrop .bg-gray-800 {
                margin: 0.5rem;
                max-height: 95vh;
                border-radius: 1rem;
            }

            /* Formularios m√°s amigables en m√≥viles */
            input, select, textarea {
                font-size: 16px; /* Evita zoom en iOS */
                padding: 0.75rem;
                border-radius: 0.5rem;
            }

            /* Navegaci√≥n superior m√°s compacta */
            .flex.justify-between.items-center.mb-6 {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            /* Botones del header m√°s accesibles */
            .flex.gap-2:has(#manage-categories-btn) {
                gap: 0.5rem;
            }

            .flex.gap-2:has(#manage-categories-btn) button {
                padding: 0.5rem;
                min-width: 44px;
                min-height: 44px;
            }
        }

        /* Optimizaciones espec√≠ficas para Android Chrome */
        @media (max-width: 480px) {
            /* Viewport m√°s peque√±o - tel√©fonos en vertical */
            body {
                font-size: 14px;
            }

            /* Botones a√∫n m√°s grandes para dedos */
            .flex.gap-2.flex-wrap button {
                min-height: 52px;
                padding: 1rem 1.25rem;
            }

            /* Espaciado entre secciones */
            section {
                margin-bottom: 1.5rem;
            }

            /* Gr√°ficos m√°s peque√±os */
            .h-64 {
                height: 12rem;
            }

            /* Lista de transacciones m√°s compacta */
            #transaction-list .space-y-3 > * + * {
                margin-top: 0.75rem;
            }
        }

        /* Mejoras para orientaci√≥n horizontal en m√≥viles */
        @media (max-width: 896px) and (orientation: landscape) {
            /* Aprovechar mejor el espacio horizontal */
            .flex.flex-col.sm\\:flex-row {
                flex-direction: row;
            }

            /* Botones en l√≠nea cuando hay espacio */
            .flex.gap-2.flex-wrap {
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }

            .flex.gap-2.flex-wrap::-webkit-scrollbar {
                height: 4px;
            }

            .flex.gap-2.flex-wrap::-webkit-scrollbar-thumb {
                background: rgba(0, 0, 0, 0.3);
                border-radius: 2px;
            }
        }

        /* üì± Correcciones espec√≠ficas para dispositivos m√≥viles - Scroll en selectores */
        .mobile-select-fix {
            /* Mejorar scroll t√°ctil en iOS */
            -webkit-overflow-scrolling: touch;
            /* Permitir interacci√≥n t√°ctil suave */
            touch-action: manipulation;
            /* Asegurar que el elemento sea scrolleable */
            overflow-y: auto;
            /* Mejorar rendimiento en dispositivos m√≥viles */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            /* Prevenir zoom accidental en iOS */
            -webkit-text-size-adjust: 100%;
        }

        /* Correcciones espec√≠ficas para contenedores scrolleables en m√≥viles */
        .mobile-scroll-container {
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            overflow-y: auto;
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        /* Correcciones para modales en dispositivos m√≥viles */
        @media (max-width: 768px) {
            .modal-backdrop {
                /* Prevenir scroll del body cuando el modal est√° abierto */
                overscroll-behavior: contain;
            }

            /* Mejorar scroll en listas de elementos */
            #accounts-payable-list {
                -webkit-overflow-scrolling: touch;
                touch-action: pan-y;
                overscroll-behavior: contain;
            }

            /* Asegurar que los selectores funcionen correctamente en m√≥viles */
            select.mobile-select-fix {
                /* Altura m√≠nima para facilitar el toque */
                min-height: 44px;
                /* Espaciado interno adecuado para m√≥viles */
                padding: 12px 16px;
                /* Tama√±o de fuente legible en m√≥viles */
                font-size: 16px;
                /* Prevenir zoom autom√°tico en iOS */
                -webkit-appearance: none;
                appearance: none;
            }
        }

        /* Correcciones adicionales para Android */
        @media (max-width: 768px) and (-webkit-min-device-pixel-ratio: 1) {
            .mobile-select-fix option {
                /* Asegurar que las opciones sean visibles */
                background-color: white;
                color: black;
                padding: 8px 12px;
            }

            .dark .mobile-select-fix option {
                background-color: #374151;
                color: white;
            }
        }

        /* üé® Estilos para el overlay de selecci√≥n de categor√≠as */
        .category-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .category-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .category-overlay-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            max-width: 90vw;
            max-height: 85vh;
            width: 100%;
            margin: 20px;
            display: flex;
            flex-direction: column;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
            overflow: hidden;
        }

        .dark .category-overlay-content {
            background: #1f2937;
            border: 1px solid #374151;
        }

        .category-overlay.active .category-overlay-content {
            transform: scale(1) translateY(0);
        }

        .category-overlay-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: between;
            align-items: center;
            flex-shrink: 0;
        }

        .dark .category-overlay-header {
            border-bottom-color: #374151;
        }

        .category-overlay-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }

        .category-option {
            display: flex;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s ease;
            user-select: none;
        }

        .dark .category-option {
            border-bottom-color: #374151;
        }

        .category-option:hover {
            background-color: #f9fafb;
        }

        .dark .category-option:hover {
            background-color: #374151;
        }

        .category-option.selected {
            background-color: #ede9fe;
            color: #7c3aed;
            font-weight: 600;
        }

        .dark .category-option.selected {
            background-color: #4c1d95;
            color: #c4b5fd;
        }

        .category-option-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .category-option.selected .category-option-icon {
            opacity: 1;
        }

        .category-overlay-footer {
            padding: 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            flex-shrink: 0;
        }

        .dark .category-overlay-footer {
            border-top-color: #374151;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .category-overlay-content {
                margin: 10px;
                max-height: 90vh;
                border-radius: 12px;
            }

            .category-overlay-header,
            .category-overlay-footer {
                padding: 16px;
            }

            .category-option {
                padding: 14px 16px;
            }
        }

        /* Accessibility improvements */
        .category-overlay:focus-within {
            outline: none;
        }

        .category-option:focus {
            outline: 2px solid #7c3aed;
            outline-offset: -2px;
        }

        /* Animation for better UX */
        @keyframes overlayFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }

        @keyframes overlaySlideUp {
            from {
                transform: scale(0.95) translateY(20px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-slate-800 dark:text-slate-200 antialiased">

    <!-- Auth Screen -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-lg">
            <h2 id="auth-title" class="text-2xl font-bold text-center text-indigo-600 dark:text-indigo-400 mb-6">Iniciar Sesi√≥n</h2>
            <form id="auth-form">
                <div class="mb-4">
                    <label for="email" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Correo Electr√≥nico</label>
                    <input type="email" id="email" class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Contrase√±a</label>
                    <input type="password" id="password" class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border border-slate-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" required minlength="6">
                </div>
                <div class="text-right mb-4">
                    <button type="button" id="forgot-password-btn" class="text-sm font-semibold text-indigo-600 dark:text-indigo-400 hover:underline">Olvid√© mi contrase√±a</button>
                </div>
                <p id="auth-error" class="text-red-500 text-sm text-center mb-4 h-5"></p>
                <button type="submit" id="auth-submit-btn" class="w-full bg-indigo-600 text-white py-3 rounded-md font-semibold hover:bg-indigo-700 transition-colors">Acceder</button>
            </form>
            <p class="text-center text-sm text-slate-500 dark:text-slate-400 mt-6">
                <span id="auth-toggle-text">¬øNo tienes una cuenta?</span>
                <button id="auth-toggle-btn" class="font-semibold text-indigo-600 dark:text-indigo-400 hover:underline">Reg√≠strate</button>
            </p>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app" class="container mx-auto max-w-2xl p-4 sm:p-6 hidden">
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
                <div class="text-center sm:text-left">
                    <p class="text-sm text-slate-500 dark:text-slate-400">Bienvenido/a,</p>
                    <p id="user-email" class="font-semibold text-sm sm:text-base"></p>
                </div>
                <div class="flex items-center justify-center sm:justify-end gap-2">
                    <button id="manage-categories-btn" class="flex items-center gap-1 px-3 py-2 text-sm font-medium text-slate-600 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-slate-100 dark:hover:bg-gray-700 rounded-md transition-colors min-h-[44px] touch-manipulation">
                        <i data-lucide="folder-tree" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Categor√≠as</span><span class="sm:hidden">üìÅ</span>
                    </button>
                    <button id="logout-btn" class="px-3 py-2 text-sm font-medium text-indigo-600 dark:text-indigo-400 hover:underline min-h-[44px] touch-manipulation">Cerrar Sesi√≥n</button>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors inline-flex min-h-[44px] min-w-[44px] touch-manipulation"><i data-lucide="sun" class="block dark:hidden w-5 h-5"></i><i data-lucide="moon" class="hidden dark:block w-5 h-5"></i></button>
                </div>
            </div>
        </header>

        <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md"><h2 class="text-sm font-medium text-slate-500 dark:text-slate-400">Saldo Actual</h2><p id="balance" class="text-2xl font-semibold mt-1">$0.00</p></div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md"><h2 class="text-sm font-medium text-slate-500 dark:text-slate-400">Ingresos Totales</h2><p id="total-income" class="text-2xl font-semibold mt-1 text-green-500">$0.00</p></div>
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md"><h2 class="text-sm font-medium text-slate-500 dark:text-slate-400">Gastos Totales</h2><p id="total-expense" class="text-2xl font-semibold mt-1 text-red-500">$0.00</p></div>
        </section>

        <!-- Patrimonio Section -->
        <section class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
                <h2 class="text-lg font-semibold flex items-center gap-2">
                    <i data-lucide="trending-up" class="w-5 h-5 text-blue-500"></i>
                    Patrimonio Neto
                </h2>
                <div class="flex gap-2 justify-center sm:justify-end flex-wrap">
                    <button id="manage-assets-btn" class="flex items-center gap-1 px-3 py-2 text-sm font-medium text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-md transition-colors min-h-[44px] touch-manipulation">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Activos</span><span class="sm:hidden">+</span>
                    </button>
                    <button id="manage-liabilities-btn" class="flex items-center gap-1 px-3 py-2 text-sm font-medium text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors min-h-[44px] touch-manipulation">
                        <i data-lucide="minus-circle" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Pasivos</span><span class="sm:hidden">-</span>
                    </button>
                    <button id="manage-accounts-payable-btn" class="flex items-center gap-1 px-3 py-2 text-sm font-medium text-purple-600 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-md transition-colors min-h-[44px] touch-manipulation">
                        <i data-lucide="credit-card" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Cuentas por Pagar</span><span class="sm:hidden">üí≥</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-4 gap-4">
                <div class="text-center">
                    <p class="text-sm text-slate-500 dark:text-slate-400">Total Activos</p>
                    <p id="total-assets" class="text-xl font-semibold text-green-600 dark:text-green-400">$0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-500 dark:text-slate-400">Total Pasivos</p>
                    <p id="total-liabilities" class="text-xl font-semibold text-red-600 dark:text-red-400">$0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-500 dark:text-slate-400">Patrimonio Neto</p>
                    <p id="net-worth" class="text-xl font-semibold text-blue-600 dark:text-blue-400">$0.00</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-500 dark:text-slate-400">Nivel Endeudamiento</p>
                    <p id="debt-ratio" class="text-xl font-semibold text-orange-600 dark:text-orange-400">0%</p>
                </div>
            </div>

            <div class="mt-4">
                <div class="flex justify-between text-sm text-slate-500 dark:text-slate-400 mb-1">
                    <span>Salud Financiera</span>
                    <span id="financial-health-text">Evaluando...</span>
                </div>
                <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-2">
                    <div id="financial-health-bar" class="h-2 rounded-full transition-all duration-500 bg-blue-500" style="width: 0%;"></div>
                </div>
            </div>
        </section>

        <section id="budget-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-6">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-lg font-semibold">Presupuesto Mensual</h2>
                <button id="edit-budget-btn" class="p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
            </div>
            <p class="text-sm text-slate-500 dark:text-slate-400">Gastado: <span id="budget-spent" class="font-semibold"></span> de <span id="budget-total" class="font-semibold"></span></p>
            <div class="w-full bg-slate-200 dark:bg-gray-700 rounded-full h-4 mt-2"><div id="budget-progress" class="h-4 rounded-full transition-all duration-500" style="width: 0%;"></div></div>
        </section>

        <section class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md mb-6">
            <h2 class="text-lg font-semibold mb-2">Gastos por Categor√≠a</h2>
            <div class="h-64 relative"><canvas id="finance-chart"></canvas><div id="chart-empty-state" class="absolute inset-0 flex items-center justify-center hidden"><p class="text-slate-500 dark:text-slate-400">No hay datos de gastos para mostrar.</p></div></div>
        </section>
        
        <section class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 gap-3">
            <h2 class="text-xl font-semibold">Historial de Transacciones</h2>
            <div class="flex gap-2 flex-wrap justify-center sm:justify-end">
                <button id="tips-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-teal-600 rounded-lg shadow-md hover:bg-teal-700 transition-colors min-h-[44px] touch-manipulation"><i data-lucide="lightbulb" class="w-4 h-4"></i> <span class="hidden sm:inline">Tips IA</span><span class="sm:hidden">Tips</span></button>
                <button id="ai-assistant-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-purple-600 rounded-lg shadow-md hover:bg-purple-700 transition-colors min-h-[44px] touch-manipulation"><i data-lucide="brain-circuit" class="w-4 h-4"></i> <span class="hidden sm:inline">FinGenius üß†</span><span class="sm:hidden">IA</span></button>
                <button id="proactive-insights-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg shadow-md hover:from-purple-700 hover:to-pink-700 transition-colors relative min-h-[44px] touch-manipulation"><i data-lucide="zap" class="w-4 h-4"></i> <span class="hidden sm:inline">Insights</span><span class="sm:hidden">üí°</span> <span id="insights-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">0</span></button>
                <button id="predictive-dashboard-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg shadow-md hover:from-blue-700 hover:to-indigo-700 transition-colors min-h-[44px] touch-manipulation"><i data-lucide="trending-up" class="w-4 h-4"></i> <span class="hidden sm:inline">Dashboard Predictivo</span><span class="sm:hidden">Dashboard</span></button>
                <button id="backup-management-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-gradient-to-r from-green-600 to-emerald-600 rounded-lg shadow-md hover:from-green-700 hover:to-emerald-700 transition-colors min-h-[44px] touch-manipulation"><i data-lucide="shield-check" class="w-4 h-4"></i> <span class="hidden sm:inline">Backups</span><span class="sm:hidden">üíæ</span></button>
            </div>
        </section>
        <div id="transaction-list" class="space-y-3"><p class="text-center text-slate-500 dark:text-slate-400 py-4">No hay transacciones todav√≠a.</p></div>
        <button id="add-transaction-btn" class="fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 transition-transform transform hover:scale-110 touch-manipulation z-40 min-h-[56px] min-w-[56px]"><i data-lucide="plus" class="w-6 h-6"></i></button>
        
        <!-- Modals -->
        <div id="transaction-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="budget-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="ai-chat-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="tips-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="categories-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="assets-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="asset-form-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="liabilities-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="liability-form-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="accounts-payable-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="account-payable-form-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="payment-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="accounts-payable-calendar-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
        <div id="predictive-dashboard-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-backdrop hidden"></div>
    </div>

    <!-- Firebase SDK v9 - Compatibilidad -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- üîê Sistema de Configuraci√≥n Segura -->
    <script src="secure-config.js"></script>

    <!-- üß† Sistema de IA Avanzado - Desaf√≠o 1 -->
    <script src="ai-memory-system.js"></script>
    <script src="ai-learning-engine.js"></script>
    <script src="proactive-insights-engine.js"></script>

    <!-- üìä Dashboard Predictivo - Desaf√≠o 2 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="predictive-analytics-engine.js"></script>
    <script src="predictive-dashboard.js"></script>

    <!-- üíæ Sistema de Backups Autom√°ticos -->
    <script src="automatic-backup-system.js"></script>
    <script src="multi-export-system.js"></script>
    <script src="backup-management-ui.js"></script>

    <!-- üì± Optimizaciones M√≥viles -->
    <script src="mobile-optimizations.js"></script>

    <!-- üöÄ Optimizaciones de Rendimiento -->
    <script src="performance-optimizer.js"></script>
    <script src="firebase-query-optimizer.js"></script>

    <!-- üß™ Sistema de Testing Avanzado -->
    <script src="testing-framework.js"></script>
    <script src="assertions.js"></script>
    <script src="test-runner.js"></script>
    <script src="test-ui.js"></script>
    <script src="app-tests.js"></script>
    <script src="run-tests.js"></script>

    <script>
        // üöÄ MEGA RADICAL: Usar Firebase v9 compat para m√°xima compatibilidad
        console.log('üî• Inicializando Firebase v9 compat...');

        // üîê CONFIGURACI√ìN SEGURA - Sistema h√≠brido para local y GitHub Pages
        let GEMINI_API_KEY, firebaseConfig, appId;

        // Funci√≥n para inicializar configuraci√≥n
        function initializeConfiguration() {
            // Verificar si existe configuraci√≥n externa
            if (window.APP_CONFIG) {
                // Configuraci√≥n cargada (local o GitHub Pages)
                ({ GEMINI_API_KEY, firebaseConfig, appId } = window.APP_CONFIG);

                if (window.APP_CONFIG.isPublicDeployment) {
                    console.log('üåê Configuraci√≥n cargada para GitHub Pages (despliegue p√∫blico) - v1.1');
                    console.log('üî• Firebase Config:', firebaseConfig);
                    console.log('üåç Dominio actual:', window.location.hostname);
                    console.log('üìç URL completa:', window.location.href);
                    // Mostrar banner informativo para GitHub Pages
                    showPublicDeploymentBanner();
                } else {
                    console.log('‚úÖ Configuraci√≥n cargada desde config.js (uso local)');
                }
                return true;
            } else {
                // Fallback si no se carga ninguna configuraci√≥n
                console.error('‚ùå No se pudo cargar ninguna configuraci√≥n');
                showConfigurationError();
                return false;
            }
        }

        // Funci√≥n para mostrar banner de despliegue p√∫blico
        function showPublicDeploymentBanner() {
            const banner = document.createElement('div');
            banner.className = 'fixed top-0 left-0 right-0 bg-blue-600 text-white text-center py-2 px-4 z-50 text-sm';
            banner.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                    <i data-lucide="info" class="w-4 h-4"></i>
                    <span>üåê Aplicaci√≥n desplegada p√∫blicamente - Funcionalidad completa disponible</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-blue-200 hover:text-white">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;
            document.body.appendChild(banner);

            // Ajustar el padding del body para el banner
            document.body.style.paddingTop = '40px';

            // Inicializar iconos
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);

            // Auto-ocultar despu√©s de 10 segundos
            setTimeout(() => {
                if (banner.parentElement) {
                    banner.remove();
                    document.body.style.paddingTop = '0';
                }
            }, 10000);
        }

        // Funci√≥n para mostrar error de configuraci√≥n
        function showConfigurationError() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl max-w-md mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="alert-circle" class="w-8 h-8 text-red-600 dark:text-red-400"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                            ‚ùå Error de Configuraci√≥n
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 mb-6">
                            No se pudo cargar la configuraci√≥n de la aplicaci√≥n.
                        </p>
                        <button onclick="location.reload()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Recargar P√°gina
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        }

        // Funci√≥n para mostrar modal de configuraci√≥n (legacy)
        function showConfigurationModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl max-w-md mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="settings" class="w-8 h-8 text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">
                            üîê Configuraci√≥n Requerida
                        </h3>
                        <div class="text-left text-sm text-gray-600 dark:text-gray-300 mb-6">
                            <p class="mb-3">Esta es una <strong>demostraci√≥n p√∫blica</strong> de la aplicaci√≥n.</p>
                            <p class="mb-3">Para usar todas las funcionalidades:</p>
                            <ol class="list-decimal list-inside space-y-1 mb-4">
                                <li>Clona el repositorio</li>
                                <li>Configura tus propias API keys</li>
                                <li>Ejecuta localmente</li>
                            </ol>
                            <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg">
                                <p class="text-xs">
                                    <strong>Repositorio:</strong><br>
                                    <a href="https://github.com/alvaretto/mis-finanzas-familiares"
                                       class="text-blue-600 dark:text-blue-400 hover:underline"
                                       target="_blank">
                                        github.com/alvaretto/mis-finanzas-familiares
                                    </a>
                                </p>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="this.closest('.fixed').remove()"
                                    class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                                Continuar Demo
                            </button>
                            <a href="https://github.com/alvaretto/mis-finanzas-familiares"
                               target="_blank"
                               class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-center">
                                Ver Repositorio
                            </a>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Inicializar iconos despu√©s de agregar el modal
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        }

        let app, auth, db, transactionsCollection, budgetDocRef, categoriesDocRef, assetsCollection, liabilitiesCollection, accountsPayableCollection, paymentHistoryCollection;
        let unsubscribeListener, unsubscribeBudgetListener, unsubscribeCategoriesListener, unsubscribeAssetsListener, unsubscribeLiabilitiesListener, unsubscribeAccountsPayableListener, unsubscribePaymentHistoryListener;
        let transactions = [], assets = [], liabilities = [], accountsPayable = [], paymentHistory = [], financeChart, currentEditingId = null, monthlyBudget = 0;
        let isLoginMode = true;
        let aiChatHistory = [], financialTips = [], currentTipIndex = 0;
        let userCategoryStructure = null; // Categor√≠as personalizadas del usuario

        // üß† Sistema de IA Avanzado - Desaf√≠o 1
        let aiMemorySystem = null;
        let aiLearningEngine = null;
        let proactiveInsightsEngine = null;
        let proactiveInsights = [];

        // üìä Dashboard Predictivo - Desaf√≠o 2
        let predictiveAnalyticsEngine = null;
        let predictiveDashboard = null;

        // üíæ Sistema de Backups Autom√°ticos
        let automaticBackupSystem = null;
        let multiExportSystem = null;
        let backupRestoreSystem = null;
        let backupManagementUI = null;

        // üß™ Sistema de Testing Avanzado
        let testingFramework = null;
        let testRunner = null;
        let testingUI = null;

        // üí≥ Sistema de Cuentas por Pagar
        let accountsPayableModal = null;
        let paymentModal = null;
        let accountsPayableCalendar = null;
        let currentEditingAccountId = null;

        // Sistema de categor√≠as con subcategor√≠as de dos niveles
        const categoryStructure = {
            income: {
                "Salario": {},
                "Inversiones": {},
                "Ventas": {},
                "Ganancias Ocasionales": {},
                "Otros Ingresos": {}
            },
            expense: {
                "Alimentaci√≥n": {
                    "SuperMercado": ["Frutas", "Verduras", "Hortalizas", "Legumbres", "Granos", "Especias", "L√°cteos", "C√°rnicos", "Mecato 1", "Otros"],
                    "Restaurantes": [],
                    "Domicilios": [],
                    "Batidos": [],
                    "OmniLife": [],
                    "Otros": []
                },
                "Transporte": {
                    "Gasolina": [],
                    "Transporte P√∫blico": [],
                    "Mantenimiento": [],
                    "Seguros Chana": [],
                    "Otros": []
                },
                "Entretenimiento": {
                    "Cine": [],
                    "Deporte": [],
                    "Viajes": [],
                    "Otros": []
                },
                "Salud": {
                    "Medicamentos": [],
                    "Consultas M√©dicas": [],
                    "Seguros": [],
                    "Otros": []
                },
                "Educaci√≥n": {
                    "Colegio": [],
                    "Cursos": [],
                    "Libros": [],
                    "Otros": []
                },
                "Aseo": {
                    "Casa": [],
                    "Familia": [],
                    "Otros": []
                },
                "Servicios P√∫blicos": {
                    "Electricidad": [],
                    "Agua": [],
                    "Gas": [],
                    "Internet": [],
                    "Tel√©fono": [],
                    "Televisi√≥n": [],
                    "Recolecci√≥n de Basura": [],
                    "Otros": []
                },
                "Suscripciones": {
                    "Streaming": ["Netflix", "Amazon Prime", "Disney+", "Spotify", "YouTube Premium"],
                    "Software": ["Office 365", "Adobe", "Antivirus", "Almacenamiento en la Nube"],
                    "Revistas y Peri√≥dicos": [],
                    "Gimnasio": [],
                    "Otros": []
                },
                "Seguros": {
                    "Vida": [],
                    "Salud": [],
                    "Veh√≠culo": [],
                    "Hogar": [],
                    "Otros": []
                },
                "Pr√©stamos y Cr√©ditos": {
                    "Hipoteca": [],
                    "Veh√≠culo": [],
                    "Personal": [],
                    "Tarjetas de Cr√©dito": [],
                    "Otros": []
                },
                "Otros Gastos": {
                    "Otros": []
                }
            },
            assets: {
                "Activos L√≠quidos": {
                    "Efectivo": ["Dinero en casa", "Billetera/Cartera", "Cajas de ahorro"],
                    "Cuentas Bancarias": ["Cuenta Corriente", "Cuenta de Ahorros", "Cuenta N√≥mina", "Cuentas en USD/Moneda Extranjera"],
                    "Inversiones L√≠quidas": ["CDT/Certificados", "Fondos de Inversi√≥n", "Acciones", "Bonos", "Criptomonedas"]
                },
                "Activos Fijos": {
                    "Bienes Ra√≠ces": ["Casa Principal", "Casa de Campo/Vacaciones", "Apartamentos de Inversi√≥n", "Lotes/Terrenos", "Locales Comerciales"],
                    "Veh√≠culos": ["Autom√≥viles", "Motocicletas", "Bicicletas", "Otros Veh√≠culos"],
                    "Muebles y Enseres": ["Electrodom√©sticos", "Muebles", "Equipos Electr√≥nicos", "Arte y Colecciones"]
                },
                "Activos de Inversi√≥n": {
                    "Negocios Propios": ["Participaciones Empresariales", "Franquicias", "Negocios Independientes"],
                    "Otros Activos": ["Joyas y Metales Preciosos", "Seguros de Vida (Valor de Rescate)", "Pr√©stamos por Cobrar", "Otros"]
                }
            },
            liabilities: {
                "Deudas Bancarias": {
                    "Hipotecas": ["Hipoteca Casa Principal", "Hipoteca Propiedades de Inversi√≥n", "Cr√©ditos Hipotecarios"],
                    "Pr√©stamos Personales": ["Pr√©stamos Bancarios", "Pr√©stamos de Libre Inversi√≥n", "Pr√©stamos de Veh√≠culo", "Pr√©stamos Estudiantiles"],
                    "L√≠neas de Cr√©dito": ["Sobregiros", "Cupos Rotativos", "L√≠neas de Cr√©dito Personal"]
                },
                "Deudas de Consumo": {
                    "Tarjetas de Cr√©dito": ["Visa", "MasterCard", "American Express", "Tarjetas de Tiendas"],
                    "Cr√©ditos Comerciales": ["Almacenes por Departamentos", "Concesionarios", "Electrodom√©sticos", "Otros Comercios"]
                },
                "Deudas Personales": {
                    "Familiares y Amigos": ["Pr√©stamos Familiares", "Pr√©stamos de Amigos", "Deudas Informales"],
                    "Otros Pasivos": ["Impuestos por Pagar", "Servicios P√∫blicos Pendientes", "Seguros por Pagar", "Otros"]
                }
            }
        };

        // Funciones auxiliares para manejar categor√≠as (din√°micas)
        const getCurrentCategoryStructure = () => userCategoryStructure || categoryStructure;
        const getCategoriesForType = (type) => Object.keys(getCurrentCategoryStructure()[type] || {});
        const getSubcategoriesForCategory = (type, category) => Object.keys(getCurrentCategoryStructure()[type]?.[category] || {});
        const getSubSubcategoriesForSubcategory = (type, category, subcategory) => getCurrentCategoryStructure()[type]?.[category]?.[subcategory] || [];

        // Mantener compatibilidad con el c√≥digo existente
        const getIncomeCategories = () => getCategoriesForType('income');
        const getExpenseCategories = () => getCategoriesForType('expense');

        // Sistema de campos espec√≠ficos por categor√≠a
        const specificFields = {
            // ALIMENTACI√ìN
            "expense.Alimentaci√≥n.SuperMercado": [
                {field: "fecha_compra", label: "Fecha de Compra", type: "date", required: true},
                {field: "articulo", label: "Art√≠culo", type: "text", required: true, placeholder: "Ej: Arroz Diana"},
                {field: "cantidad", label: "Cantidad", type: "number", required: true, step: "0.01"},
                {field: "unidad", label: "Unidad de Medida", type: "select", required: true,
                 options: ["gramos", "libras", "kilos", "unidades", "litros", "mililitros", "paquetes", "cajas"]},
                {field: "marca", label: "Marca", type: "text", required: false, placeholder: "Ej: Diana, Roa, etc."},
                {field: "lugar", label: "Supermercado", type: "text", required: true, placeholder: "Ej: √âxito, Carulla, D1"},
                {field: "precio_unitario", label: "Precio Unitario", type: "number", required: false, step: "0.01"},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ],
            "expense.Alimentaci√≥n.Restaurantes": [
                {field: "fecha_consumo", label: "Fecha", type: "date", required: true},
                {field: "restaurante", label: "Restaurante", type: "text", required: true},
                {field: "tipo_comida", label: "Tipo de Comida", type: "select", required: false,
                 options: ["Desayuno", "Almuerzo", "Cena", "Merienda", "Comida R√°pida", "Comida T√≠pica", "Internacional"]},
                {field: "num_personas", label: "N√∫mero de Personas", type: "number", required: false, min: "1"},
                {field: "propina", label: "Propina", type: "number", required: false, step: "0.01"},
                {field: "calificacion", label: "Calificaci√≥n", type: "select", required: false,
                 options: ["‚≠ê", "‚≠ê‚≠ê", "‚≠ê‚≠ê‚≠ê", "‚≠ê‚≠ê‚≠ê‚≠ê", "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê"]},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ],
            "expense.Alimentaci√≥n.Domicilios": [
                {field: "fecha_pedido", label: "Fecha del Pedido", type: "date", required: true},
                {field: "restaurante", label: "Restaurante", type: "text", required: true},
                {field: "plataforma", label: "Plataforma", type: "select", required: false,
                 options: ["Rappi", "Uber Eats", "Domicilios.com", "iFood", "Directo", "Otro"]},
                {field: "tipo_comida", label: "Tipo de Comida", type: "text", required: false},
                {field: "tiempo_entrega", label: "Tiempo de Entrega (min)", type: "number", required: false},
                {field: "propina", label: "Propina", type: "number", required: false, step: "0.01"},
                {field: "costo_domicilio", label: "Costo Domicilio", type: "number", required: false, step: "0.01"},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ],

            // TRANSPORTE
            "expense.Transporte.Gasolina": [
                {field: "fecha_tanqueo", label: "Fecha del Tanqueo", type: "date", required: true},
                {field: "estacion", label: "Estaci√≥n de Servicio", type: "text", required: true, placeholder: "Ej: Terpel, Mobil, Esso"},
                {field: "litros", label: "Litros", type: "number", required: true, step: "0.01"},
                {field: "precio_litro", label: "Precio por Litro", type: "number", required: false, step: "0.01"},
                {field: "kilometraje", label: "Kilometraje Actual", type: "number", required: false},
                {field: "vehiculo", label: "Veh√≠culo", type: "text", required: false, placeholder: "Ej: Carro, Moto"},
                {field: "tipo_combustible", label: "Tipo de Combustible", type: "select", required: false,
                 options: ["Corriente", "Extra", "Diesel", "Gas Natural"]},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ],
            "expense.Transporte.Transporte P√∫blico": [
                {field: "fecha_viaje", label: "Fecha del Viaje", type: "date", required: true},
                {field: "tipo_transporte", label: "Tipo de Transporte", type: "select", required: true,
                 options: ["Bus", "Metro", "Taxi", "Uber", "Cabify", "TransMilenio", "SITP", "Otro"]},
                {field: "origen", label: "Origen", type: "text", required: false},
                {field: "destino", label: "Destino", type: "text", required: false},
                {field: "ruta", label: "Ruta/L√≠nea", type: "text", required: false},
                {field: "duracion", label: "Duraci√≥n (min)", type: "number", required: false},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ],

            // SALUD
            "expense.Salud.Medicamentos": [
                {field: "fecha_compra", label: "Fecha de Compra", type: "date", required: true},
                {field: "medicamento", label: "Nombre del Medicamento", type: "text", required: true},
                {field: "dosis", label: "Dosis", type: "text", required: false, placeholder: "Ej: 500mg, 1 tableta"},
                {field: "cantidad", label: "Cantidad", type: "number", required: true},
                {field: "farmacia", label: "Farmacia", type: "text", required: false, placeholder: "Ej: Cruz Verde, Copidrogas"},
                {field: "receta_medica", label: "¬øCon Receta M√©dica?", type: "select", required: false,
                 options: ["S√≠", "No"]},
                {field: "fecha_vencimiento", label: "Fecha de Vencimiento", type: "date", required: false},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ],
            "expense.Salud.Consultas M√©dicas": [
                {field: "fecha_consulta", label: "Fecha de la Consulta", type: "date", required: true},
                {field: "doctor", label: "Doctor/Especialista", type: "text", required: true},
                {field: "especialidad", label: "Especialidad", type: "text", required: false},
                {field: "tipo_consulta", label: "Tipo de Consulta", type: "select", required: false,
                 options: ["Consulta General", "Especialista", "Control", "Urgencias", "Ex√°menes", "Procedimiento"]},
                {field: "diagnostico", label: "Diagn√≥stico/Motivo", type: "textarea", required: false},
                {field: "proxima_cita", label: "Pr√≥xima Cita", type: "date", required: false},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ],

            // ENTRETENIMIENTO
            "expense.Entretenimiento.Cine": [
                {field: "fecha_funcion", label: "Fecha de la Funci√≥n", type: "date", required: true},
                {field: "pelicula", label: "Pel√≠cula", type: "text", required: true},
                {field: "cine", label: "Cine", type: "text", required: true, placeholder: "Ej: Cinemark, Cine Colombia"},
                {field: "horario", label: "Horario", type: "time", required: false},
                {field: "num_boletos", label: "N√∫mero de Boletos", type: "number", required: true, min: "1"},
                {field: "tipo_funcion", label: "Tipo de Funci√≥n", type: "select", required: false,
                 options: ["2D", "3D", "4D", "IMAX", "VIP", "Normal"]},
                {field: "sala", label: "Sala", type: "text", required: false},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ],
            "expense.Entretenimiento.Deporte": [
                {field: "fecha_actividad", label: "Fecha de la Actividad", type: "date", required: true},
                {field: "actividad", label: "Actividad Deportiva", type: "text", required: true},
                {field: "lugar", label: "Lugar", type: "text", required: true},
                {field: "duracion", label: "Duraci√≥n (min)", type: "number", required: false},
                {field: "instructor", label: "Instructor/Entrenador", type: "text", required: false},
                {field: "nivel", label: "Nivel", type: "select", required: false,
                 options: ["Principiante", "Intermedio", "Avanzado", "Profesional"]},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ],

            // EDUCACI√ìN
            "expense.Educaci√≥n.Libros": [
                {field: "fecha_compra", label: "Fecha de Compra", type: "date", required: true},
                {field: "titulo", label: "T√≠tulo del Libro", type: "text", required: true},
                {field: "autor", label: "Autor", type: "text", required: false},
                {field: "editorial", label: "Editorial", type: "text", required: false},
                {field: "isbn", label: "ISBN", type: "text", required: false},
                {field: "materia", label: "Materia/Curso", type: "text", required: false},
                {field: "tipo", label: "Tipo", type: "select", required: false,
                 options: ["F√≠sico", "Digital", "Usado", "Nuevo"]},
                {field: "observaciones", label: "Observaciones", type: "textarea", required: false}
            ]
        };

        // Funci√≥n para obtener campos espec√≠ficos
        const getSpecificFields = (type, category, subcategory) => {
            const key = `${type}.${category}.${subcategory}`;
            return specificFields[key] || [];
        };

        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authToggleBtn = document.getElementById('auth-toggle-btn');
        const authToggleText = document.getElementById('auth-toggle-text');
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailEl = document.getElementById('user-email');
        const themeToggle = document.getElementById('theme-toggle');
        const balanceEl = document.getElementById('balance');
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const transactionListEl = document.getElementById('transaction-list');
        const addTransactionBtn = document.getElementById('add-transaction-btn');
        const transactionModalEl = document.getElementById('transaction-modal');
        const budgetModalEl = document.getElementById('budget-modal');
        const aiChatModalEl = document.getElementById('ai-chat-modal');
        const tipsModalEl = document.getElementById('tips-modal');
        const chartCanvas = document.getElementById('finance-chart');
        const chartEmptyState = document.getElementById('chart-empty-state');
        const budgetSpentEl = document.getElementById('budget-spent');
        const budgetTotalEl = document.getElementById('budget-total');
        const budgetProgressEl = document.getElementById('budget-progress');
        const editBudgetBtn = document.getElementById('edit-budget-btn');
        const aiAssistantBtn = document.getElementById('ai-assistant-btn');
        const tipsBtn = document.getElementById('tips-btn');
        const proactiveInsightsBtn = document.getElementById('proactive-insights-btn');
        const insightsBadge = document.getElementById('insights-badge');
        const predictiveDashboardBtn = document.getElementById('predictive-dashboard-btn');
        const backupManagementBtn = document.getElementById('backup-management-btn');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const manageCategoriesBtn = document.getElementById('manage-categories-btn');
        const categoriesModalEl = document.getElementById('categories-modal');
        const manageAssetsBtn = document.getElementById('manage-assets-btn');
        const manageLiabilitiesBtn = document.getElementById('manage-liabilities-btn');
        const manageAccountsPayableBtn = document.getElementById('manage-accounts-payable-btn');
        const assetsModalEl = document.getElementById('assets-modal');
        const assetFormModalEl = document.getElementById('asset-form-modal');
        const liabilitiesModalEl = document.getElementById('liabilities-modal');
        const liabilityFormModalEl = document.getElementById('liability-form-modal');
        const accountsPayableModalEl = document.getElementById('accounts-payable-modal');
        const accountPayableFormModalEl = document.getElementById('account-payable-form-modal');
        const paymentModalEl = document.getElementById('payment-modal');
        const accountsPayableCalendarModalEl = document.getElementById('accounts-payable-calendar-modal');
        const totalAssetsEl = document.getElementById('total-assets');
        const totalLiabilitiesEl = document.getElementById('total-liabilities');
        const netWorthEl = document.getElementById('net-worth');
        const debtRatioEl = document.getElementById('debt-ratio');
        const financialHealthTextEl = document.getElementById('financial-health-text');
        const financialHealthBarEl = document.getElementById('financial-health-bar');

        // üí∞ Funci√≥n global de formateo de moneda - Pesos Colombianos
        const formatCurrency = (amount) => {
            const formatted = new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
            // Asegurar que incluya COP expl√≠citamente para los tests
            return formatted.replace('$', 'COP $');
        };

        // Hacer disponible globalmente
        window.formatCurrency = formatCurrency;

        // üîî Funciones de notificaci√≥n globales
        const showSuccessMessage = (message) => {
            showNotification(message, 'success');
        };

        const showErrorMessage = (message) => {
            showNotification(message, 'error');
        };

        const showNotification = (message, type = 'info') => {
            const notification = document.createElement('div');
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600',
                info: 'bg-blue-600'
            };
            const icons = {
                success: 'check-circle',
                error: 'x-circle',
                warning: 'alert-triangle',
                info: 'info'
            };

            notification.className = `fixed top-4 right-4 ${colors[type]} text-white p-3 rounded-lg shadow-lg z-50 max-w-sm transform transition-all duration-300 translate-x-full`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i data-lucide="${icons[type]}" class="w-4 h-4 flex-shrink-0"></i>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:bg-black hover:bg-opacity-20 rounded p-1 flex-shrink-0">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            // Inicializar iconos
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Animaci√≥n de entrada
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Auto-remover despu√©s de 5 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 5000);
        };

        // Hacer disponibles globalmente
        window.showSuccessMessage = showSuccessMessage;
        window.showErrorMessage = showErrorMessage;
        window.showNotification = showNotification;

        // üí≥ Funciones de utilidad para Cuentas por Pagar
        const recurrenceTypes = {
            'once': 'Una vez',
            'monthly': 'Mensual',
            'bimonthly': 'Bimestral',
            'quarterly': 'Trimestral',
            'semiannual': 'Semestral',
            'annual': 'Anual',
            'custom': 'Personalizado'
        };

        const paymentStatuses = {
            'pending': { label: 'Pendiente', color: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300' },
            'paid': { label: 'Pagado', color: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' },
            'overdue': { label: 'Vencido', color: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' },
            'cancelled': { label: 'Cancelado', color: 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300' }
        };

        // Funci√≥n para calcular la pr√≥xima fecha de vencimiento
        const calculateNextDueDate = (lastDueDate, recurrenceType, customDays = null) => {
            if (recurrenceType === 'once') return null;

            const date = new Date(lastDueDate);

            switch(recurrenceType) {
                case 'monthly':
                    date.setMonth(date.getMonth() + 1);
                    break;
                case 'bimonthly':
                    date.setMonth(date.getMonth() + 2);
                    break;
                case 'quarterly':
                    date.setMonth(date.getMonth() + 3);
                    break;
                case 'semiannual':
                    date.setMonth(date.getMonth() + 6);
                    break;
                case 'annual':
                    date.setFullYear(date.getFullYear() + 1);
                    break;
                case 'custom':
                    if (customDays) {
                        date.setDate(date.getDate() + customDays);
                    }
                    break;
            }

            return date.toISOString().split('T')[0];
        };

        // Funci√≥n para determinar el estado de una cuenta por pagar
        const getAccountPayableStatus = (account) => {
            if (!account.isActive) return 'cancelled';
            if (account.lastPaidDate && account.lastPaidDate === account.nextDueDate) return 'paid';

            const today = new Date().toISOString().split('T')[0];
            const dueDate = account.nextDueDate;

            if (dueDate < today) return 'overdue';
            return 'pending';
        };

        // Funci√≥n para obtener cuentas que requieren alerta
        const getAccountsRequiringAlert = (accounts) => {
            const today = new Date();
            const alertAccounts = [];

            accounts.forEach(account => {
                if (!account.isActive) return;

                const dueDate = new Date(account.nextDueDate);
                const daysDifference = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                // Alertas antes del vencimiento
                if (daysDifference <= account.alertDaysBefore && daysDifference >= 0) {
                    alertAccounts.push({
                        ...account,
                        alertType: 'upcoming',
                        daysUntilDue: daysDifference
                    });
                }

                // Alertas de vencimiento
                if (daysDifference < 0) {
                    alertAccounts.push({
                        ...account,
                        alertType: 'overdue',
                        daysOverdue: Math.abs(daysDifference)
                    });
                }
            });

            return alertAccounts;
        };

        // Funci√≥n para formatear fechas
        const formatDate = (dateString) => {
            if (!dateString) return 'No definida';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        };

        // Hacer disponibles globalmente
        window.calculateNextDueDate = calculateNextDueDate;
        window.getAccountPayableStatus = getAccountPayableStatus;
        window.getAccountsRequiringAlert = getAccountsRequiringAlert;
        window.formatDate = formatDate;

        const applyTheme = (isDark) => {
            document.documentElement.classList.toggle('dark', isDark);
            if (financeChart) {
                updateChart();
            }
        };

        const toggleTheme = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            applyTheme(isDark);
        };

        const toggleAuthMode = () => {
            isLoginMode = !isLoginMode;
            authTitle.textContent = isLoginMode ? 'Iniciar Sesi√≥n' : 'Crear Cuenta';
            authSubmitBtn.textContent = isLoginMode ? 'Acceder' : 'Registrarse';
            authToggleText.textContent = isLoginMode ? '¬øNo tienes una cuenta?' : '¬øYa tienes una cuenta?';
            authToggleBtn.textContent = isLoginMode ? 'Reg√≠strate' : 'Inicia Sesi√≥n';
            forgotPasswordBtn.style.display = isLoginMode ? 'block' : 'none';
            authError.textContent = '';
            authForm.reset();
        };

        const handleAuthFormSubmit = async (e) => {
            e.preventDefault();
            const email = authForm.email.value;
            const password = authForm.password.value;
            authError.textContent = '';
            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                }
            } catch (error) {
                console.error('Error de autenticaci√≥n:', error);
                console.error('C√≥digo de error:', error.code);
                console.error('Mensaje de error:', error.message);

                let errorMessage = 'Error: ';
                switch (error.code) {
                    case 'auth/invalid-credential':
                        errorMessage += 'Credenciales incorrectas.';
                        break;
                    case 'auth/user-not-found':
                        errorMessage += 'Usuario no encontrado.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage += 'Contrase√±a incorrecta.';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage += 'El email ya est√° en uso.';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'La contrase√±a es muy d√©bil.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Email inv√°lido.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage += 'Error de conexi√≥n. Verifica tu internet.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += 'Demasiados intentos. Espera un momento.';
                        break;
                    default:
                        errorMessage += `${error.code}: ${error.message}`;
                        break;
                }

                authError.textContent = errorMessage;
            }
        };
        
        const handlePasswordReset = async () => {
            const email = authForm.email.value;
            if (!email) {
                authError.textContent = 'Por favor, introduce tu email para restablecer la contrase√±a.';
                return;
            }
            try {
                await auth.sendPasswordResetEmail(email);
                authError.textContent = 'Correo de restablecimiento enviado. Revisa tu bandeja de entrada.';
            } catch (error) {
                authError.textContent = 'Error al enviar el correo. Verifica la direcci√≥n.';
            }
        };

        const handleLogout = async () => {
            if (unsubscribeListener) unsubscribeListener();
            if (unsubscribeBudgetListener) unsubscribeBudgetListener();
            if (unsubscribeCategoriesListener) unsubscribeCategoriesListener();
            if (unsubscribeAssetsListener) unsubscribeAssetsListener();
            if (unsubscribeLiabilitiesListener) unsubscribeLiabilitiesListener();
            await auth.signOut();
        };

        const showApp = async (user) => {
            authScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            userEmailEl.textContent = user.email;
            setupRealtimeListeners();

            // üß† Inicializar Sistema de IA Avanzado
            await initializeAdvancedAI(user.uid);

            lucide.createIcons();
        };

        const showAuth = () => {
            authScreen.classList.remove('hidden');
            appScreen.classList.add('hidden');
            if (unsubscribeListener) unsubscribeListener();
            if (unsubscribeBudgetListener) unsubscribeBudgetListener();
            if (unsubscribeCategoriesListener) unsubscribeCategoriesListener();
            if (unsubscribeAssetsListener) unsubscribeAssetsListener();
            if (unsubscribeLiabilitiesListener) unsubscribeLiabilitiesListener();
            if (unsubscribeAccountsPayableListener) unsubscribeAccountsPayableListener();
            if (unsubscribePaymentHistoryListener) unsubscribePaymentHistoryListener();
            transactionsCollection = null;
            userCategoryStructure = null;
            assets = [];
            liabilities = [];
            accountsPayable = [];
            paymentHistory = [];

            // üß† Limpiar sistema de IA
            aiMemorySystem = null;
            aiLearningEngine = null;
            proactiveInsights = [];
        };

        // üìã Funci√≥n para obtener transacciones (necesaria para IA)
        const getTransactions = () => {
            return transactions || [];
        };

        // üß† Inicializar Sistema de IA Avanzado - Desaf√≠o 1
        const initializeAdvancedAI = async (userId) => {
            try {
                console.log('üß† Inicializando Sistema de IA Avanzado...');

                // Crear instancia del sistema de memoria
                aiMemorySystem = new AIMemorySystem();
                await aiMemorySystem.initialize(userId);

                // Crear motor de aprendizaje
                aiLearningEngine = new AILearningEngine(aiMemorySystem);

                // Crear motor de insights proactivos
                proactiveInsightsEngine = new ProactiveInsightsEngine(aiMemorySystem, aiLearningEngine);
                await proactiveInsightsEngine.initialize(userId);

                // Cargar insights proactivos
                proactiveInsights = await aiLearningEngine.loadProactiveInsights();

                // Generar nuevos insights si es necesario
                if (proactiveInsights.length === 0) {
                    proactiveInsights = await aiLearningEngine.generateProactiveAdvice();
                }

                // üìä Inicializar Dashboard Predictivo
                predictiveAnalyticsEngine = new PredictiveAnalyticsEngine();
                predictiveDashboard = new PredictiveDashboard();

                // Integrar insights del dashboard predictivo
                const transactions = getTransactions();
                if (transactions.length > 0) {
                    await predictiveAnalyticsEngine.initialize(transactions);
                    const dashboardInsights = predictiveAnalyticsEngine.generateInsightsForDashboard();
                    proactiveInsights.push(...dashboardInsights);
                    console.log('üìä Dashboard predictivo integrado con', dashboardInsights.length, 'insights adicionales');
                }

                // üíæ Inicializar Sistema de Backups Autom√°ticos
                try {
                    console.log('üíæ Inicializando sistema de backups autom√°ticos...');
                    automaticBackupSystem = new AutomaticBackupSystem();
                    const backupInitialized = await automaticBackupSystem.initialize();

                    if (backupInitialized) {
                        multiExportSystem = new MultiExportSystem();
                        backupRestoreSystem = new BackupRestoreSystem();
                        backupManagementUI = new BackupManagementUI();

                        await backupManagementUI.initialize(
                            automaticBackupSystem,
                            multiExportSystem,
                            backupRestoreSystem
                        );

                        console.log('‚úÖ Sistema de backups inicializado correctamente');
                    } else {
                        console.warn('‚ö†Ô∏è Sistema de backups no se pudo inicializar completamente');
                    }
                } catch (backupError) {
                    console.error('‚ùå Error inicializando sistema de backups:', backupError);
                    // No lanzar error para no interrumpir la inicializaci√≥n de otros sistemas
                }

                // Nota: Sistema de testing se inicializa independientemente m√°s abajo

                console.log('‚úÖ Sistema de IA Avanzado inicializado correctamente');
                console.log('üíæ Sistema de Backups Autom√°ticos inicializado correctamente');
                console.log(`üìä Estad√≠sticas de memoria:`, aiMemorySystem.getMemoryStats());

                // Mostrar insights proactivos si los hay
                if (proactiveInsights.length > 0) {
                    showProactiveInsights();
                }

            } catch (error) {
                console.error('‚ùå Error inicializando Sistema de IA Avanzado:', error);
                // Fallback al sistema b√°sico
                console.log('üîÑ Usando sistema de IA b√°sico como fallback');
            }
        };

        const setupRealtimeListeners = () => {
            if (!db) return;
            const basePath = `artifacts/${appId}/shared_transactions/family_data`;
            transactionsCollection = firebase.firestore().collection(`${basePath}/transactions`);
            budgetDocRef = firebase.firestore().doc(`${basePath}/budget/monthly`);
            categoriesDocRef = firebase.firestore().doc(`${basePath}/categories/structure`);
            assetsCollection = firebase.firestore().collection(`${basePath}/assets`);
            liabilitiesCollection = firebase.firestore().collection(`${basePath}/liabilities`);
            accountsPayableCollection = firebase.firestore().collection(`${basePath}/accounts_payable`);
            paymentHistoryCollection = firebase.firestore().collection(`${basePath}/payment_history`);

            unsubscribeListener = transactionsCollection.onSnapshot((snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllUI();
            });

            unsubscribeBudgetListener = budgetDocRef.onSnapshot((doc) => {
                monthlyBudget = doc.exists ? doc.data().amount : 0;
                updateAllUI();
            });

            unsubscribeCategoriesListener = categoriesDocRef.onSnapshot((doc) => {
                userCategoryStructure = doc.exists ? doc.data() : null;
                if (!categoriesModalEl.classList.contains('hidden')) {
                    renderCategoriesModal();
                }
            });

            unsubscribeAssetsListener = assetsCollection.onSnapshot((snapshot) => {
                assets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllUI();
            });

            unsubscribeLiabilitiesListener = liabilitiesCollection.onSnapshot((snapshot) => {
                liabilities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllUI();
            });

            unsubscribeAccountsPayableListener = accountsPayableCollection.onSnapshot((snapshot) => {
                accountsPayable = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAllUI();
                checkAccountsPayableAlerts();
            });

            unsubscribePaymentHistoryListener = paymentHistoryCollection.onSnapshot((snapshot) => {
                paymentHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        };

        const loadLiabilities = async () => {
            if (!liabilitiesCollection) return;
            try {
                const snapshot = await liabilitiesCollection.get();
                liabilities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) {
                console.error('Error loading liabilities:', error);
            }
        };

        // üí≥ Funciones CRUD para Cuentas por Pagar
        const loadAccountsPayable = async () => {
            if (!accountsPayableCollection) return;
            try {
                const snapshot = await accountsPayableCollection.get();
                accountsPayable = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateAccountsPayableStatuses();
            } catch (error) {
                console.error('Error loading accounts payable:', error);
            }
        };

        const createAccountPayable = async (accountData) => {
            if (!accountsPayableCollection) throw new Error('Collection not initialized');

            try {
                const currentUser = auth.currentUser;
                if (!currentUser) throw new Error('User not authenticated');

                const newAccount = {
                    ...accountData,
                    status: 'pending',
                    isActive: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: currentUser.uid
                };

                const docRef = await accountsPayableCollection.add(newAccount);
                showSuccessMessage('Cuenta por pagar creada exitosamente');
                return docRef.id;
            } catch (error) {
                console.error('Error creating account payable:', error);
                showErrorMessage('Error al crear la cuenta por pagar');
                throw error;
            }
        };

        const updateAccountPayable = async (accountId, updateData) => {
            if (!accountsPayableCollection) throw new Error('Collection not initialized');

            try {
                const updatedData = {
                    ...updateData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                await accountsPayableCollection.doc(accountId).update(updatedData);
                showSuccessMessage('Cuenta por pagar actualizada exitosamente');
            } catch (error) {
                console.error('Error updating account payable:', error);
                showErrorMessage('Error al actualizar la cuenta por pagar');
                throw error;
            }
        };

        const deleteAccountPayable = async (accountId) => {
            if (!accountsPayableCollection) throw new Error('Collection not initialized');

            try {
                await accountsPayableCollection.doc(accountId).delete();
                showSuccessMessage('Cuenta por pagar eliminada exitosamente');
            } catch (error) {
                console.error('Error deleting account payable:', error);
                showErrorMessage('Error al eliminar la cuenta por pagar');
                throw error;
            }
        };

        const updateAccountsPayableStatuses = () => {
            accountsPayable.forEach(async (account) => {
                const currentStatus = getAccountPayableStatus(account);
                if (currentStatus !== account.status) {
                    try {
                        await updateAccountPayable(account.id, { status: currentStatus });
                    } catch (error) {
                        console.error('Error updating account status:', error);
                    }
                }
            });
        };

        const checkAccountsPayableAlerts = () => {
            const alertAccounts = getAccountsRequiringAlert(accountsPayable);
            if (alertAccounts.length > 0) {
                showAccountsPayableAlerts(alertAccounts);
            }
        };

        const showAccountsPayableAlerts = (alertAccounts) => {
            alertAccounts.forEach(account => {
                let message = '';
                if (account.alertType === 'upcoming') {
                    message = `${account.name} vence en ${account.daysUntilDue} d√≠a${account.daysUntilDue !== 1 ? 's' : ''}`;
                } else if (account.alertType === 'overdue') {
                    message = `${account.name} est√° vencida desde hace ${account.daysOverdue} d√≠a${account.daysOverdue !== 1 ? 's' : ''}`;
                }

                if (message) {
                    showNotification(message, account.alertType === 'overdue' ? 'error' : 'warning');
                }
            });
        };

        // üîÑ Sistema de Recurrencia para Cuentas por Pagar
        const processRecurringAccounts = async () => {
            const today = new Date().toISOString().split('T')[0];

            for (const account of accountsPayable) {
                if (!account.isActive || account.recurrenceType === 'once') continue;

                // Verificar si necesita generar nueva fecha de vencimiento
                if (account.status === 'paid' && account.lastPaidDate === account.nextDueDate) {
                    const nextDueDate = calculateNextDueDate(
                        account.nextDueDate,
                        account.recurrenceType,
                        account.customRecurrenceDays
                    );

                    if (nextDueDate) {
                        try {
                            await updateAccountPayable(account.id, {
                                nextDueDate: nextDueDate,
                                status: 'pending'
                            });
                        } catch (error) {
                            console.error('Error updating recurring account:', error);
                        }
                    }
                }
            }
        };

        const markAccountAsPaid = async (accountId, paymentData = {}) => {
            try {
                const account = accountsPayable.find(a => a.id === accountId);
                if (!account) throw new Error('Account not found');

                const currentUser = auth.currentUser;
                if (!currentUser) throw new Error('User not authenticated');

                const today = new Date().toISOString().split('T')[0];

                // Actualizar cuenta como pagada
                await updateAccountPayable(accountId, {
                    status: 'paid',
                    lastPaidDate: today
                });

                // Registrar en historial de pagos
                const paymentRecord = {
                    accountPayableId: accountId,
                    amount: paymentData.amount || account.amount,
                    paidDate: today,
                    dueDate: account.nextDueDate,
                    status: 'paid',
                    paymentMethod: paymentData.paymentMethod || account.paymentMethod,
                    notes: paymentData.notes || '',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: currentUser.uid
                };

                await paymentHistoryCollection.add(paymentRecord);

                // Crear transacci√≥n autom√°ticamente si se solicita
                if (paymentData.createTransaction) {
                    const transactionData = {
                        date: today,
                        description: `Pago: ${account.name}`,
                        amount: paymentData.amount || account.amount,
                        type: 'expense',
                        category: account.category,
                        subcategory: account.subcategory || '',
                        paymentMethod: paymentData.paymentMethod || account.paymentMethod,
                        notes: `Pago autom√°tico de cuenta por pagar: ${account.name}`,
                        accountPayableId: accountId
                    };

                    await transactionsCollection.add({
                        ...transactionData,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                // Procesar recurrencia si aplica
                if (account.recurrenceType !== 'once') {
                    const nextDueDate = calculateNextDueDate(
                        account.nextDueDate,
                        account.recurrenceType,
                        account.customRecurrenceDays
                    );

                    if (nextDueDate) {
                        await updateAccountPayable(accountId, {
                            nextDueDate: nextDueDate,
                            status: 'pending'
                        });
                    }
                }

                showSuccessMessage('Pago registrado exitosamente');
            } catch (error) {
                console.error('Error marking account as paid:', error);
                showErrorMessage('Error al registrar el pago');
                throw error;
            }
        };

        const getUpcomingPayments = (days = 7) => {
            const today = new Date();
            const futureDate = new Date();
            futureDate.setDate(today.getDate() + days);

            return accountsPayable.filter(account => {
                if (!account.isActive || account.status === 'paid') return false;

                const dueDate = new Date(account.nextDueDate);
                return dueDate >= today && dueDate <= futureDate;
            }).sort((a, b) => new Date(a.nextDueDate) - new Date(b.nextDueDate));
        };

        const getOverduePayments = () => {
            const today = new Date().toISOString().split('T')[0];

            return accountsPayable.filter(account => {
                return account.isActive &&
                       account.status === 'overdue' &&
                       account.nextDueDate < today;
            }).sort((a, b) => new Date(a.nextDueDate) - new Date(b.nextDueDate));
        };

        const getMonthlyPaymentProjection = (month, year) => {
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0);

            let totalProjected = 0;
            const paymentsInMonth = [];

            accountsPayable.forEach(account => {
                if (!account.isActive) return;

                let currentDate = new Date(account.nextDueDate);

                // Proyectar pagos recurrentes dentro del mes
                while (currentDate <= endDate) {
                    if (currentDate >= startDate && currentDate <= endDate) {
                        paymentsInMonth.push({
                            ...account,
                            projectedDate: currentDate.toISOString().split('T')[0]
                        });
                        totalProjected += account.amount;
                    }

                    if (account.recurrenceType === 'once') break;

                    const nextDate = calculateNextDueDate(
                        currentDate.toISOString().split('T')[0],
                        account.recurrenceType,
                        account.customRecurrenceDays
                    );

                    if (!nextDate) break;
                    currentDate = new Date(nextDate);
                }
            });

            return {
                totalProjected,
                payments: paymentsInMonth.sort((a, b) =>
                    new Date(a.projectedDate) - new Date(b.projectedDate)
                )
            };
        };

        const renderSummary = () => {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = totalIncome - totalExpense;
            balanceEl.textContent = formatCurrency(balance);
            totalIncomeEl.textContent = formatCurrency(totalIncome);
            totalExpenseEl.textContent = formatCurrency(totalExpense);
            balanceEl.classList.toggle('text-red-500', balance < 0);
            balanceEl.classList.toggle('text-green-500', balance >= 0);
        };

        const renderBudget = () => {
            const totalExpense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            budgetSpentEl.textContent = formatCurrency(totalExpense);
            budgetTotalEl.textContent = formatCurrency(monthlyBudget);
            let percentage = 0;
            if (monthlyBudget > 0) percentage = Math.min((totalExpense / monthlyBudget) * 100, 100);
            budgetProgressEl.style.width = `${percentage}%`;
            budgetProgressEl.className = 'h-4 rounded-full transition-all duration-500 ';
            if (percentage < 75) budgetProgressEl.classList.add('bg-green-500');
            else if (percentage < 90) budgetProgressEl.classList.add('bg-yellow-500');
            else budgetProgressEl.classList.add('bg-red-500');
        };

        const renderTransactions = () => {
            transactionListEl.innerHTML = '';
            if (transactions.length === 0) {
                transactionListEl.innerHTML = `<p class="text-center text-slate-500 dark:text-slate-400 py-4">No hay transacciones todav√≠a.</p>`;
                return;
            }
            [...transactions].sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate()).forEach(t => {
                const isIncome = t.type === 'income';

                // Construir la cadena de categor√≠as
                let categoryDisplay = t.category;
                if (t.subcategory) {
                    categoryDisplay += ` ‚Ä∫ ${t.subcategory}`;
                    if (t.subsubcategory) {
                        categoryDisplay += ` ‚Ä∫ ${t.subsubcategory}`;
                    }
                }

                const li = document.createElement('div');
                li.className = 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md flex items-center justify-between';
                li.innerHTML = `
                    <div class="flex items-center overflow-hidden mr-2">
                        <div class="p-2 rounded-full mr-4 flex-shrink-0 ${isIncome ? 'bg-green-100 dark:bg-green-900/50' : 'bg-red-100 dark:bg-red-900/50'}">
                            <i data-lucide="${isIncome ? 'arrow-down-circle' : 'arrow-up-circle'}" class="${isIncome ? 'text-green-500' : 'text-red-500'}"></i>
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="font-semibold truncate">${t.description}</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400">
                                ${t.date ? new Date(t.date).toLocaleDateString('es-ES') : t.createdAt?.toDate().toLocaleDateString('es-ES')}
                            </p>
                            ${t.subcategory || t.subsubcategory ? `<p class="text-xs text-slate-400 dark:text-slate-500 truncate mt-1" title="${categoryDisplay}">${categoryDisplay}</p>` : ''}
                            ${t.specificDetails ? renderSpecificDetailsPreview(t.specificDetails) : ''}
                        </div>
                    </div>
                    <div class="text-right flex items-center gap-2 flex-shrink-0">
                        <div>
                            <p class="font-semibold ${isIncome ? 'text-green-500' : 'text-red-500'}">${isIncome ? '+' : '-'}${formatCurrency(t.amount)}</p>
                            <span class="text-xs px-2 py-1 bg-slate-200 dark:bg-gray-700 rounded-full" title="${categoryDisplay}">${t.category}</span>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button class="edit-btn text-slate-400 hover:text-indigo-500" data-id="${t.id}">
                                <i data-lucide="edit-3" class="w-4 h-4"></i>
                            </button>
                            <button class="delete-btn text-slate-400 hover:text-red-500" data-id="${t.id}">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>`;
                transactionListEl.appendChild(li);
            });
            lucide.createIcons();
        };

        const renderSpecificDetailsPreview = (specificDetails) => {
            if (!specificDetails || Object.keys(specificDetails).length === 0) return '';

            // Mostrar solo los campos m√°s relevantes en el preview
            const priorityFields = ['articulo', 'medicamento', 'pelicula', 'actividad', 'restaurante', 'estacion', 'titulo'];
            const relevantFields = [];

            // Buscar campos prioritarios primero
            priorityFields.forEach(field => {
                if (specificDetails[field]) {
                    relevantFields.push(`${specificDetails[field]}`);
                }
            });

            // Si no hay campos prioritarios, mostrar los primeros 2 campos disponibles
            if (relevantFields.length === 0) {
                const fields = Object.entries(specificDetails).slice(0, 2);
                fields.forEach(([key, value]) => {
                    if (value && typeof value === 'string' && value.length < 30) {
                        relevantFields.push(value);
                    }
                });
            }

            if (relevantFields.length === 0) return '';

            const preview = relevantFields.slice(0, 2).join(' ‚Ä¢ ');
            return `<p class="text-xs text-blue-600 dark:text-blue-400 truncate mt-1" title="Detalles espec√≠ficos">${preview}</p>`;
        };

        const updateChart = () => {
            if (financeChart) {
                financeChart.destroy();
            }
            const expenses = transactions.filter(t => t.type === 'expense');
            const hasExpenses = expenses.length > 0;
            chartCanvas.classList.toggle('hidden', !hasExpenses);
            chartEmptyState.classList.toggle('hidden', hasExpenses);
            if (!hasExpenses) return;

            const categoryTotals = expenses.reduce((acc, {category, amount}) => { acc[category] = (acc[category] || 0) + amount; return acc; }, {});
            const data = { 
                labels: Object.keys(categoryTotals), 
                datasets: [{ 
                    data: Object.values(categoryTotals), 
                    backgroundColor: Object.keys(categoryTotals).map((_, i) => `hsla(${(i * 360 / Object.keys(categoryTotals).length) % 360}, 70%, 60%, 0.7)`), 
                    borderWidth: 2,
                    borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#fff'
                }] 
            };
            
            financeChart = new Chart(chartCanvas.getContext('2d'), { 
                type: 'doughnut', 
                data, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false } 
                    } 
                } 
            });
        };

        const renderPatrimony = () => {
            const totalAssets = assets.reduce((sum, asset) => sum + (asset.currentValue || 0), 0);
            const totalLiabilities = liabilities.reduce((sum, liability) => sum + (liability.currentBalance || 0), 0);
            const netWorth = totalAssets - totalLiabilities;
            const debtRatio = totalAssets > 0 ? (totalLiabilities / totalAssets) * 100 : 0;

            totalAssetsEl.textContent = formatCurrency(totalAssets);
            totalLiabilitiesEl.textContent = formatCurrency(totalLiabilities);
            netWorthEl.textContent = formatCurrency(netWorth);
            debtRatioEl.textContent = `${debtRatio.toFixed(1)}%`;

            // Actualizar colores seg√∫n el patrimonio neto
            netWorthEl.className = `text-xl font-semibold ${netWorth >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`;

            // Calcular salud financiera
            let healthScore = 0;
            let healthText = '';
            let healthColor = '';

            if (debtRatio <= 30) {
                healthScore = 100 - debtRatio;
                healthText = 'Excelente';
                healthColor = 'bg-green-500';
            } else if (debtRatio <= 50) {
                healthScore = 70 - (debtRatio - 30);
                healthText = 'Buena';
                healthColor = 'bg-yellow-500';
            } else if (debtRatio <= 70) {
                healthScore = 50 - (debtRatio - 50);
                healthText = 'Regular';
                healthColor = 'bg-orange-500';
            } else {
                healthScore = Math.max(0, 30 - (debtRatio - 70));
                healthText = 'Cr√≠tica';
                healthColor = 'bg-red-500';
            }

            financialHealthTextEl.textContent = healthText;
            financialHealthBarEl.style.width = `${Math.max(5, healthScore)}%`;
            financialHealthBarEl.className = `h-2 rounded-full transition-all duration-500 ${healthColor}`;
        };

        const updateAllUI = () => { renderSummary(); renderBudget(); renderTransactions(); updateChart(); renderPatrimony(); };
        const openModal = (modalEl) => modalEl.classList.remove('hidden');
        const closeModal = (modalEl) => modalEl.classList.add('hidden');

        const openTransactionModal = (id = null) => {
            currentEditingId = id;
            const transaction = id ? transactions.find(t => t.id === id) : null;
            const type = transaction ? transaction.type : 'income';

            transactionModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-2xl m-4 rounded-2xl shadow-xl flex flex-col max-h-[90vh]">
                    <div class="flex justify-between items-center p-6 border-b dark:border-gray-700 flex-shrink-0">
                        <div>
                            <h3 class="text-xl font-semibold">${id ? 'Editar' : 'Nueva'} Transacci√≥n</h3>
                            <div class="flex items-center gap-2 mt-2">
                                <div class="flex items-center gap-1">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                    <span class="text-xs text-slate-500">Informaci√≥n B√°sica</span>
                                </div>
                                <div class="w-4 h-px bg-slate-300 dark:bg-gray-600"></div>
                                <div class="flex items-center gap-1">
                                    <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                                    <span class="text-xs text-slate-500">Categorizaci√≥n</span>
                                </div>
                                <div class="w-4 h-px bg-slate-300 dark:bg-gray-600"></div>
                                <div class="flex items-center gap-1">
                                    <div class="w-2 h-2 bg-green-500 rounded-full opacity-50" id="details-indicator"></div>
                                    <span class="text-xs text-slate-500">Detalles</span>
                                </div>
                            </div>
                        </div>
                        <button class="js-close-modal p-2 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700 transition-colors">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto px-6 py-4 modal-content">
                        <div class="space-y-4">
                            <form id="transaction-form-dynamic" class="space-y-6">
                                <!-- Secci√≥n: Informaci√≥n B√°sica -->
                                <div class="bg-slate-50 dark:bg-gray-700/50 p-4 rounded-lg form-section">
                                    <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                                        <i data-lucide="calendar" class="w-4 h-4 text-blue-500"></i>
                                        Informaci√≥n B√°sica
                                    </h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label for="transaction-date" class="block text-sm font-medium mb-1">Fecha de la Transacci√≥n</label>
                                            <input type="date" id="transaction-date" value="${transaction?.date || new Date().toISOString().split('T')[0]}"
                                                   class="w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-indigo-500" required>
                                        </div>
                                        <div>
                                            <label for="amount" class="block text-sm font-medium mb-1">Monto Total</label>
                                            <input type="number" id="amount" value="${transaction?.amount || ''}"
                                                   min="0.01" step="0.01" class="w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-indigo-500" required>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <label for="description" class="block text-sm font-medium mb-1">Descripci√≥n General</label>
                                        <input type="text" id="description" value="${transaction?.description || ''}"
                                               class="w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-indigo-500"
                                               placeholder="Describe brevemente esta transacci√≥n..." required>
                                    </div>
                                </div>

                                <!-- Secci√≥n: Tipo y Categorizaci√≥n -->
                                <div class="bg-slate-50 dark:bg-gray-700/50 p-4 rounded-lg form-section">
                                    <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3 flex items-center gap-2">
                                        <i data-lucide="tag" class="w-4 h-4 text-purple-500"></i>
                                        Categorizaci√≥n
                                    </h4>

                                    <div class="mb-4">
                                        <span class="block text-sm font-medium mb-2">Tipo de Transacci√≥n</span>
                                        <div class="grid grid-cols-2 gap-3">
                                            <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer transition-all hover:border-green-300 has-[:checked]:border-green-500 has-[:checked]:bg-green-50 dark:has-[:checked]:bg-green-900/20">
                                                <input type="radio" name="type" value="income" class="sr-only" ${type === 'income' ? 'checked' : ''}>
                                                <i data-lucide="trending-up" class="text-green-500 mr-3 w-5 h-5"></i>
                                                <div>
                                                    <div class="font-medium">Ingreso</div>
                                                    <div class="text-xs text-slate-500">Dinero que entra</div>
                                                </div>
                                            </label>
                                            <label class="flex items-center p-3 border-2 rounded-lg cursor-pointer transition-all hover:border-red-300 has-[:checked]:border-red-500 has-[:checked]:bg-red-50 dark:has-[:checked]:bg-red-900/20">
                                                <input type="radio" name="type" value="expense" class="sr-only" ${type === 'expense' ? 'checked' : ''}>
                                                <i data-lucide="trending-down" class="text-red-500 mr-3 w-5 h-5"></i>
                                                <div>
                                                    <div class="font-medium">Gasto</div>
                                                    <div class="text-xs text-slate-500">Dinero que sale</div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div>
                                            <label for="category" class="block text-sm font-medium mb-1">Categor√≠a Principal</label>
                                            <select id="category" class="w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-indigo-500 mobile-select-fix" required>
                                                <option value="">Selecciona una categor√≠a</option>
                                            </select>
                                        </div>

                                        <div id="subcategory-container" style="display: none;">
                                            <label for="subcategory" class="block text-sm font-medium mb-1">Subcategor√≠a</label>
                                            <select id="subcategory" class="w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-indigo-500 mobile-select-fix">
                                                <option value="">Sin subcategor√≠a</option>
                                            </select>
                                        </div>

                                        <div id="subsubcategory-container" style="display: none;">
                                            <label for="subsubcategory" class="block text-sm font-medium mb-1">Detalle</label>
                                            <select id="subsubcategory" class="w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-indigo-500 mobile-select-fix">
                                                <option value="">Sin detalle espec√≠fico</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Secci√≥n: Campos Espec√≠ficos Din√°micos -->
                                <div id="specific-fields-container" style="display: none;">
                                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
                                        <h4 class="text-sm font-semibold text-blue-700 dark:text-blue-300 mb-3 flex items-center gap-2">
                                            <i data-lucide="list-checks" class="w-4 h-4"></i>
                                            Detalles Espec√≠ficos
                                        </h4>
                                        <div id="specific-fields-content" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <!-- Los campos espec√≠ficos se generar√°n aqu√≠ din√°micamente -->
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- Footer fijo con botones -->
                        <div class="border-t dark:border-gray-700 p-6 bg-slate-50 dark:bg-gray-800/50 flex-shrink-0">
                            <div class="flex gap-3">
                                <button type="button" class="js-close-modal flex-1 px-4 py-2 text-sm font-medium border border-slate-300 dark:border-gray-600 rounded-md hover:bg-slate-100 dark:hover:bg-gray-700 transition-colors">
                                    Cancelar
                                </button>
                                <button type="submit" form="transaction-form-dynamic" class="flex-1 px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors">
                                    <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                    ${id ? 'Guardar Cambios' : 'Agregar Transacci√≥n'}
                                </button>
                            </div>
                        </div>
                </div>`;

            openModal(transactionModalEl);
            lucide.createIcons();

            // Event listeners
            transactionModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(transactionModalEl));
            transactionModalEl.querySelector('#transaction-form-dynamic').addEventListener('submit', handleTransactionFormSubmit);

            // Configurar listeners para cambios de tipo y categor√≠as
            const typeRadios = transactionModalEl.querySelectorAll('input[name="type"]');
            const categorySelect = transactionModalEl.querySelector('#category');
            const subcategorySelect = transactionModalEl.querySelector('#subcategory');
            const subsubcategorySelect = transactionModalEl.querySelector('#subsubcategory');

            typeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    updateCategoryOptions(e.target.value);
                    hideSubcategories();
                });
            });

            categorySelect.addEventListener('change', (e) => {
                updateSubcategoryOptions(e.target.value);
            });

            subcategorySelect.addEventListener('change', (e) => {
                updateSubSubcategoryOptions(categorySelect.value, e.target.value);
                updateSpecificFields();
            });

            subsubcategorySelect.addEventListener('change', () => {
                updateSpecificFields();
            });

            // Inicializar con el tipo actual
            updateCategoryOptions(type);

            // Si estamos editando, restaurar valores
            if (transaction) {
                setTimeout(() => {
                    if (transaction.category) categorySelect.value = transaction.category;
                    if (transaction.subcategory) {
                        updateSubcategoryOptions(transaction.category);
                        setTimeout(() => {
                            subcategorySelect.value = transaction.subcategory;
                            updateSpecificFields();

                            if (transaction.subsubcategory) {
                                updateSubSubcategoryOptions(transaction.category, transaction.subcategory);
                                setTimeout(() => {
                                    subsubcategorySelect.value = transaction.subsubcategory;
                                    updateSpecificFields();
                                }, 50);
                            }

                            // Restaurar campos espec√≠ficos
                            if (transaction.specificDetails) {
                                setTimeout(() => {
                                    Object.entries(transaction.specificDetails).forEach(([field, value]) => {
                                        const input = transactionModalEl.querySelector(`[name="specific-${field}"]`);
                                        if (input) {
                                            input.value = value;
                                        }
                                    });
                                }, 100);
                            }
                        }, 50);
                    }
                }, 50);
            }
        };

        // Funciones para manejar las opciones de categor√≠as y subcategor√≠as
        const updateCategoryOptions = (type) => {
            const categorySelect = transactionModalEl.querySelector('#category');
            const categories = getCategoriesForType(type);
            categorySelect.innerHTML = '<option value="">Selecciona una categor√≠a</option>' +
                categories.map(c => `<option value="${c}">${c}</option>`).join('');
            hideSubcategories();
        };

        const updateSubcategoryOptions = (category) => {
            const subcategoryContainer = transactionModalEl.querySelector('#subcategory-container');
            const subcategorySelect = transactionModalEl.querySelector('#subcategory');
            const type = transactionModalEl.querySelector('input[name="type"]:checked').value;

            if (!category) {
                hideSubcategories();
                return;
            }

            const subcategories = getSubcategoriesForCategory(type, category);
            if (subcategories.length > 0) {
                subcategorySelect.innerHTML = '<option value="">Sin subcategor√≠a</option>' +
                    subcategories.map(sc => `<option value="${sc}">${sc}</option>`).join('');
                subcategoryContainer.style.display = 'block';
            } else {
                hideSubcategories();
            }

            // Ocultar sub-subcategor√≠as cuando cambia la categor√≠a
            const subsubcategoryContainer = transactionModalEl.querySelector('#subsubcategory-container');
            subsubcategoryContainer.style.display = 'none';
        };

        const updateSubSubcategoryOptions = (category, subcategory) => {
            const subsubcategoryContainer = transactionModalEl.querySelector('#subsubcategory-container');
            const subsubcategorySelect = transactionModalEl.querySelector('#subsubcategory');
            const type = transactionModalEl.querySelector('input[name="type"]:checked').value;

            if (!subcategory) {
                subsubcategoryContainer.style.display = 'none';
                return;
            }

            const subsubcategories = getSubSubcategoriesForSubcategory(type, category, subcategory);
            if (subsubcategories.length > 0) {
                subsubcategorySelect.innerHTML = '<option value="">Sin detalle espec√≠fico</option>' +
                    subsubcategories.map(ssc => `<option value="${ssc}">${ssc}</option>`).join('');
                subsubcategoryContainer.style.display = 'block';
            } else {
                subsubcategoryContainer.style.display = 'none';
            }
        };

        const hideSubcategories = () => {
            const subcategoryContainer = transactionModalEl.querySelector('#subcategory-container');
            const subsubcategoryContainer = transactionModalEl.querySelector('#subsubcategory-container');
            const specificFieldsContainer = transactionModalEl.querySelector('#specific-fields-container');
            if (subcategoryContainer) subcategoryContainer.style.display = 'none';
            if (subsubcategoryContainer) subsubcategoryContainer.style.display = 'none';
            if (specificFieldsContainer) specificFieldsContainer.style.display = 'none';
        };

        const updateSpecificFields = () => {
            const typeRadio = transactionModalEl.querySelector('input[name="type"]:checked');
            const categorySelect = transactionModalEl.querySelector('#category');
            const subcategorySelect = transactionModalEl.querySelector('#subcategory');
            const specificFieldsContainer = transactionModalEl.querySelector('#specific-fields-container');
            const specificFieldsContent = transactionModalEl.querySelector('#specific-fields-content');

            if (!typeRadio || !categorySelect.value || !subcategorySelect.value) {
                if (specificFieldsContainer) specificFieldsContainer.style.display = 'none';
                return;
            }

            const type = typeRadio.value;
            const category = categorySelect.value;
            const subcategory = subcategorySelect.value;

            const fields = getSpecificFields(type, category, subcategory);

            if (fields.length === 0) {
                specificFieldsContainer.style.display = 'none';
                return;
            }

            // Generar campos espec√≠ficos con mejor layout
            let fieldsHtml = '';
            fields.forEach((field, index) => {
                const isRequired = field.required ? 'required' : '';
                const placeholder = field.placeholder ? `placeholder="${field.placeholder}"` : '';
                const step = field.step ? `step="${field.step}"` : '';
                const min = field.min ? `min="${field.min}"` : '';

                // Determinar si el campo debe ocupar toda la fila
                const isFullWidth = field.type === 'textarea' || field.field === 'descripcion' || field.field === 'observaciones';
                const colClass = isFullWidth ? 'md:col-span-2' : '';

                fieldsHtml += `<div class="${colClass} dynamic-field specific-field">`;
                fieldsHtml += `<label for="specific-${field.field}" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">`;
                fieldsHtml += `${field.label}${field.required ? ' <span class="text-red-500">*</span>' : ''}`;
                fieldsHtml += `</label>`;

                if (field.type === 'select') {
                    fieldsHtml += `<select id="specific-${field.field}" name="specific-${field.field}" class="w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-blue-500 transition-colors" ${isRequired}>`;
                    fieldsHtml += `<option value="">Seleccionar...</option>`;
                    field.options.forEach(option => {
                        fieldsHtml += `<option value="${option}">${option}</option>`;
                    });
                    fieldsHtml += `</select>`;
                } else if (field.type === 'textarea') {
                    fieldsHtml += `<textarea id="specific-${field.field}" name="specific-${field.field}" rows="3" class="w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-blue-500 transition-colors resize-none" ${placeholder} ${isRequired}></textarea>`;
                } else {
                    const inputClass = field.type === 'date' || field.type === 'time' ? 'w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-blue-500 transition-colors' : 'w-full px-3 py-2 bg-white dark:bg-gray-800 border rounded-md focus:ring-2 focus:ring-blue-500 transition-colors';
                    fieldsHtml += `<input type="${field.type}" id="specific-${field.field}" name="specific-${field.field}" class="${inputClass}" ${placeholder} ${step} ${min} ${isRequired}>`;
                }

                fieldsHtml += `</div>`;
            });

            specificFieldsContent.innerHTML = fieldsHtml;
            specificFieldsContainer.style.display = 'block';

            // Activar indicador de detalles
            const detailsIndicator = transactionModalEl.querySelector('#details-indicator');
            if (detailsIndicator) {
                detailsIndicator.classList.remove('opacity-50');
                detailsIndicator.classList.add('opacity-100');
            }

            // Scroll suave hacia la secci√≥n de campos espec√≠ficos
            setTimeout(() => {
                const specificFieldsContainer = transactionModalEl.querySelector('#specific-fields-container');
                if (specificFieldsContainer) {
                    specificFieldsContainer.scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest'
                    });
                }
            }, 100);
        };

        // ===== GESTI√ìN DE CATEGOR√çAS =====
        const openCategoriesModal = () => {
            renderCategoriesModal();
            openModal(categoriesModalEl);
            lucide.createIcons();
        };

        const renderCategoriesModal = () => {
            const currentStructure = getCurrentCategoryStructure();

            categoriesModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-4xl m-4 rounded-2xl shadow-xl flex flex-col h-[80vh]">
                    <div class="flex justify-between items-center p-6 border-b dark:border-gray-700">
                        <h3 class="text-xl font-semibold flex items-center gap-2">
                            <i data-lucide="folder-tree" class="text-indigo-500"></i>
                            Gestionar Categor√≠as
                        </h3>
                        <button class="js-close-modal p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                            <i data-lucide="x"></i>
                        </button>
                    </div>

                    <div class="flex-1 flex overflow-hidden">
                        <!-- Tabs -->
                        <div class="w-48 border-r dark:border-gray-700 p-4">
                            <div class="space-y-2">
                                <button class="category-tab w-full text-left px-3 py-2 rounded-md bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300" data-type="income">
                                    <i data-lucide="arrow-down-circle" class="w-4 h-4 inline mr-2"></i>
                                    Ingresos
                                </button>
                                <button class="category-tab w-full text-left px-3 py-2 rounded-md hover:bg-slate-100 dark:hover:bg-gray-700" data-type="expense">
                                    <i data-lucide="arrow-up-circle" class="w-4 h-4 inline mr-2"></i>
                                    Gastos
                                </button>
                            </div>
                        </div>

                        <!-- Content Area -->
                        <div class="flex-1 p-6 overflow-y-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h4 id="current-type-title" class="text-lg font-semibold">Categor√≠as de Ingresos</h4>
                                <button id="add-main-category-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    Agregar Categor√≠a
                                </button>
                            </div>

                            <div id="categories-tree" class="space-y-2">
                                <!-- Categories will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <div class="p-4 border-t dark:border-gray-700 bg-slate-50 dark:bg-gray-800/50">
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-slate-500 dark:text-slate-400">
                                üí° Las categor√≠as en uso no pueden eliminarse
                            </p>
                            <button id="reset-categories-btn" class="text-sm text-red-600 dark:text-red-400 hover:underline">
                                Restaurar Categor√≠as por Defecto
                            </button>
                        </div>
                    </div>
                </div>`;

            // Event listeners
            categoriesModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(categoriesModalEl));

            // Tab switching
            categoriesModalEl.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    // Update active tab
                    categoriesModalEl.querySelectorAll('.category-tab').forEach(t => {
                        t.className = 'category-tab w-full text-left px-3 py-2 rounded-md hover:bg-slate-100 dark:hover:bg-gray-700';
                    });
                    e.target.classList.add('bg-green-100', 'dark:bg-green-900/50', 'text-green-700', 'dark:text-green-300');
                    if (e.target.dataset.type === 'expense') {
                        e.target.classList.remove('bg-green-100', 'dark:bg-green-900/50', 'text-green-700', 'dark:text-green-300');
                        e.target.classList.add('bg-red-100', 'dark:bg-red-900/50', 'text-red-700', 'dark:text-red-300');
                    }

                    // Update content
                    const type = e.target.dataset.type;
                    categoriesModalEl.querySelector('#current-type-title').textContent =
                        type === 'income' ? 'Categor√≠as de Ingresos' : 'Categor√≠as de Gastos';
                    renderCategoriesTree(type);
                });
            });

            // Add main category button
            categoriesModalEl.querySelector('#add-main-category-btn').addEventListener('click', () => {
                const activeTab = categoriesModalEl.querySelector('.category-tab.bg-green-100, .category-tab.bg-red-100');
                const type = activeTab ? activeTab.dataset.type : 'income';
                showAddCategoryForm(type, null);
            });

            // Reset categories button
            categoriesModalEl.querySelector('#reset-categories-btn').addEventListener('click', resetCategoriesToDefault);

            // Initial render
            renderCategoriesTree('income');
        };

        const renderCategoriesTree = (type) => {
            const treeContainer = categoriesModalEl.querySelector('#categories-tree');
            const currentStructure = getCurrentCategoryStructure();
            const categories = currentStructure[type] || {};

            let html = '';

            Object.keys(categories).forEach(categoryName => {
                const subcategories = categories[categoryName] || {};
                const categoryId = `cat-${type}-${categoryName.replace(/\s+/g, '-')}`;

                html += `
                    <div class="category-item border rounded-lg p-3 bg-white dark:bg-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <button class="expand-btn text-slate-400 hover:text-slate-600" data-target="${categoryId}">
                                    <i data-lucide="chevron-right" class="w-4 h-4 transition-transform"></i>
                                </button>
                                <span class="font-medium">${categoryName}</span>
                                <span class="text-xs text-slate-500 bg-slate-100 dark:bg-gray-600 px-2 py-1 rounded">
                                    ${Object.keys(subcategories).length} subcategor√≠as
                                </span>
                            </div>
                            <div class="flex items-center gap-1">
                                <button class="add-subcategory-btn p-1 text-slate-400 hover:text-green-600"
                                        data-type="${type}" data-category="${categoryName}" title="Agregar subcategor√≠a">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                                <button class="edit-category-btn p-1 text-slate-400 hover:text-blue-600"
                                        data-type="${type}" data-category="${categoryName}" title="Editar nombre">
                                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                                </button>
                                <button class="delete-category-btn p-1 text-slate-400 hover:text-red-600"
                                        data-type="${type}" data-category="${categoryName}" title="Eliminar categor√≠a">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>

                        <div id="${categoryId}" class="subcategories-container hidden mt-3 ml-6 space-y-2">
                            ${Object.keys(subcategories).map(subName => {
                                const subItems = subcategories[subName] || [];
                                const subId = `sub-${type}-${categoryName.replace(/\s+/g, '-')}-${subName.replace(/\s+/g, '-')}`;

                                return `
                                    <div class="subcategory-item border-l-2 border-slate-200 dark:border-gray-600 pl-3">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                                <button class="expand-btn text-slate-400 hover:text-slate-600" data-target="${subId}">
                                                    <i data-lucide="chevron-right" class="w-3 h-3 transition-transform"></i>
                                                </button>
                                                <span class="text-sm font-medium">${subName}</span>
                                                <span class="text-xs text-slate-500 bg-slate-100 dark:bg-gray-600 px-1 py-0.5 rounded">
                                                    ${subItems.length} items
                                                </span>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <button class="add-subsubcategory-btn p-1 text-slate-400 hover:text-green-600"
                                                        data-type="${type}" data-category="${categoryName}" data-subcategory="${subName}" title="Agregar item">
                                                    <i data-lucide="plus" class="w-3 h-3"></i>
                                                </button>
                                                <button class="edit-subcategory-btn p-1 text-slate-400 hover:text-blue-600"
                                                        data-type="${type}" data-category="${categoryName}" data-subcategory="${subName}" title="Editar nombre">
                                                    <i data-lucide="edit-3" class="w-3 h-3"></i>
                                                </button>
                                                <button class="delete-subcategory-btn p-1 text-slate-400 hover:text-red-600"
                                                        data-type="${type}" data-category="${categoryName}" data-subcategory="${subName}" title="Eliminar subcategor√≠a">
                                                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div id="${subId}" class="subsubcategories-container hidden mt-2 ml-4 space-y-1">
                                            ${subItems.map(itemName => `
                                                <div class="flex items-center justify-between py-1">
                                                    <span class="text-sm text-slate-600 dark:text-slate-400">${itemName}</span>
                                                    <div class="flex items-center gap-1">
                                                        <button class="edit-subsubcategory-btn p-1 text-slate-400 hover:text-blue-600"
                                                                data-type="${type}" data-category="${categoryName}" data-subcategory="${subName}" data-subsubcategory="${itemName}" title="Editar nombre">
                                                            <i data-lucide="edit-3" class="w-3 h-3"></i>
                                                        </button>
                                                        <button class="delete-subsubcategory-btn p-1 text-slate-400 hover:text-red-600"
                                                                data-type="${type}" data-category="${categoryName}" data-subcategory="${subName}" data-subsubcategory="${itemName}" title="Eliminar item">
                                                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            if (html === '') {
                html = `
                    <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                        <i data-lucide="folder-plus" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>No hay categor√≠as de ${type === 'income' ? 'ingresos' : 'gastos'} todav√≠a.</p>
                        <p class="text-sm">Haz clic en "Agregar Categor√≠a" para comenzar.</p>
                    </div>
                `;
            }

            treeContainer.innerHTML = html;

            // Add event listeners
            addCategoryTreeEventListeners();
        };

        const addCategoryTreeEventListeners = () => {
            const treeContainer = categoriesModalEl.querySelector('#categories-tree');

            // Expand/collapse buttons
            treeContainer.querySelectorAll('.expand-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.dataset.target;
                    const target = document.getElementById(targetId);
                    const icon = e.currentTarget.querySelector('i');

                    if (target.classList.contains('hidden')) {
                        target.classList.remove('hidden');
                        icon.style.transform = 'rotate(90deg)';
                    } else {
                        target.classList.add('hidden');
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
            });

            // Add buttons
            treeContainer.querySelectorAll('.add-subcategory-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { type, category } = e.currentTarget.dataset;
                    showAddCategoryForm(type, category);
                });
            });

            treeContainer.querySelectorAll('.add-subsubcategory-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { type, category, subcategory } = e.currentTarget.dataset;
                    showAddCategoryForm(type, category, subcategory);
                });
            });

            // Edit buttons
            treeContainer.querySelectorAll('.edit-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { type, category } = e.currentTarget.dataset;
                    showEditCategoryForm(type, category);
                });
            });

            treeContainer.querySelectorAll('.edit-subcategory-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { type, category, subcategory } = e.currentTarget.dataset;
                    showEditCategoryForm(type, category, subcategory);
                });
            });

            treeContainer.querySelectorAll('.edit-subsubcategory-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { type, category, subcategory, subsubcategory } = e.currentTarget.dataset;
                    showEditCategoryForm(type, category, subcategory, subsubcategory);
                });
            });

            // Delete buttons
            treeContainer.querySelectorAll('.delete-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { type, category } = e.currentTarget.dataset;
                    confirmDeleteCategory(type, category);
                });
            });

            treeContainer.querySelectorAll('.delete-subcategory-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { type, category, subcategory } = e.currentTarget.dataset;
                    confirmDeleteCategory(type, category, subcategory);
                });
            });

            treeContainer.querySelectorAll('.delete-subsubcategory-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const { type, category, subcategory, subsubcategory } = e.currentTarget.dataset;
                    confirmDeleteCategory(type, category, subcategory, subsubcategory);
                });
            });
        };

        // ===== FUNCIONES CRUD PARA CATEGOR√çAS =====
        const showAddCategoryForm = (type, parentCategory = null, parentSubcategory = null) => {
            const level = parentSubcategory ? 'item' : parentCategory ? 'subcategor√≠a' : 'categor√≠a';
            const title = `Agregar ${level}`;

            const formHtml = `
                <div class="fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
                        <h4 class="text-lg font-semibold mb-4">${title}</h4>
                        <form id="add-category-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Nombre del ${level}</label>
                                <input type="text" id="category-name-input"
                                       class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="Ingresa el nombre..." required maxlength="50">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" class="cancel-btn px-4 py-2 text-sm border rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                                    Agregar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', formHtml);
            const formContainer = document.body.lastElementChild;
            const form = formContainer.querySelector('#add-category-form');
            const input = formContainer.querySelector('#category-name-input');

            input.focus();

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = input.value.trim();
                if (name) {
                    await addCategory(type, name, parentCategory, parentSubcategory);
                    formContainer.remove();
                }
            });

            formContainer.querySelector('.cancel-btn').addEventListener('click', () => {
                formContainer.remove();
            });

            formContainer.addEventListener('click', (e) => {
                if (e.target === formContainer) formContainer.remove();
            });
        };

        const showEditCategoryForm = (type, category, subcategory = null, subsubcategory = null) => {
            const currentName = subsubcategory || subcategory || category;
            const level = subsubcategory ? 'item' : subcategoria ? 'subcategor√≠a' : 'categor√≠a';

            const formHtml = `
                <div class="fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
                        <h4 class="text-lg font-semibold mb-4">Editar ${level}</h4>
                        <form id="edit-category-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Nombre del ${level}</label>
                                <input type="text" id="category-name-input"
                                       class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"
                                       value="${currentName}" required maxlength="50">
                            </div>
                            <div class="flex justify-end gap-2">
                                <button type="button" class="cancel-btn px-4 py-2 text-sm border rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    Guardar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', formHtml);
            const formContainer = document.body.lastElementChild;
            const form = formContainer.querySelector('#edit-category-form');
            const input = formContainer.querySelector('#category-name-input');

            input.focus();
            input.select();

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    await editCategory(type, category, newName, subcategory, subsubcategory);
                    formContainer.remove();
                } else {
                    formContainer.remove();
                }
            });

            formContainer.querySelector('.cancel-btn').addEventListener('click', () => {
                formContainer.remove();
            });

            formContainer.addEventListener('click', (e) => {
                if (e.target === formContainer) formContainer.remove();
            });
        };

        const addCategory = async (type, name, parentCategory = null, parentSubcategory = null) => {
            try {
                const currentStructure = getCurrentCategoryStructure();
                const newStructure = JSON.parse(JSON.stringify(currentStructure));

                if (!newStructure[type]) newStructure[type] = {};

                if (parentSubcategory) {
                    // Agregar sub-subcategor√≠a
                    if (!newStructure[type][parentCategory][parentSubcategory]) {
                        newStructure[type][parentCategory][parentSubcategory] = [];
                    }
                    newStructure[type][parentCategory][parentSubcategory].push(name);
                } else if (parentCategory) {
                    // Agregar subcategor√≠a
                    if (!newStructure[type][parentCategory]) {
                        newStructure[type][parentCategory] = {};
                    }
                    newStructure[type][parentCategory][name] = [];
                } else {
                    // Agregar categor√≠a principal
                    newStructure[type][name] = {};
                }

                await saveCategoryStructure(newStructure);
                showSuccessMessage(`${name} agregado exitosamente`);
            } catch (error) {
                console.error('Error adding category:', error);
                showErrorMessage('Error al agregar la categor√≠a');
            }
        };

        const editCategory = async (type, category, newName, subcategory = null, subsubcategory = null) => {
            try {
                const currentStructure = getCurrentCategoryStructure();
                const newStructure = JSON.parse(JSON.stringify(currentStructure));

                if (subsubcategory) {
                    // Editar sub-subcategor√≠a
                    const items = newStructure[type][category][subcategory];
                    const index = items.indexOf(subsubcategory);
                    if (index !== -1) {
                        items[index] = newName;
                    }
                } else if (subcategory) {
                    // Editar subcategor√≠a
                    const subcategories = newStructure[type][category];
                    const items = subcategories[subcategory];
                    delete subcategories[subcategory];
                    subcategories[newName] = items;
                } else {
                    // Editar categor√≠a principal
                    const categoryData = newStructure[type][category];
                    delete newStructure[type][category];
                    newStructure[type][newName] = categoryData;
                }

                await saveCategoryStructure(newStructure);
                showSuccessMessage(`Nombre actualizado a "${newName}"`);
            } catch (error) {
                console.error('Error editing category:', error);
                showErrorMessage('Error al editar la categor√≠a');
            }
        };

        const confirmDeleteCategory = async (type, category, subcategory = null, subsubcategory = null) => {
            const itemName = subsubcategory || subcategory || category;
            const level = subsubcategory ? 'item' : subcategoria ? 'subcategor√≠a' : 'categor√≠a';

            // Verificar si est√° en uso
            const inUse = isCategoryInUse(type, category, subcategory, subsubcategory);
            if (inUse) {
                showErrorMessage(`No se puede eliminar "${itemName}" porque est√° siendo usado en transacciones existentes.`);
                return;
            }

            if (confirm(`¬øEst√°s seguro de que quieres eliminar ${level} "${itemName}"?`)) {
                await deleteCategory(type, category, subcategory, subsubcategory);
            }
        };

        const deleteCategory = async (type, category, subcategory = null, subsubcategory = null) => {
            try {
                const currentStructure = getCurrentCategoryStructure();
                const newStructure = JSON.parse(JSON.stringify(currentStructure));

                if (subsubcategory) {
                    // Eliminar sub-subcategor√≠a
                    const items = newStructure[type][category][subcategory];
                    const index = items.indexOf(subsubcategory);
                    if (index !== -1) {
                        items.splice(index, 1);
                    }
                } else if (subcategory) {
                    // Eliminar subcategor√≠a
                    delete newStructure[type][category][subcategory];
                } else {
                    // Eliminar categor√≠a principal
                    delete newStructure[type][category];
                }

                await saveCategoryStructure(newStructure);
                showSuccessMessage('Eliminado exitosamente');
            } catch (error) {
                console.error('Error deleting category:', error);
                showErrorMessage('Error al eliminar la categor√≠a');
            }
        };

        const saveCategoryStructure = async (structure) => {
            if (!categoriesDocRef) return;
            await categoriesDocRef.set(structure);
        };

        const isCategoryInUse = (type, category, subcategory = null, subsubcategory = null) => {
            return transactions.some(t => {
                if (t.type !== type || t.category !== category) return false;
                if (subcategory && t.subcategory !== subcategory) return false;
                if (subsubcategory && t.subsubcategory !== subsubcategory) return false;
                return true;
            });
        };

        const resetCategoriesToDefault = async () => {
            if (confirm('¬øEst√°s seguro de que quieres restaurar las categor√≠as por defecto? Esto eliminar√° todas las categor√≠as personalizadas.')) {
                try {
                    await saveCategoryStructure(categoryStructure);
                    showSuccessMessage('Categor√≠as restauradas por defecto');
                } catch (error) {
                    console.error('Error resetting categories:', error);
                    showErrorMessage('Error al restaurar las categor√≠as');
                }
            }
        };

        // ===== FORMULARIO DE PASIVOS =====
        const openLiabilityForm = (id = null) => {
            const liability = id ? liabilities.find(l => l.id === id) : null;

            liabilityFormModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-2xl m-4 rounded-2xl shadow-xl flex flex-col max-h-[90vh]">
                    <div class="flex justify-between items-center p-6 border-b dark:border-gray-700">
                        <h3 class="text-xl font-semibold">${id ? 'Editar' : 'Nuevo'} Pasivo</h3>
                        <button class="js-close-modal p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                            <i data-lucide="x"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-6">
                        <form id="liability-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="liability-name" class="block text-sm font-medium mb-1">Nombre del Pasivo</label>
                                    <input type="text" id="liability-name" value="${liability?.name || ''}"
                                           class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md"
                                           placeholder="Ej: Hipoteca casa, Tarjeta de cr√©dito..." required>
                                </div>

                                <div>
                                    <label for="liability-category" class="block text-sm font-medium mb-1">Categor√≠a</label>
                                    <select id="liability-category" class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md" required>
                                        <option value="">Seleccionar categor√≠a</option>
                                        <option value="Hipotecas" ${liability?.category === 'Hipotecas' ? 'selected' : ''}>Hipotecas</option>
                                        <option value="Pr√©stamos Personales" ${liability?.category === 'Pr√©stamos Personales' ? 'selected' : ''}>Pr√©stamos Personales</option>
                                        <option value="Tarjetas de Cr√©dito" ${liability?.category === 'Tarjetas de Cr√©dito' ? 'selected' : ''}>Tarjetas de Cr√©dito</option>
                                        <option value="Pr√©stamos Vehiculares" ${liability?.category === 'Pr√©stamos Vehiculares' ? 'selected' : ''}>Pr√©stamos Vehiculares</option>
                                        <option value="Pr√©stamos Estudiantiles" ${liability?.category === 'Pr√©stamos Estudiantiles' ? 'selected' : ''}>Pr√©stamos Estudiantiles</option>
                                        <option value="Deudas Comerciales" ${liability?.category === 'Deudas Comerciales' ? 'selected' : ''}>Deudas Comerciales</option>
                                        <option value="Otros" ${liability?.category === 'Otros' ? 'selected' : ''}>Otros</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label for="liability-subcategory" class="block text-sm font-medium mb-1">Subcategor√≠a (opcional)</label>
                                <input type="text" id="liability-subcategory" value="${liability?.subcategory || ''}"
                                       class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md"
                                       placeholder="Ej: Banco espec√≠fico, tipo de tarjeta...">
                            </div>

                            <div>
                                <label for="liability-description" class="block text-sm font-medium mb-1">Descripci√≥n</label>
                                <textarea id="liability-description" rows="2"
                                          class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md"
                                          placeholder="Detalles adicionales sobre este pasivo...">${liability?.description || ''}</textarea>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="liability-balance" class="block text-sm font-medium mb-1">Saldo Actual</label>
                                    <input type="number" id="liability-balance" value="${liability?.currentBalance || ''}"
                                           min="0" step="0.01" class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md"
                                           placeholder="0.00" required>
                                </div>

                                <div>
                                    <label for="liability-original" class="block text-sm font-medium mb-1">Monto Original (opcional)</label>
                                    <input type="number" id="liability-original" value="${liability?.originalAmount || ''}"
                                           min="0" step="0.01" class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md"
                                           placeholder="0.00">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="liability-payment" class="block text-sm font-medium mb-1">Cuota Mensual (opcional)</label>
                                    <input type="number" id="liability-payment" value="${liability?.monthlyPayment || ''}"
                                           min="0" step="0.01" class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md"
                                           placeholder="0.00">
                                </div>

                                <div>
                                    <label for="liability-rate" class="block text-sm font-medium mb-1">Tasa de Inter√©s % (opcional)</label>
                                    <input type="number" id="liability-rate" value="${liability?.interestRate || ''}"
                                           min="0" max="100" step="0.01" class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md"
                                           placeholder="0.00">
                                </div>

                                <div>
                                    <label for="liability-months" class="block text-sm font-medium mb-1">Meses Restantes (opcional)</label>
                                    <input type="number" id="liability-months" value="${liability?.monthsRemaining || ''}"
                                           min="0" class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md"
                                           placeholder="0">
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="p-6 border-t dark:border-gray-700 bg-slate-50 dark:bg-gray-800/50">
                        <div class="flex gap-3">
                            <button type="button" class="js-close-modal flex-1 px-4 py-2 text-sm font-medium border border-slate-300 dark:border-gray-600 rounded-md hover:bg-slate-100 dark:hover:bg-gray-700 transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" form="liability-form" class="flex-1 px-4 py-2 text-sm font-medium bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
                                ${id ? 'Guardar Cambios' : 'Agregar Pasivo'}
                            </button>
                        </div>
                    </div>
                </div>`;

            liabilityFormModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(liabilityFormModalEl));
            liabilityFormModalEl.querySelector('#liability-form').addEventListener('submit', (e) => saveLiability(e, id));

            openModal(liabilityFormModalEl);
            lucide.createIcons();
        };

        const saveLiability = async (e, id = null) => {
            e.preventDefault();

            const liabilityData = {
                name: liabilityFormModalEl.querySelector('#liability-name').value,
                category: liabilityFormModalEl.querySelector('#liability-category').value,
                subcategory: liabilityFormModalEl.querySelector('#liability-subcategory').value,
                description: liabilityFormModalEl.querySelector('#liability-description').value,
                currentBalance: parseFloat(liabilityFormModalEl.querySelector('#liability-balance').value) || 0,
                originalAmount: parseFloat(liabilityFormModalEl.querySelector('#liability-original').value) || null,
                monthlyPayment: parseFloat(liabilityFormModalEl.querySelector('#liability-payment').value) || null,
                interestRate: parseFloat(liabilityFormModalEl.querySelector('#liability-rate').value) || null,
                monthsRemaining: parseInt(liabilityFormModalEl.querySelector('#liability-months').value) || null,
                lastUpdated: new Date(),
                userId: currentUser.uid
            };

            try {
                if (id) {
                    await liabilitiesCollection.doc(id).update(liabilityData);
                    showSuccessMessage('Pasivo actualizado correctamente');
                } else {
                    await liabilitiesCollection.add(liabilityData);
                    showSuccessMessage('Pasivo agregado correctamente');
                }

                closeModal(liabilityFormModalEl);
                await loadLiabilities();
                renderLiabilitiesList();
                renderPatrimony();
            } catch (error) {
                console.error('Error saving liability:', error);
                showErrorMessage('Error al guardar el pasivo');
            }
        };

        const deleteLiability = async (id) => {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este pasivo?')) return;

            try {
                await liabilitiesCollection.doc(id).delete();
                showSuccessMessage('Pasivo eliminado correctamente');
                await loadLiabilities();
                renderLiabilitiesList();
                renderPatrimony();
            } catch (error) {
                console.error('Error deleting liability:', error);
                showErrorMessage('Error al eliminar el pasivo');
            }
        };

        // ===== GESTI√ìN DE ACTIVOS =====
        const openAssetsModal = () => {
            renderAssetsModal();
            openModal(assetsModalEl);
            lucide.createIcons();
        };

        const renderAssetsModal = () => {
            assetsModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-4xl m-4 rounded-2xl shadow-xl flex flex-col h-[80vh]">
                    <div class="flex justify-between items-center p-6 border-b dark:border-gray-700">
                        <h3 class="text-xl font-semibold flex items-center gap-2">
                            <i data-lucide="trending-up" class="text-green-500"></i>
                            Gestionar Activos
                        </h3>
                        <button class="js-close-modal p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                            <i data-lucide="x"></i>
                        </button>
                    </div>

                    <div class="flex-1 p-6 overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Mis Activos</h4>
                            <button id="add-asset-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-green-600 rounded-md hover:bg-green-700">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Agregar Activo
                            </button>
                        </div>

                        <div id="assets-list" class="space-y-3">
                            <!-- Assets will be rendered here -->
                        </div>
                    </div>

                    <div class="p-4 border-t dark:border-gray-700 bg-slate-50 dark:bg-gray-800/50">
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-slate-500 dark:text-slate-400">
                                üí° Mant√©n actualizados los valores de tus activos
                            </p>
                            <p class="text-lg font-semibold text-green-600 dark:text-green-400">
                                Total: <span id="modal-total-assets">${formatCurrency(assets.reduce((sum, a) => sum + (a.currentValue || 0), 0))}</span>
                            </p>
                        </div>
                    </div>
                </div>`;

            assetsModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(assetsModalEl));
            assetsModalEl.querySelector('#add-asset-btn').addEventListener('click', () => openAssetForm());

            renderAssetsList();
        };

        const renderAssetsList = () => {
            const assetsList = assetsModalEl.querySelector('#assets-list');

            if (assets.length === 0) {
                assetsList.innerHTML = `
                    <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                        <i data-lucide="trending-up" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p>No tienes activos registrados todav√≠a.</p>
                        <p class="text-sm">Agrega tus primeros activos para comenzar a construir tu patrimonio.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            assets.forEach(asset => {
                html += `
                    <div class="bg-slate-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-semibold">${asset.name}</h5>
                                <p class="text-sm text-slate-500 dark:text-slate-400">${asset.category} ‚Ä∫ ${asset.subcategory || 'General'}</p>
                                <div class="flex gap-4 mt-2 text-xs text-slate-400 dark:text-slate-500">
                                    ${asset.monthlyPayment > 0 ? `<span>Cuota: ${formatCurrency(asset.monthlyPayment)}</span>` : ''}
                                    ${asset.monthsRemaining > 0 ? `<span>Faltan: ${asset.monthsRemaining} meses</span>` : ''}
                                    ${asset.interestRate ? `<span>Tasa: ${asset.interestRate}%</span>` : ''}
                                </div>
                                <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">${asset.description || 'Sin descripci√≥n'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-semibold text-green-600 dark:text-green-400">${formatCurrency(asset.currentValue || 0)}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Actualizado: ${asset.lastUpdated?.toDate().toLocaleDateString('es-ES') || 'Nunca'}</p>
                            </div>
                            <div class="flex flex-col gap-1 ml-2">
                                <button class="edit-asset-btn p-1 text-slate-400 hover:text-blue-600" data-id="${asset.id}">
                                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                                </button>
                                <button class="delete-asset-btn p-1 text-slate-400 hover:text-red-600" data-id="${asset.id}">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            assetsList.innerHTML = html;

            // Add event listeners
            assetsList.querySelectorAll('.edit-asset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openAssetForm(e.target.closest('button').dataset.id));
            });

            assetsList.querySelectorAll('.delete-asset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteAsset(e.target.closest('button').dataset.id));
            });
        };

        const openAssetForm = (assetId = null) => {
            const asset = assetId ? assets.find(a => a.id === assetId) : null;
            const isEditing = !!asset;

            const formHtml = `
                <div class="fixed inset-0 z-60 flex items-center justify-center bg-black bg-opacity-50">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
                        <h4 class="text-lg font-semibold mb-4">${isEditing ? 'Editar' : 'Agregar'} Activo</h4>
                        <form id="asset-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Nombre del Activo</label>
                                <input type="text" id="asset-name" value="${asset?.name || ''}"
                                       class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="Ej: Casa principal, Carro, Cuenta de ahorros..." required>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Categor√≠a</label>
                                <select id="asset-category" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600" required>
                                    <option value="">Selecciona una categor√≠a</option>
                                    ${Object.keys(categoryStructure.assets).map(cat =>
                                        `<option value="${cat}" ${asset?.category === cat ? 'selected' : ''}>${cat}</option>`
                                    ).join('')}
                                </select>
                            </div>

                            <div class="mb-4" id="asset-subcategory-container" style="display: none;">
                                <label class="block text-sm font-medium mb-2">Subcategor√≠a</label>
                                <select id="asset-subcategory" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                                    <option value="">Selecciona una subcategor√≠a</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Valor Actual</label>
                                <input type="number" id="asset-value" value="${asset?.currentValue || ''}"
                                       min="0" step="0.01" class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="0.00" required>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Descripci√≥n (opcional)</label>
                                <textarea id="asset-description" rows="2"
                                          class="w-full px-3 py-2 border rounded-md dark:bg-gray-700 dark:border-gray-600"
                                          placeholder="Detalles adicionales...">${asset?.description || ''}</textarea>
                            </div>

                            <div class="flex justify-end gap-2">
                                <button type="button" class="cancel-btn px-4 py-2 text-sm border rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm bg-green-600 text-white rounded-md hover:bg-green-700">
                                    ${isEditing ? 'Actualizar' : 'Agregar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', formHtml);
            const formContainer = document.body.lastElementChild;
            const form = formContainer.querySelector('#asset-form');
            const categorySelect = formContainer.querySelector('#asset-category');
            const subcategorySelect = formContainer.querySelector('#asset-subcategory');
            const subcategoryContainer = formContainer.querySelector('#asset-subcategory-container');

            // Handle category change
            categorySelect.addEventListener('change', (e) => {
                const category = e.target.value;
                if (category && categoryStructure.assets[category]) {
                    const subcategories = Object.keys(categoryStructure.assets[category]);
                    if (subcategories.length > 0) {
                        subcategorySelect.innerHTML = '<option value="">Selecciona una subcategor√≠a</option>' +
                            subcategories.map(sub => `<option value="${sub}">${sub}</option>`).join('');
                        subcategoryContainer.style.display = 'block';
                    } else {
                        subcategoryContainer.style.display = 'none';
                    }
                } else {
                    subcategoryContainer.style.display = 'none';
                }
            });

            // Initialize subcategory if editing
            if (asset && asset.category) {
                setTimeout(() => {
                    categorySelect.dispatchEvent(new Event('change'));
                    if (asset.subcategory) {
                        setTimeout(() => {
                            subcategorySelect.value = asset.subcategory;
                        }, 50);
                    }
                }, 50);
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = {
                    name: form.querySelector('#asset-name').value.trim(),
                    category: form.querySelector('#asset-category').value,
                    subcategory: form.querySelector('#asset-subcategory').value || null,
                    currentValue: parseFloat(form.querySelector('#asset-value').value),
                    description: form.querySelector('#asset-description').value.trim() || null,
                    lastUpdated: serverTimestamp()
                };

                try {
                    if (isEditing) {
                        await assetsCollection.doc(assetId).update(formData);
                        showSuccessMessage('Activo actualizado exitosamente');
                    } else {
                        await assetsCollection.add({ ...formData, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        showSuccessMessage('Activo agregado exitosamente');
                    }
                    formContainer.remove();
                    renderAssetsList();

                    // Update modal total
                    const modalTotal = assetsModalEl.querySelector('#modal-total-assets');
                    if (modalTotal) {
                        const newTotal = assets.reduce((sum, a) => sum + (a.currentValue || 0), 0);
                        modalTotal.textContent = formatCurrency(newTotal);
                    }
                } catch (error) {
                    console.error('Error saving asset:', error);
                    showErrorMessage('Error al guardar el activo');
                }
            });

            formContainer.querySelector('.cancel-btn').addEventListener('click', () => {
                formContainer.remove();
            });

            formContainer.addEventListener('click', (e) => {
                if (e.target === formContainer) formContainer.remove();
            });
        };

        const deleteAsset = async (assetId) => {
            if (confirm('¬øEst√°s seguro de que quieres eliminar este activo?')) {
                try {
                    await assetsCollection.doc(assetId).delete();
                    showSuccessMessage('Activo eliminado exitosamente');
                    renderAssetsList();
                } catch (error) {
                    console.error('Error deleting asset:', error);
                    showErrorMessage('Error al eliminar el activo');
                }
            }
        };

        // ===== GESTI√ìN DE PASIVOS =====
        const openLiabilitiesModal = () => {
            renderLiabilitiesModal();
            openModal(liabilitiesModalEl);
            lucide.createIcons();
        };

        const renderLiabilitiesModal = () => {
            liabilitiesModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-4xl m-4 rounded-2xl shadow-xl flex flex-col h-[80vh]">
                    <div class="flex justify-between items-center p-6 border-b dark:border-gray-700">
                        <h3 class="text-xl font-semibold flex items-center gap-2">
                            <i data-lucide="trending-down" class="text-red-500"></i>
                            Gestionar Pasivos
                        </h3>
                        <button class="js-close-modal p-1 rounded-full hover:bg-slate-200 dark:hover:bg-gray-700">
                            <i data-lucide="x"></i>
                        </button>
                    </div>

                    <div class="flex-1 p-6 overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-lg font-semibold">Mis Pasivos</h4>
                            <button id="add-liability-btn" class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
                                <i data-lucide="plus" class="w-4 h-4"></i>
                                Agregar Pasivo
                            </button>
                        </div>

                        <div id="liabilities-list" class="space-y-3">
                            <!-- Liabilities will be rendered here -->
                        </div>
                    </div>

                    <div class="p-4 border-t dark:border-gray-700 bg-slate-50 dark:bg-gray-800/50">
                        <div class="flex justify-between items-center">
                            <p class="text-sm text-slate-500 dark:text-slate-400">
                                üí° Mant√©n actualizados los saldos de tus deudas
                            </p>
                            <p class="text-lg font-semibold text-red-600 dark:text-red-400">
                                Total: <span id="modal-total-liabilities">${formatCurrency(liabilities.reduce((sum, l) => sum + (l.currentBalance || 0), 0))}</span>
                            </p>
                        </div>
                    </div>
                </div>`;

            liabilitiesModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(liabilitiesModalEl));
            liabilitiesModalEl.querySelector('#add-liability-btn').addEventListener('click', () => openLiabilityForm());

            renderLiabilitiesList();

            // Actualizar total en el modal
            const modalTotalLiabilities = liabilitiesModalEl.querySelector('#modal-total-liabilities');
            if (modalTotalLiabilities) {
                modalTotalLiabilities.textContent = formatCurrency(liabilities.reduce((sum, l) => sum + (l.currentBalance || 0), 0));
            }
        };

        const renderLiabilitiesList = () => {
            const liabilitiesList = liabilitiesModalEl.querySelector('#liabilities-list');

            if (liabilities.length === 0) {
                liabilitiesList.innerHTML = `
                    </div>
                `;
                return;
            }

            let html = '';
            liabilities.forEach(liability => {
                const monthsRemaining = liability.monthsRemaining || 0;
                const monthlyPayment = liability.monthlyPayment || 0;

                html += `
                    <div class="bg-slate-50 dark:bg-gray-700 p-4 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h5 class="font-semibold">${liability.name}</h5>
                                <p class="text-sm text-slate-500 dark:text-slate-400">${liability.category} ‚Ä∫ ${liability.subcategory || 'General'}</p>
                                <div class="flex gap-4 mt-2 text-xs text-slate-400 dark:text-slate-500">
                                    ${monthlyPayment > 0 ? `<span>Cuota: ${formatCurrency(monthlyPayment)}</span>` : ''}
                                    ${monthsRemaining > 0 ? `<span>Faltan: ${monthsRemaining} meses</span>` : ''}
                                    ${liability.interestRate ? `<span>Tasa: ${liability.interestRate}%</span>` : ''}
                                </div>
                                <p class="text-xs text-slate-400 dark:text-slate-500 mt-1">${liability.description || 'Sin descripci√≥n'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-semibold text-red-600 dark:text-red-400">${formatCurrency(liability.currentBalance || 0)}</p>
                                <p class="text-xs text-slate-500 dark:text-slate-400">Actualizado: ${liability.lastUpdated?.toDate().toLocaleDateString('es-ES') || 'Nunca'}</p>
                            </div>
                            <div class="flex flex-col gap-1 ml-2">
                                <button class="edit-liability-btn p-1 text-slate-400 hover:text-blue-600" data-id="${liability.id}">
                                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                                </button>
                                <button class="delete-liability-btn p-1 text-slate-400 hover:text-red-600" data-id="${liability.id}">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            liabilitiesList.innerHTML = html;

            // Add event listeners
            liabilitiesList.querySelectorAll('.edit-liability-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openLiabilityForm(e.target.closest('button').dataset.id));
            });

            liabilitiesList.querySelectorAll('.delete-liability-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteLiability(e.target.closest('button').dataset.id));
            });
        };

        const handleTransactionFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;

            // Recopilar datos b√°sicos del formulario
            const formData = {
                description: form.description.value,
                amount: parseFloat(form.amount.value),
                type: form.type.value,
                category: form.category.value,
                date: form['transaction-date'].value
            };

            // Agregar subcategor√≠as si est√°n seleccionadas
            const subcategory = form.subcategory?.value;
            const subsubcategory = form.subsubcategory?.value;

            if (subcategory) formData.subcategory = subcategory;
            if (subsubcategory) formData.subsubcategory = subsubcategory;

            // Recopilar campos espec√≠ficos
            const specificFields = {};
            const specificInputs = form.querySelectorAll('[name^="specific-"]');

            specificInputs.forEach(input => {
                const fieldName = input.name.replace('specific-', '');
                let value = input.value.trim();

                // Convertir valores seg√∫n el tipo
                if (input.type === 'number' && value) {
                    value = parseFloat(value);
                } else if (input.type === 'date' && value) {
                    value = value; // Mantener como string de fecha
                }

                if (value !== '' && value !== null && value !== undefined) {
                    specificFields[fieldName] = value;
                }
            });

            // Agregar campos espec√≠ficos si existen
            if (Object.keys(specificFields).length > 0) {
                formData.specificDetails = specificFields;
            }

            try {
                if (currentEditingId) {
                    await transactionsCollection.doc(currentEditingId).update(formData);
                    showSuccessMessage('Transacci√≥n actualizada exitosamente');
                } else {
                    await transactionsCollection.add({ ...formData, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                    showSuccessMessage('Transacci√≥n agregada exitosamente');
                }

                // üß† An√°lisis inteligente despu√©s de agregar/actualizar transacci√≥n
                setTimeout(async () => {
                    await generateInsightsAfterTransaction(formData);
                }, 1000);

                closeModal(transactionModalEl);
            } catch (error) {
                console.error("Error saving transaction:", error);
                showErrorMessage('Error al guardar la transacci√≥n');
            }
        };

        // üß† Generar insights inteligentes despu√©s de transacci√≥n
        const generateInsightsAfterTransaction = async (transaction) => {
            try {
                console.log('üß† Analizando transacci√≥n para generar insights...');

                // Analizar con IA Learning Engine si est√° disponible
                if (aiLearningEngine) {
                    const aiInsights = await aiLearningEngine.analyzeTransaction(transaction);
                    if (aiInsights.length > 0) {
                        proactiveInsights.push(...aiInsights);
                        console.log('üß† Agregados', aiInsights.length, 'insights de IA');
                    }
                }

                // üìä Actualizar an√°lisis predictivo
                if (predictiveAnalyticsEngine) {
                    const allTransactions = getTransactions();
                    if (allTransactions.length > 0) {
                        await predictiveAnalyticsEngine.initialize(allTransactions);

                        // Generar insights del dashboard predictivo
                        const dashboardInsights = predictiveAnalyticsEngine.generateInsightsForDashboard();

                        // Filtrar insights duplicados
                        const newInsights = dashboardInsights.filter(di =>
                            !proactiveInsights.some(pi => pi.message === di.message)
                        );

                        if (newInsights.length > 0) {
                            proactiveInsights.push(...newInsights);
                            console.log('üìä Agregados', newInsights.length, 'insights predictivos');
                        }
                    }
                }

                // Actualizar badge y mostrar notificaciones si hay insights importantes
                if (proactiveInsights.length > 0) {
                    updateInsightsBadge(proactiveInsights.length);

                    // Mostrar insights de alta prioridad inmediatamente
                    const highPriorityInsights = proactiveInsights.filter(i => i.priority === 'high');
                    if (highPriorityInsights.length > 0) {
                        setTimeout(() => {
                            showProactiveInsights();
                        }, 2000);
                    }
                }

                console.log('‚úÖ An√°lisis de transacci√≥n completado');
            } catch (error) {
                console.error('‚ùå Error generando insights despu√©s de transacci√≥n:', error);
            }
        };

        const handleTransactionListClick = (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            if (editBtn) openTransactionModal(editBtn.dataset.id);
            if (deleteBtn) transactionsCollection.doc(deleteBtn.dataset.id).delete();
        };

        const openBudgetModal = () => {
            budgetModalEl.innerHTML = `<div class="bg-white dark:bg-gray-800 w-full max-w-sm m-4 p-6 rounded-2xl shadow-xl"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Establecer Presupuesto</h3><button class="js-close-modal p-1 rounded-full"><i data-lucide="x"></i></button></div><form id="budget-form-dynamic"><div class="mb-4"><label for="budget-amount" class="block text-sm font-medium">Monto del Presupuesto Mensual</label><input type="number" id="budget-amount" value="${monthlyBudget > 0 ? monthlyBudget : ''}" min="0" step="1" class="w-full px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md" required></div><button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-md font-semibold">Guardar</button></form></div>`;
            openModal(budgetModalEl);
            lucide.createIcons();
            budgetModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(budgetModalEl));
            budgetModalEl.querySelector('#budget-form-dynamic').addEventListener('submit', handleBudgetFormSubmit);
        };

        const handleBudgetFormSubmit = async (e) => {
            e.preventDefault();
            const newAmount = parseFloat(e.target['budget-amount'].value);
            if (newAmount >= 0) { await budgetDocRef.set({ amount: newAmount }); closeModal(budgetModalEl); }
        };

        // üí≥ ===== GESTI√ìN DE CUENTAS POR PAGAR =====
        const openAccountsPayableModal = () => {
            renderAccountsPayableModal();
            openModal(accountsPayableModalEl);
            lucide.createIcons();
        };

        const renderAccountsPayableModal = () => {
            const upcomingPayments = getUpcomingPayments(7);
            const overduePayments = getOverduePayments();
            const totalMonthly = accountsPayable
                .filter(a => a.isActive && a.recurrenceType === 'monthly')
                .reduce((sum, a) => sum + a.amount, 0);

            accountsPayableModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-7xl xl:max-w-[90vw] m-4 rounded-2xl shadow-xl flex flex-col h-[90vh] min-w-[320px]">
                    <div class="flex justify-between items-center p-6 border-b dark:border-gray-700">
                        <h3 class="text-xl font-semibold flex items-center gap-2">
                            <i data-lucide="credit-card" class="text-purple-500"></i>
                            Cuentas por Pagar
                        </h3>
                        <button class="js-close-modal p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Resumen -->
                    <div class="p-6 border-b dark:border-gray-700">
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="calendar" class="w-5 h-5 text-blue-600"></i>
                                    <span class="text-sm font-medium text-blue-600 dark:text-blue-400">Pr√≥ximos 7 d√≠as</span>
                                </div>
                                <p class="text-2xl font-bold text-blue-700 dark:text-blue-300">${upcomingPayments.length}</p>
                            </div>
                            <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="alert-circle" class="w-5 h-5 text-red-600"></i>
                                    <span class="text-sm font-medium text-red-600 dark:text-red-400">Vencidas</span>
                                </div>
                                <p class="text-2xl font-bold text-red-700 dark:text-red-300">${overduePayments.length}</p>
                            </div>
                            <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="check-circle" class="w-5 h-5 text-green-600"></i>
                                    <span class="text-sm font-medium text-green-600 dark:text-green-400">Total Activas</span>
                                </div>
                                <p class="text-2xl font-bold text-green-700 dark:text-green-300">${accountsPayable.filter(a => a.isActive).length}</p>
                            </div>
                            <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="dollar-sign" class="w-5 h-5 text-purple-600"></i>
                                    <span class="text-sm font-medium text-purple-600 dark:text-purple-400">Mensual</span>
                                </div>
                                <p class="text-lg font-bold text-purple-700 dark:text-purple-300">${formatCurrency(totalMonthly)}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Controles -->
                    <div class="p-6 border-b dark:border-gray-700">
                        <div class="flex flex-col lg:flex-row gap-4 lg:justify-between lg:items-center">
                            <div class="flex flex-wrap gap-3">
                                <button id="add-account-payable-btn" class="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span>Nueva Cuenta</span>
                                </button>
                                <button id="calendar-view-btn" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                                    <i data-lucide="calendar" class="w-4 h-4"></i>
                                    <span>Calendario</span>
                                </button>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <select id="status-filter" class="px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white min-w-[140px] mobile-select-fix">
                                    <option value="all">Todas</option>
                                    <option value="pending">Pendientes</option>
                                    <option value="paid">Pagadas</option>
                                    <option value="overdue">Vencidas</option>
                                </select>
                                <div class="flex items-center gap-2">
                                    <button id="category-filter-btn" class="px-4 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white min-w-[180px] text-left flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors">
                                        <span id="category-filter-text">Todas las categor√≠as</span>
                                        <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400"></i>
                                    </button>
                                    <button id="clear-category-filter-btn" class="px-3 py-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors" title="Limpiar filtro de categor√≠a" style="display: none;">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lista de cuentas -->
                    <div class="flex-1 overflow-y-auto p-6 mobile-scroll-container">
                        <div id="accounts-payable-list" class="space-y-4">
                            <!-- Se llena din√°micamente -->
                        </div>
                    </div>
                </div>

                <!-- Overlay de selecci√≥n de categor√≠as -->
                <div id="category-overlay" class="category-overlay">
                    <div class="category-overlay-content">
                        <div class="category-overlay-header">
                            <div>
                                <h4 class="text-lg font-semibold text-gray-900 dark:text-white">Seleccionar Categor√≠a</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Elige una categor√≠a para filtrar las cuentas</p>
                            </div>
                            <button id="category-overlay-close" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                                <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                            </button>
                        </div>
                        <div class="category-overlay-body">
                            <div id="category-options-list">
                                <!-- Las opciones se generar√°n din√°micamente -->
                            </div>
                        </div>
                        <div class="category-overlay-footer">
                            <button id="category-overlay-cancel" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                Cancelar
                            </button>
                            <button id="category-overlay-save" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
                                Aplicar Filtro
                            </button>
                        </div>
                    </div>
                </div>
            `;

            accountsPayableModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(accountsPayableModalEl));
            accountsPayableModalEl.querySelector('#add-account-payable-btn').addEventListener('click', () => openAccountPayableForm());
            accountsPayableModalEl.querySelector('#calendar-view-btn').addEventListener('click', () => openAccountsPayableCalendar());

            // Event listeners para filtros
            accountsPayableModalEl.querySelector('#status-filter').addEventListener('change', renderAccountsPayableList);

            // Event listeners para el overlay de categor√≠as
            setupCategoryOverlay();

            renderAccountsPayableList();
        };

        const renderAccountsPayableList = () => {
            const listContainer = accountsPayableModalEl.querySelector('#accounts-payable-list');
            if (!listContainer) return;

            const statusFilter = accountsPayableModalEl.querySelector('#status-filter')?.value || 'all';
            const categoryFilter = selectedCategoryFilter || 'all';

            let filteredAccounts = accountsPayable.filter(account => {
                const statusMatch = statusFilter === 'all' || getAccountPayableStatus(account) === statusFilter;
                const categoryMatch = categoryFilter === 'all' || account.category === categoryFilter;
                return statusMatch && categoryMatch;
            });

            // Ordenar por fecha de vencimiento
            filteredAccounts.sort((a, b) => new Date(a.nextDueDate) - new Date(b.nextDueDate));

            // üìä Mostrar contador de resultados
            const counterText = categoryFilter === 'all'
                ? `${filteredAccounts.length} cuenta${filteredAccounts.length !== 1 ? 's' : ''} por pagar`
                : `${filteredAccounts.length} cuenta${filteredAccounts.length !== 1 ? 's' : ''} en ${categoryFilter}`;

            if (filteredAccounts.length === 0) {
                const emptyMessage = categoryFilter === 'all'
                    ? 'No hay cuentas por pagar que coincidan con los filtros'
                    : `No hay cuentas por pagar en la categor√≠a "${categoryFilter}"`;

                listContainer.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="credit-card" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
                        <p class="text-gray-500 dark:text-gray-400">${emptyMessage}</p>
                        ${categoryFilter !== 'all' ? `
                            <button id="clear-filter-from-empty" class="mt-4 px-4 py-2 text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300 font-medium">
                                Ver todas las cuentas
                            </button>
                        ` : ''}
                    </div>
                `;

                // Event listener para limpiar filtro desde estado vac√≠o
                if (categoryFilter !== 'all') {
                    listContainer.querySelector('#clear-filter-from-empty')?.addEventListener('click', clearCategoryFilter);
                }
                return;
            }

            // üìä Header con contador de resultados
            const headerHtml = `
                <div class="px-6 py-3 bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700 flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        ${counterText}
                    </span>
                    ${categoryFilter !== 'all' ? `
                        <button id="clear-filter-from-header" class="text-xs px-2 py-1 text-purple-600 hover:text-purple-700 dark:text-purple-400 dark:hover:text-purple-300 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded transition-colors">
                            Limpiar filtro
                        </button>
                    ` : ''}
                </div>
            `;

            listContainer.innerHTML = headerHtml + filteredAccounts.map(account => {
                const status = getAccountPayableStatus(account);
                const statusInfo = paymentStatuses[status];
                const daysUntilDue = Math.ceil((new Date(account.nextDueDate) - new Date()) / (1000 * 60 * 60 * 24));

                return `
                    <div class="bg-white dark:bg-gray-700 rounded-lg border dark:border-gray-600 p-5 hover:shadow-md transition-shadow">
                        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                            <div class="flex-1 min-w-0">
                                <div class="flex flex-wrap items-center gap-3 mb-3">
                                    <h4 class="font-semibold text-lg text-gray-900 dark:text-white truncate">${account.name}</h4>
                                    <span class="px-3 py-1 text-xs font-medium rounded-full ${statusInfo.color} whitespace-nowrap">
                                        ${statusInfo.label}
                                    </span>
                                    ${account.recurrenceType !== 'once' ?
                                        `<span class="px-3 py-1 text-xs bg-gray-100 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-full whitespace-nowrap">
                                            ${recurrenceTypes[account.recurrenceType]}
                                        </span>` : ''
                                    }
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-300 mb-3 line-clamp-2">${account.description || 'Sin descripci√≥n'}</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="flex items-center gap-2">
                                        <i data-lucide="tag" class="w-4 h-4 flex-shrink-0"></i>
                                        <span class="truncate">${account.category}${account.subcategory ? ` ‚Ä∫ ${account.subcategory}` : ''}</span>
                                    </span>
                                    <span class="flex items-center gap-2">
                                        <i data-lucide="calendar" class="w-4 h-4 flex-shrink-0"></i>
                                        <span class="whitespace-nowrap">${formatDate(account.nextDueDate)}</span>
                                    </span>
                                    ${daysUntilDue >= 0 ?
                                        `<span class="flex items-center gap-2">
                                            <i data-lucide="clock" class="w-4 h-4 flex-shrink-0"></i>
                                            <span class="whitespace-nowrap">${daysUntilDue === 0 ? 'Vence hoy' :
                                              daysUntilDue === 1 ? 'Vence ma√±ana' :
                                              `${daysUntilDue} d√≠as`}</span>
                                        </span>` :
                                        `<span class="flex items-center gap-2 text-red-600">
                                            <i data-lucide="alert-circle" class="w-4 h-4 flex-shrink-0"></i>
                                            <span class="whitespace-nowrap">Vencida hace ${Math.abs(daysUntilDue)} d√≠as</span>
                                        </span>`
                                    }
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 lg:gap-6">
                                <div class="text-left sm:text-right">
                                    <p class="text-2xl font-bold text-purple-600 dark:text-purple-400">
                                        ${formatCurrency(account.amount)}
                                    </p>
                                    ${account.paymentMethod ?
                                        `<p class="text-sm text-gray-500 dark:text-gray-400 mt-1">${account.paymentMethod}</p>` : ''
                                    }
                                </div>
                                <div class="flex flex-row sm:flex-col gap-2">
                                    ${status === 'pending' || status === 'overdue' ?
                                        `<button class="pay-account-btn px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium flex items-center gap-2" data-id="${account.id}">
                                            <i data-lucide="check" class="w-4 h-4"></i>
                                            <span class="hidden sm:inline">Pagar</span>
                                        </button>` : ''
                                    }
                                    <button class="edit-account-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium flex items-center gap-2" data-id="${account.id}">
                                        <i data-lucide="edit-3" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">Editar</span>
                                    </button>
                                    <button class="delete-account-btn px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium flex items-center gap-2" data-id="${account.id}">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        <span class="hidden sm:inline">Eliminar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Event listeners para botones de acci√≥n
            listContainer.querySelectorAll('.pay-account-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const accountId = e.target.closest('.pay-account-btn').dataset.id;
                    openPaymentModal(accountId);
                });
            });

            listContainer.querySelectorAll('.edit-account-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const accountId = e.target.closest('.edit-account-btn').dataset.id;
                    openAccountPayableForm(accountId);
                });
            });

            listContainer.querySelectorAll('.delete-account-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const accountId = e.target.closest('.delete-account-btn').dataset.id;
                    const account = accountsPayable.find(a => a.id === accountId);
                    if (confirm(`¬øEst√°s seguro de que quieres eliminar "${account.name}"?`)) {
                        try {
                            await deleteAccountPayable(accountId);
                            renderAccountsPayableList();
                        } catch (error) {
                            console.error('Error deleting account:', error);
                        }
                    }
                });
            });

            // Event listener para limpiar filtro desde header
            listContainer.querySelector('#clear-filter-from-header')?.addEventListener('click', clearCategoryFilter);

            lucide.createIcons();
        };

        // üé® Funciones para el overlay de selecci√≥n de categor√≠as
        let selectedCategoryFilter = 'all';

        const setupCategoryOverlay = () => {
            const categoryBtn = accountsPayableModalEl.querySelector('#category-filter-btn');
            const clearBtn = accountsPayableModalEl.querySelector('#clear-category-filter-btn');
            const overlay = accountsPayableModalEl.querySelector('#category-overlay');
            const closeBtn = accountsPayableModalEl.querySelector('#category-overlay-close');
            const cancelBtn = accountsPayableModalEl.querySelector('#category-overlay-cancel');
            const saveBtn = accountsPayableModalEl.querySelector('#category-overlay-save');

            // Abrir overlay
            categoryBtn.addEventListener('click', () => {
                openCategoryOverlay();
            });

            // Limpiar filtro
            clearBtn.addEventListener('click', clearCategoryFilter);

            // Cerrar overlay
            const closeOverlay = () => {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            };

            closeBtn.addEventListener('click', closeOverlay);
            cancelBtn.addEventListener('click', closeOverlay);

            // Cerrar al hacer clic en el fondo
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeOverlay();
                }
            });

            // Guardar selecci√≥n
            saveBtn.addEventListener('click', () => {
                applyCategoryFilter();
                closeOverlay();
            });

            // Navegaci√≥n por teclado
            overlay.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeOverlay();
                }
            });
        };

        // üßπ Funci√≥n para limpiar filtro de categor√≠a
        const clearCategoryFilter = () => {
            selectedCategoryFilter = 'all';
            const categoryText = accountsPayableModalEl.querySelector('#category-filter-text');
            const clearBtn = accountsPayableModalEl.querySelector('#clear-category-filter-btn');

            categoryText.textContent = 'Todas las categor√≠as';
            clearBtn.style.display = 'none';

            renderAccountsPayableList();
        };

        const openCategoryOverlay = () => {
            const overlay = accountsPayableModalEl.querySelector('#category-overlay');
            const optionsList = accountsPayableModalEl.querySelector('#category-options-list');

            // Generar opciones de categor√≠as
            const categories = ['all', ...getCategoriesForType('expense')];

            optionsList.innerHTML = categories.map(category => {
                const isSelected = selectedCategoryFilter === category;
                const displayName = category === 'all' ? 'Todas las categor√≠as' : category;

                return `
                    <div class="category-option ${isSelected ? 'selected' : ''}" data-category="${category}" tabindex="0">
                        <i data-lucide="check" class="category-option-icon w-5 h-5 text-purple-600"></i>
                        <span class="flex-1">${displayName}</span>
                    </div>
                `;
            }).join('');

            // Event listeners para las opciones
            optionsList.querySelectorAll('.category-option').forEach(option => {
                option.addEventListener('click', () => {
                    selectCategoryOption(option.dataset.category);
                });

                option.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        selectCategoryOption(option.dataset.category);
                    }
                });
            });

            // Mostrar overlay
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Enfocar la opci√≥n seleccionada
            const selectedOption = optionsList.querySelector('.category-option.selected');
            if (selectedOption) {
                selectedOption.focus();
            }

            lucide.createIcons();
        };

        const selectCategoryOption = (category) => {
            const optionsList = accountsPayableModalEl.querySelector('#category-options-list');

            // Remover selecci√≥n anterior
            optionsList.querySelectorAll('.category-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Agregar selecci√≥n nueva
            const selectedOption = optionsList.querySelector(`[data-category="${category}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
                selectedCategoryFilter = category;
            }
        };

        const applyCategoryFilter = () => {
            const categoryText = accountsPayableModalEl.querySelector('#category-filter-text');
            const clearBtn = accountsPayableModalEl.querySelector('#clear-category-filter-btn');
            const displayName = selectedCategoryFilter === 'all' ? 'Todas las categor√≠as' : selectedCategoryFilter;

            categoryText.textContent = displayName;

            // Mostrar/ocultar bot√≥n de limpiar filtro
            clearBtn.style.display = selectedCategoryFilter === 'all' ? 'none' : 'flex';

            renderAccountsPayableList();
        };



        const openAccountPayableForm = (accountId = null) => {
            currentEditingAccountId = accountId;
            const account = accountId ? accountsPayable.find(a => a.id === accountId) : null;
            const isEditing = !!account;

            accountPayableFormModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-2xl m-4 rounded-2xl shadow-xl flex flex-col max-h-[90vh]">
                    <div class="flex justify-between items-center p-6 border-b dark:border-gray-700">
                        <h3 class="text-xl font-semibold flex items-center gap-2">
                            <i data-lucide="credit-card" class="text-purple-500"></i>
                            ${isEditing ? 'Editar Cuenta por Pagar' : 'Nueva Cuenta por Pagar'}
                        </h3>
                        <button class="js-close-modal p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-6">
                        <form id="account-payable-form" class="space-y-6">
                            <!-- Informaci√≥n b√°sica -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Nombre de la cuenta *</label>
                                    <input type="text" name="name" value="${account?.name || ''}"
                                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                           placeholder="Ej: Servicio de Luz" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Monto *</label>
                                    <input type="number" name="amount" value="${account?.amount || ''}"
                                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                           placeholder="150000" min="0" step="1" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">Descripci√≥n</label>
                                <textarea name="description" rows="2"
                                          class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                          placeholder="Descripci√≥n opcional">${account?.description || ''}</textarea>
                            </div>

                            <!-- Categorizaci√≥n -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Categor√≠a *</label>
                                    <select name="category" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 mobile-select-fix" required>
                                        <option value="">Selecciona una categor√≠a</option>
                                        ${getCategoriesForType('expense').map(cat =>
                                            `<option value="${cat}" ${account?.category === cat ? 'selected' : ''}>${cat}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Subcategor√≠a</label>
                                    <select name="subcategory" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 mobile-select-fix">
                                        <option value="">Selecciona una subcategor√≠a</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Configuraci√≥n de monto -->
                            <div>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" name="isFixedAmount" ${account?.isFixedAmount !== false ? 'checked' : ''}
                                           class="rounded">
                                    <span class="text-sm font-medium">Monto fijo</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1">Desmarcar si el monto puede variar cada mes</p>
                            </div>

                            <!-- Recurrencia -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Tipo de recurrencia *</label>
                                    <select name="recurrenceType" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required>
                                        ${Object.entries(recurrenceTypes).map(([key, label]) =>
                                            `<option value="${key}" ${account?.recurrenceType === key ? 'selected' : ''}>${label}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div id="custom-recurrence-container" style="display: none;">
                                    <label class="block text-sm font-medium mb-2">D√≠as personalizados</label>
                                    <input type="number" name="customRecurrenceDays" value="${account?.customRecurrenceDays || ''}"
                                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                           placeholder="30" min="1">
                                </div>
                            </div>

                            <!-- Fechas -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Primera fecha de vencimiento *</label>
                                    <input type="date" name="firstDueDate" value="${account?.firstDueDate || account?.nextDueDate || ''}"
                                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">D√≠as de alerta antes del vencimiento</label>
                                    <select name="alertDaysBefore" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                                        <option value="1" ${account?.alertDaysBefore === 1 ? 'selected' : ''}>1 d√≠a</option>
                                        <option value="3" ${account?.alertDaysBefore === 3 || !account ? 'selected' : ''}>3 d√≠as</option>
                                        <option value="7" ${account?.alertDaysBefore === 7 ? 'selected' : ''}>7 d√≠as</option>
                                        <option value="15" ${account?.alertDaysBefore === 15 ? 'selected' : ''}>15 d√≠as</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Informaci√≥n adicional -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">M√©todo de pago preferido</label>
                                    <input type="text" name="paymentMethod" value="${account?.paymentMethod || ''}"
                                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                           placeholder="Ej: Transferencia, Efectivo">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">N√∫mero de cuenta/referencia</label>
                                    <input type="text" name="accountNumber" value="${account?.accountNumber || ''}"
                                           class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                           placeholder="Opcional">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">Notas adicionales</label>
                                <textarea name="notes" rows="2"
                                          class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                          placeholder="Notas opcionales">${account?.notes || ''}</textarea>
                            </div>
                        </form>
                    </div>

                    <div class="p-6 border-t dark:border-gray-700">
                        <div class="flex gap-3 justify-end">
                            <button type="button" class="js-close-modal px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" form="account-payable-form" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                                ${isEditing ? 'Actualizar' : 'Crear'} Cuenta
                            </button>
                        </div>
                    </div>
                </div>
            `;

            openModal(accountPayableFormModalEl);
            lucide.createIcons();

            // Event listeners
            accountPayableFormModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(accountPayableFormModalEl));
            accountPayableFormModalEl.querySelector('#account-payable-form').addEventListener('submit', handleAccountPayableFormSubmit);

            // Manejar cambio de categor√≠a
            const categorySelect = accountPayableFormModalEl.querySelector('[name="category"]');
            const subcategorySelect = accountPayableFormModalEl.querySelector('[name="subcategory"]');

            categorySelect.addEventListener('change', (e) => {
                const category = e.target.value;
                subcategorySelect.innerHTML = '<option value="">Selecciona una subcategor√≠a</option>';

                if (category) {
                    const subcategories = getSubcategoriesForCategory('expense', category);
                    subcategories.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub;
                        option.textContent = sub;
                        if (account?.subcategory === sub) option.selected = true;
                        subcategorySelect.appendChild(option);
                    });
                }
            });

            // Manejar recurrencia personalizada
            const recurrenceSelect = accountPayableFormModalEl.querySelector('[name="recurrenceType"]');
            const customContainer = accountPayableFormModalEl.querySelector('#custom-recurrence-container');

            recurrenceSelect.addEventListener('change', (e) => {
                customContainer.style.display = e.target.value === 'custom' ? 'block' : 'none';
            });

            // Inicializar subcategor√≠as si hay categor√≠a seleccionada
            if (account?.category) {
                categorySelect.dispatchEvent(new Event('change'));
            }

            // Mostrar recurrencia personalizada si aplica
            if (account?.recurrenceType === 'custom') {
                customContainer.style.display = 'block';
            }
        };

        const handleAccountPayableFormSubmit = async (e) => {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);

            const accountData = {
                name: formData.get('name'),
                description: formData.get('description'),
                amount: parseFloat(formData.get('amount')),
                category: formData.get('category'),
                subcategory: formData.get('subcategory') || null,
                isFixedAmount: formData.has('isFixedAmount'),
                recurrenceType: formData.get('recurrenceType'),
                customRecurrenceDays: formData.get('customRecurrenceDays') ? parseInt(formData.get('customRecurrenceDays')) : null,
                firstDueDate: formData.get('firstDueDate'),
                nextDueDate: formData.get('firstDueDate'), // Inicialmente igual a la primera fecha
                alertDaysBefore: parseInt(formData.get('alertDaysBefore')),
                paymentMethod: formData.get('paymentMethod') || null,
                accountNumber: formData.get('accountNumber') || null,
                notes: formData.get('notes') || null
            };

            try {
                if (currentEditingAccountId) {
                    await updateAccountPayable(currentEditingAccountId, accountData);
                } else {
                    await createAccountPayable(accountData);
                }

                closeModal(accountPayableFormModalEl);
                renderAccountsPayableList();
            } catch (error) {
                console.error('Error saving account payable:', error);
            }
        };

        const openPaymentModal = (accountId) => {
            const account = accountsPayable.find(a => a.id === accountId);
            if (!account) return;

            paymentModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-md m-4 rounded-2xl shadow-xl">
                    <div class="flex justify-between items-center p-6 border-b dark:border-gray-700">
                        <h3 class="text-xl font-semibold flex items-center gap-2">
                            <i data-lucide="check-circle" class="text-green-500"></i>
                            Registrar Pago
                        </h3>
                        <button class="js-close-modal p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <div class="p-6">
                        <div class="mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <h4 class="font-semibold">${account.name}</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-300">Vence: ${formatDate(account.nextDueDate)}</p>
                        </div>

                        <form id="payment-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Monto a pagar *</label>
                                <input type="number" name="amount" value="${account.amount}"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                       min="0" step="1" required ${account.isFixedAmount ? 'readonly' : ''}>
                                ${!account.isFixedAmount ? '<p class="text-xs text-gray-500 mt-1">Puedes modificar el monto si es variable</p>' : ''}
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">M√©todo de pago</label>
                                <input type="text" name="paymentMethod" value="${account.paymentMethod || ''}"
                                       class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                       placeholder="Ej: Transferencia, Efectivo">
                            </div>

                            <div>
                                <label class="block text-sm font-medium mb-2">Notas del pago</label>
                                <textarea name="notes" rows="2"
                                          class="w-full px-3 py-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600"
                                          placeholder="Notas opcionales sobre este pago"></textarea>
                            </div>

                            <div>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" name="createTransaction" checked class="rounded">
                                    <span class="text-sm font-medium">Crear transacci√≥n autom√°ticamente</span>
                                </label>
                                <p class="text-xs text-gray-500 mt-1">Se registrar√° como gasto en tus transacciones</p>
                            </div>
                        </form>
                    </div>

                    <div class="p-6 border-t dark:border-gray-700">
                        <div class="flex gap-3 justify-end">
                            <button type="button" class="js-close-modal px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
                                Cancelar
                            </button>
                            <button type="submit" form="payment-form" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                Registrar Pago
                            </button>
                        </div>
                    </div>
                </div>
            `;

            openModal(paymentModalEl);
            lucide.createIcons();

            paymentModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(paymentModalEl));
            paymentModalEl.querySelector('#payment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const form = e.target;
                const formData = new FormData(form);

                const paymentData = {
                    amount: parseFloat(formData.get('amount')),
                    paymentMethod: formData.get('paymentMethod'),
                    notes: formData.get('notes'),
                    createTransaction: formData.has('createTransaction')
                };

                try {
                    await markAccountAsPaid(accountId, paymentData);
                    closeModal(paymentModalEl);
                    renderAccountsPayableList();
                } catch (error) {
                    console.error('Error registering payment:', error);
                }
            });
        };

        const openAccountsPayableCalendar = () => {
            // Placeholder para el calendario - se implementar√° en la siguiente fase
            showNotification('Calendario de pagos - Pr√≥ximamente disponible', 'info');
        };

        const openAiChatModal = async () => {
            aiChatHistory = [];

            // üß† Crear interfaz avanzada con memoria
            const memoryStats = aiMemorySystem ? aiMemorySystem.getMemoryStats() : null;
            const hasMemory = memoryStats && memoryStats.conversationsCount > 0;

            aiChatModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-2xl m-4 rounded-2xl shadow-xl flex flex-col h-[80vh]">
                    <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                        <div class="flex items-center gap-2">
                            <i data-lucide="brain-circuit" class="text-purple-500"></i>
                            <div>
                                <h3 class="text-xl font-semibold">FinGenius ${hasMemory ? 'üß†' : ''}</h3>
                                ${hasMemory ? `<p class="text-xs text-gray-500">Recuerda ${memoryStats.conversationsCount} conversaciones</p>` : ''}
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${hasMemory ? `<button id="memory-stats-btn" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Ver estad√≠sticas de memoria"><i data-lucide="database" class="w-4 h-4"></i></button>` : ''}
                            <button class="js-close-modal p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="x"></i></button>
                        </div>
                    </div>
                    <div id="ai-chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4"></div>
                    <div class="p-4 border-t dark:border-gray-700">
                        <form id="ai-chat-form" class="flex gap-2">
                            <input type="text" id="ai-chat-input" class="flex-1 px-3 py-2 bg-slate-50 dark:bg-gray-700 border rounded-md" placeholder="Preg√∫ntale a FinGenius..." required>
                            <button type="submit" class="bg-purple-600 text-white p-2 rounded-md hover:bg-purple-700 transition-colors">
                                <i data-lucide="send"></i>
                            </button>
                        </form>
                    </div>
                </div>`;

            openModal(aiChatModalEl);
            lucide.createIcons();

            // Event listeners
            aiChatModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(aiChatModalEl));
            aiChatModalEl.querySelector('#ai-chat-form').addEventListener('submit', handleAdvancedAiChatSubmit);

            // Bot√≥n de estad√≠sticas de memoria
            const memoryStatsBtn = aiChatModalEl.querySelector('#memory-stats-btn');
            if (memoryStatsBtn) {
                memoryStatsBtn.addEventListener('click', showMemoryStats);
            }

            // üß† Mensaje de bienvenida personalizado
            const welcomeMessage = await generateWelcomeMessage();
            addAiMessage(welcomeMessage);
        };

        const addChatMessage = (message, sender) => {
            const messagesContainer = aiChatModalEl.querySelector('#ai-chat-messages');
            const bubble = document.createElement('div');
            bubble.className = `w-fit max-w-lg rounded-xl px-4 py-2 ${sender === 'user' ? 'chat-bubble-user self-end' : 'chat-bubble-ai self-start'}`;
            bubble.innerHTML = message;
            messagesContainer.appendChild(bubble);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        };

        const addAiMessage = (text) => addChatMessage(marked.parse(text), 'ai');
        const addUserMessage = (text) => addChatMessage(text, 'user');

        // üß† Funci√≥n avanzada de chat con memoria y aprendizaje
        const handleAdvancedAiChatSubmit = async (e) => {
            e.preventDefault();
            const input = e.target.querySelector('#ai-chat-input');
            const userMessage = input.value.trim();
            if (!userMessage) return;

            addUserMessage(userMessage);
            input.value = '';
            addChatMessage('<div class="flex items-center gap-2"><i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>Analizando con memoria avanzada...</div>', 'ai');

            try {
                // üß† Generar contexto personalizado con memoria
                const personalizedContext = aiMemorySystem ? aiMemorySystem.generatePersonalizedContext() : '';

                // üìä Datos financieros actuales
                const transactionData = transactions.map(t => {
                    let categoryInfo = t.category;
                    if (t.subcategory) categoryInfo += ` ‚Ä∫ ${t.subcategory}`;
                    if (t.subsubcategory) categoryInfo += ` ‚Ä∫ ${t.subsubcategory}`;
                    return `${t.type}: ${t.description} (${categoryInfo}) - ${formatCurrency(t.amount)}`;
                }).join('\n');

                // üéØ Prompt avanzado con contexto personalizado
                const advancedPrompt = `System: Eres FinGenius, un asesor financiero inteligente con memoria avanzada.

${personalizedContext}

Datos financieros actuales:
${transactionData}
Presupuesto Mensual: ${formatCurrency(monthlyBudget)}

Instrucciones:
- Usa la informaci√≥n del perfil del usuario para personalizar tu respuesta
- Referencia conversaciones anteriores cuando sea relevante
- Adapta tu estilo de comunicaci√≥n a las preferencias del usuario
- Proporciona consejos espec√≠ficos basados en los patrones identificados
- S√© amigable, √∫til y proactivo

---`;

                // üöÄ Llamada a la API con contexto avanzado
                aiChatHistory.push({ role: "user", parts: [{ text: userMessage }] });

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            { role: "user", parts: [{ text: advancedPrompt }] },
                            ...aiChatHistory
                        ]
                    })
                });

                if (!response.ok) throw new Error('API Error');
                const result = await response.json();
                let aiResponse = result.candidates[0].content.parts[0].text;

                // üéì Adaptar respuesta bas√°ndose en el aprendizaje
                if (aiLearningEngine) {
                    aiResponse = aiLearningEngine.adaptToUserBehavior(userMessage, aiResponse);
                }

                aiChatHistory.push({ role: "model", parts: [{ text: aiResponse }] });

                // üß† Procesar conversaci√≥n para memoria y aprendizaje
                if (aiMemorySystem) {
                    await aiMemorySystem.processConversation(userMessage, aiResponse);
                }

                // Mostrar respuesta
                const loadingElement = aiChatModalEl.querySelector('.animate-spin')?.parentElement || aiChatModalEl.querySelector('.animate-spin');
                if (loadingElement) loadingElement.remove();
                addAiMessage(aiResponse);

                // üéØ Generar insights proactivos despu√©s de la conversaci√≥n
                if (aiLearningEngine && Math.random() < 0.3) { // 30% de probabilidad
                    setTimeout(async () => {
                        const newInsights = await aiLearningEngine.generateProactiveAdvice();
                        if (newInsights.length > 0) {
                            proactiveInsights = newInsights;
                        }
                    }, 2000);
                }

            } catch (error) {
                console.error('‚ùå Error en chat avanzado:', error);
                const loadingElement = aiChatModalEl.querySelector('.animate-spin')?.parentElement || aiChatModalEl.querySelector('.animate-spin');
                if (loadingElement) loadingElement.remove();
                addAiMessage("Lo siento, tuve un problema para conectarme. Intenta de nuevo.");
            }
        };

        // üîÑ Mantener compatibilidad con sistema b√°sico
        const handleAiChatSubmit = handleAdvancedAiChatSubmit;

        // üß† Generar mensaje de bienvenida personalizado
        const generateWelcomeMessage = async () => {
            if (!aiMemorySystem || !aiMemorySystem.initialized) {
                return "¬°Hola! Soy FinGenius. ¬øEn qu√© puedo ayudarte con tus finanzas hoy?";
            }

            const stats = aiMemorySystem.getMemoryStats();
            const userProfile = aiMemorySystem.userProfile;

            let welcomeMessage = "¬°Hola de nuevo! üß† ";

            if (stats.conversationsCount > 0) {
                welcomeMessage += `Recuerdo nuestras ${stats.conversationsCount} conversaciones anteriores. `;
            }

            if (userProfile.behaviorInsights.length > 0) {
                const randomInsight = userProfile.behaviorInsights[Math.floor(Math.random() * userProfile.behaviorInsights.length)];
                welcomeMessage += `\n\nüí° **Recordatorio**: ${randomInsight}`;
            }

            // Agregar predicciones proactivas si las hay
            if (proactiveInsights.length > 0) {
                const highPriorityInsights = proactiveInsights.filter(insight => insight.priority === 'high');
                if (highPriorityInsights.length > 0) {
                    welcomeMessage += `\n\n‚ö†Ô∏è **Alerta importante**: ${highPriorityInsights[0].message}`;
                }
            }

            welcomeMessage += "\n\n¬øEn qu√© puedo ayudarte hoy?";
            return welcomeMessage;
        };

        // üìä Mostrar estad√≠sticas de memoria
        const showMemoryStats = () => {
            if (!aiMemorySystem) return;

            const stats = aiMemorySystem.getMemoryStats();
            const statsMessage = `
## üß† Estad√≠sticas de Memoria IA

**Conversaciones recordadas:** ${stats.conversationsCount}
**Contextos rastreados:** ${stats.contextsTracked}
**Preguntas frecuentes:** ${stats.frequentQuestionsCount}
**Preferencias aprendidas:** ${stats.userPreferencesCount}
**√öltima actualizaci√≥n:** ${new Date(stats.profileLastUpdated).toLocaleDateString()}

### üéØ Perfil de Usuario
- **Tama√±o familiar:** ${aiMemorySystem.userProfile.familySize} personas
- **Tolerancia al riesgo:** ${aiMemorySystem.userProfile.riskTolerance}
- **Categor√≠as frecuentes:** ${Array.from(aiMemorySystem.userProfile.preferredCategories.keys()).slice(0, 3).join(', ')}

### üìà Insights de Comportamiento
${aiMemorySystem.userProfile.behaviorInsights.slice(0, 3).map(insight => `- ${insight}`).join('\n')}
            `;

            addAiMessage(statsMessage);
        };

        // üéØ Mostrar insights proactivos
        const showProactiveInsights = () => {
            if (proactiveInsights.length === 0) return;

            // Actualizar badge
            updateInsightsBadge(proactiveInsights.length);

            // Mostrar notificaci√≥n discreta
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-purple-600 text-white p-3 rounded-lg shadow-lg z-50 max-w-sm cursor-pointer';
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <i data-lucide="brain-circuit" class="w-5 h-5"></i>
                    <div>
                        <p class="font-semibold">FinGenius tiene insights para ti</p>
                        <p class="text-sm opacity-90">${proactiveInsights.length} recomendaci√≥n${proactiveInsights.length > 1 ? 'es' : ''} personalizada${proactiveInsights.length > 1 ? 's' : ''}</p>
                        <p class="text-xs opacity-75 mt-1">Haz clic para ver detalles</p>
                    </div>
                    <button onclick="event.stopPropagation(); this.parentElement.parentElement.remove()" class="ml-2 hover:bg-purple-700 rounded p-1">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;

            // Hacer clic en la notificaci√≥n abre el modal de insights
            notification.addEventListener('click', () => {
                notification.remove();
                openProactiveInsightsModal();
            });

            document.body.appendChild(notification);
            lucide.createIcons();

            // Auto-remover despu√©s de 10 segundos
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        };

        // üéØ Abrir modal de insights proactivos
        const openProactiveInsightsModal = async () => {
            if (!aiLearningEngine) {
                addAiMessage("El sistema de insights avanzados no est√° disponible. Aseg√∫rate de que el sistema de IA est√© inicializado.");
                return;
            }

            // Generar insights frescos
            const freshInsights = await aiLearningEngine.generateProactiveAdvice();
            if (freshInsights.length > 0) {
                proactiveInsights = freshInsights;
            }

            if (proactiveInsights.length === 0) {
                proactiveInsights = [{
                    title: 'üéØ Todo en orden',
                    message: 'No hay alertas urgentes en este momento. Tu situaci√≥n financiera parece estable.',
                    priority: 'low',
                    actions: ['Contin√∫a monitoreando tus gastos', 'Considera establecer nuevas metas de ahorro']
                }];
            }

            const insightsHTML = proactiveInsights.map(insight => `
                <div class="bg-gradient-to-r ${getPriorityGradient(insight.priority)} p-4 rounded-lg mb-4 text-white">
                    <h4 class="font-semibold text-lg mb-2">${insight.title}</h4>
                    <p class="mb-3">${insight.message}</p>
                    ${insight.actions && insight.actions.length > 0 ? `
                        <div class="mt-3">
                            <p class="font-medium mb-2">Acciones recomendadas:</p>
                            <ul class="list-disc list-inside space-y-1 text-sm">
                                ${insight.actions.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            aiChatModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-2xl m-4 rounded-2xl shadow-xl flex flex-col max-h-[80vh]">
                    <div class="flex justify-between items-center p-4 border-b dark:border-gray-700">
                        <h3 class="text-xl font-semibold flex items-center gap-2">
                            <i data-lucide="zap" class="text-purple-500"></i>
                            Insights Proactivos
                        </h3>
                        <button class="js-close-modal p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i data-lucide="x"></i>
                        </button>
                    </div>
                    <div class="flex-1 p-4 overflow-y-auto">
                        <div class="mb-4">
                            <p class="text-gray-600 dark:text-gray-400 text-sm">
                                üß† An√°lisis basado en tu historial financiero y patrones de comportamiento
                            </p>
                        </div>
                        ${insightsHTML}
                        <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                üí° <strong>Tip:</strong> Los insights se actualizan autom√°ticamente bas√°ndose en tus nuevas transacciones y conversaciones con FinGenius.
                            </p>
                        </div>
                    </div>
                    <div class="p-4 border-t dark:border-gray-700">
                        <button onclick="openAiChatModal(); closeModal(aiChatModalEl);" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">
                            üí¨ Hablar con FinGenius sobre estos insights
                        </button>
                    </div>
                </div>
            `;

            openModal(aiChatModalEl);
            lucide.createIcons();
            aiChatModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(aiChatModalEl));

            // Limpiar badge despu√©s de ver los insights
            updateInsightsBadge(0);
        };

        // üé® Obtener gradiente seg√∫n prioridad
        const getPriorityGradient = (priority) => {
            switch (priority) {
                case 'high': return 'from-red-500 to-red-600';
                case 'medium': return 'from-yellow-500 to-orange-500';
                case 'low': return 'from-green-500 to-green-600';
                default: return 'from-purple-500 to-purple-600';
            }
        };

        // üî¢ Actualizar badge de insights
        const updateInsightsBadge = (count) => {
            if (count > 0) {
                insightsBadge.textContent = count;
                insightsBadge.classList.remove('hidden');
            } else {
                insightsBadge.classList.add('hidden');
            }
        };

        // üìä Abrir Dashboard Predictivo
        const openPredictiveDashboard = async () => {
            console.log('üìä Abriendo Dashboard Predictivo...');
            try {
                // Verificar que las clases est√©n disponibles
                if (typeof PredictiveAnalyticsEngine === 'undefined') {
                    console.error('‚ùå PredictiveAnalyticsEngine no est√° disponible');
                    addAiMessage("‚ùå **Error de Sistema**\n\nEl motor de an√°lisis predictivo no se ha cargado correctamente.\n\n**Soluci√≥n**: Recarga la p√°gina e int√©ntalo de nuevo.");
                    openAiChatModal();
                    return;
                }

                if (typeof PredictiveDashboard === 'undefined') {
                    console.error('‚ùå PredictiveDashboard no est√° disponible');
                    addAiMessage("‚ùå **Error de Sistema**\n\nEl dashboard predictivo no se ha cargado correctamente.\n\n**Soluci√≥n**: Recarga la p√°gina e int√©ntalo de nuevo.");
                    openAiChatModal();
                    return;
                }

                // Verificar autenticaci√≥n
                if (!firebase.auth().currentUser) {
                    addAiMessage("‚ùå **Error de Autenticaci√≥n**\n\nDebes estar autenticado para acceder al Dashboard Predictivo.\n\nPor favor, inicia sesi√≥n primero.");
                    openAiChatModal();
                    return;
                }

                // Inicializar motor de an√°lisis si no existe
                if (!predictiveAnalyticsEngine) {
                    console.log('üîß Inicializando PredictiveAnalyticsEngine...');
                    predictiveAnalyticsEngine = new PredictiveAnalyticsEngine();
                }

                // Inicializar dashboard si no existe
                if (!predictiveDashboard) {
                    console.log('üîß Inicializando PredictiveDashboard...');
                    predictiveDashboard = new PredictiveDashboard();
                }

                // Obtener transacciones actuales
                console.log('üìã Obteniendo transacciones...');
                const transactions = getTransactions();
                console.log('üìã Transacciones obtenidas:', transactions.length);

                if (transactions.length === 0) {
                    console.log('‚ö†Ô∏è No hay transacciones disponibles');
                    addAiMessage("üìä **Dashboard Predictivo**\n\nPara generar predicciones precisas, necesitas tener al menos algunas transacciones registradas.\n\nüí° **Sugerencia**: Agrega algunas transacciones de ejemplo y luego vuelve a abrir el dashboard.");
                    openAiChatModal();
                    return;
                }

                // Inicializar motor de an√°lisis con transacciones
                console.log('üîß Inicializando motor de an√°lisis...');
                await predictiveAnalyticsEngine.initialize(transactions);

                // Inicializar dashboard
                console.log('üîß Inicializando dashboard...');
                await predictiveDashboard.initialize(predictiveAnalyticsEngine, transactions);

                // Mostrar dashboard
                console.log('üìä Mostrando dashboard...');
                await predictiveDashboard.showDashboard();

                console.log('‚úÖ Dashboard Predictivo abierto exitosamente con', transactions.length, 'transacciones');

            } catch (error) {
                console.error('‚ùå Error abriendo Dashboard Predictivo:', error);

                let errorMessage = "‚ùå **Error del Dashboard Predictivo**\n\n";
                errorMessage += "Hubo un problema al abrir el dashboard.\n\n";
                errorMessage += "**Detalles del error**: " + error.message + "\n\n";
                errorMessage += "**Posibles soluciones**:\n";
                errorMessage += "‚Ä¢ Recarga la p√°gina e int√©ntalo de nuevo\n";
                errorMessage += "‚Ä¢ Verifica que tengas transacciones registradas\n";
                errorMessage += "‚Ä¢ Aseg√∫rate de estar autenticado correctamente\n\n";
                errorMessage += "Si el problema persiste, contacta al soporte t√©cnico.";

                addAiMessage(errorMessage);
                openAiChatModal();
            }
        };

        // üíæ Abrir Gesti√≥n de Backups
        const openBackupManagement = async () => {
            console.log('üíæ Abriendo Gesti√≥n de Backups...');
            try {
                // Verificar que las clases est√©n disponibles
                if (typeof AutomaticBackupSystem === 'undefined') {
                    throw new Error('AutomaticBackupSystem no est√° disponible - verifica que automatic-backup-system.js se haya cargado');
                }

                if (typeof MultiExportSystem === 'undefined') {
                    throw new Error('MultiExportSystem no est√° disponible - verifica que multi-export-system.js se haya cargado');
                }

                if (typeof BackupManagementUI === 'undefined') {
                    throw new Error('BackupManagementUI no est√° disponible - verifica que backup-management-ui.js se haya cargado');
                }

                // Verificar autenticaci√≥n
                if (!firebase.auth().currentUser) {
                    addAiMessage("‚ùå **Error de Autenticaci√≥n**\n\nDebes estar autenticado para acceder al sistema de backups.\n\nPor favor, inicia sesi√≥n primero.");
                    openAiChatModal();
                    return;
                }

                // Verificar que window.appId est√© definido
                if (!window.appId) {
                    addAiMessage("‚ùå **Error de Configuraci√≥n**\n\nLa aplicaci√≥n no est√° configurada correctamente (falta appId).\n\nPor favor, recarga la p√°gina e int√©ntalo de nuevo.");
                    openAiChatModal();
                    return;
                }

                // Inicializar sistemas de backup si no existen
                if (!automaticBackupSystem) {
                    console.log('üíæ Inicializando sistema de backups autom√°ticos...');
                    automaticBackupSystem = new AutomaticBackupSystem();
                    const initialized = await automaticBackupSystem.initialize();
                    if (!initialized) {
                        throw new Error('No se pudo inicializar el sistema de backups autom√°ticos');
                    }
                }

                if (!multiExportSystem) {
                    console.log('üì§ Inicializando sistema de exportaci√≥n...');
                    multiExportSystem = new MultiExportSystem();
                }

                if (!backupRestoreSystem) {
                    console.log('üîÑ Inicializando sistema de restauraci√≥n...');
                    backupRestoreSystem = new BackupRestoreSystem();
                }

                if (!backupManagementUI) {
                    console.log('‚öôÔ∏è Inicializando interfaz de gesti√≥n...');
                    backupManagementUI = new BackupManagementUI();
                    await backupManagementUI.initialize(
                        automaticBackupSystem,
                        multiExportSystem,
                        backupRestoreSystem
                    );
                }

                // Mostrar panel de gesti√≥n
                await backupManagementUI.showBackupPanel();

                console.log('üíæ Panel de gesti√≥n de backups abierto exitosamente');

            } catch (error) {
                console.error('‚ùå Error abriendo gesti√≥n de backups:', error);

                let errorMessage = "‚ùå **Error del Sistema de Backups**\n\n";
                errorMessage += "Hubo un problema al abrir la gesti√≥n de backups.\n\n";
                errorMessage += "**Detalles del error**: " + error.message + "\n\n";
                errorMessage += "**Posibles soluciones**:\n";
                errorMessage += "‚Ä¢ Recarga la p√°gina e int√©ntalo de nuevo\n";
                errorMessage += "‚Ä¢ Verifica tu conexi√≥n a internet\n";
                errorMessage += "‚Ä¢ Aseg√∫rate de estar autenticado correctamente\n\n";
                errorMessage += "Si el problema persiste, contacta al soporte t√©cnico.";

                addAiMessage(errorMessage);
                openAiChatModal();
            }
        };

        // üß™ Abrir Panel de Testing
        const openTestingPanel = async () => {
            console.log('üß™ Abriendo Panel de Testing...');
            console.log('üîç Estado actual del sistema:');
            console.log('  - testingFramework:', !!testingFramework);
            console.log('  - testRunner:', !!testRunner);
            console.log('  - testingUI:', !!testingUI);
            console.log('  - window.appTests:', !!window.appTests);

            try {
                // Verificar que el sistema de testing est√© inicializado
                if (!testingUI) {
                    console.error('‚ùå testingUI no est√° inicializado');
                    throw new Error('Sistema de testing no inicializado. Recarga la p√°gina e int√©ntalo de nuevo.');
                }

                console.log('‚úÖ testingUI disponible, llamando showTestingPanel()...');

                // Mostrar panel de testing
                testingUI.showTestingPanel();

                console.log('‚úÖ Panel de testing abierto exitosamente');

            } catch (error) {
                console.error('‚ùå Error abriendo panel de testing:', error);
                console.error('‚ùå Stack trace:', error.stack);

                let errorMessage = "‚ùå **Error del Sistema de Testing**\n\n";
                errorMessage += "Hubo un problema al abrir el panel de testing.\n\n";
                errorMessage += "**Detalles del error**: " + error.message + "\n\n";
                errorMessage += "**Estado del sistema**:\n";
                errorMessage += `‚Ä¢ testingFramework: ${!!testingFramework}\n`;
                errorMessage += `‚Ä¢ testRunner: ${!!testRunner}\n`;
                errorMessage += `‚Ä¢ testingUI: ${!!testingUI}\n`;
                errorMessage += `‚Ä¢ window.appTests: ${!!window.appTests}\n\n`;
                errorMessage += "**Posibles soluciones**:\n";
                errorMessage += "‚Ä¢ Recarga la p√°gina e int√©ntalo de nuevo\n";
                errorMessage += "‚Ä¢ Verifica tu conexi√≥n a internet\n";
                errorMessage += "‚Ä¢ Aseg√∫rate de que todos los scripts se hayan cargado\n";
                errorMessage += "‚Ä¢ Ejecuta `diagnosticarTesting()` en la consola para m√°s detalles\n\n";
                errorMessage += "Si el problema persiste, contacta al soporte t√©cnico.";

                // Mostrar error en consola tambi√©n
                alert('Error del Sistema de Testing: ' + error.message + '\n\nRevisa la consola para m√°s detalles.');
            }
        };

        const openTipsModal = async () => {
            tipsModalEl.innerHTML = `<div class="bg-white dark:bg-gray-800 w-full max-w-2xl m-4 p-6 rounded-2xl shadow-xl"><div class="text-center py-8"><i data-lucide="loader-2" class="w-12 h-12 mx-auto animate-spin text-teal-500"></i><p class="mt-4">Buscando consejos personalizados...</p></div></div>`;
            openModal(tipsModalEl);
            lucide.createIcons();

            // Verificaci√≥n r√°pida de API key
            console.log("API Key configurada:", GEMINI_API_KEY ? "S√≠" : "No");
            console.log("Longitud de API Key:", GEMINI_API_KEY ? GEMINI_API_KEY.length : 0);
            console.log("N√∫mero de transacciones:", transactions.length);
            console.log("Transacciones de gastos:", transactions.filter(t => t.type === 'expense').length);

            await handleGenerateTips();
        };

        const handleGenerateTips = async () => {
            const transactionData = transactions.filter(t => t.type === 'expense').map(t => {
                let categoryInfo = t.category;
                if (t.subcategory) categoryInfo += ` ‚Ä∫ ${t.subcategory}`;
                if (t.subsubcategory) categoryInfo += ` ‚Ä∫ ${t.subsubcategory}`;
                return `${t.description} (${categoryInfo}): ${formatCurrency(t.amount)}`;
            }).join('\n');
            if (transactionData.length === 0) {
                displayTipsError("No hay suficientes datos de gastos para generar consejos.");
                return;
            }

                        // üöÄ PROMPT MEJORADO: Audaz, perspicaz y centrado en la familia
            const familyContext = `El an√°lisis es para una familia. El objetivo es mejorar su salud financiera, optimizar gastos y aumentar ahorros.`;
            const prompt = `Eres FinGenius, un asesor financiero personal brillante, audaz y perspicaz. Tu especialidad son las finanzas familiares.
${familyContext}
Analiza estas transacciones y descubre patrones ocultos, correlaciones inesperadas y oportunidades de optimizaci√≥n significativas. No des consejos gen√©ricos. S√© valiente en tus conclusiones y ofrece perspectivas que el usuario no haya considerado.
Ignora por completo conceptos de finanzas corporativas (ej. inventarios, EBITDA, etc.).
Tu respuesta DEBE ser un objeto JSON v√°lido y nada m√°s, sin markdown. El formato es: {"tips": [{"title": "string", "short_description": "string", "details": "string", "actionable_advice": "string"}]}.
Transacciones:
${transactionData}`;

            try {
                console.log("Enviando solicitud a Gemini API...");
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                console.log("Respuesta recibida, status:", response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Error de API:", response.status, errorText);
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log("Resultado de la API:", result);

                if (!result.candidates || !result.candidates[0] || !result.candidates[0].content) {
                    throw new Error("Respuesta de API inv√°lida: no se encontraron candidatos");
                }

                const textResponse = result.candidates[0].content.parts[0].text;
                console.log("Texto de respuesta:", textResponse);

                const cleanedResponse = textResponse.replace(/```json|```/g, '').trim();
                const jsonResponse = JSON.parse(cleanedResponse);

                financialTips = jsonResponse.tips || [];
                if (financialTips.length > 0) {
                    currentTipIndex = 0;
                    displayTip(currentTipIndex);
                } else {
                    displayTipsError("No se encontraron consejos espec√≠ficos en este momento.");
                }
            } catch (error) {
                console.error("Error detallado generando tips:", error);
                let errorMessage = "No se pudieron generar los consejos. ";

                if (error.message.includes("API Error: 400")) {
                    errorMessage += "Problema con la solicitud a la API.";
                } else if (error.message.includes("API Error: 403")) {
                    errorMessage += "API key inv√°lida o sin permisos.";
                } else if (error.message.includes("API Error: 429")) {
                    errorMessage += "L√≠mite de solicitudes excedido.";
                } else if (error.message.includes("JSON")) {
                    errorMessage += "Error procesando la respuesta.";
                } else {
                    errorMessage += "Int√©ntalo de nuevo.";
                }

                displayTipsError(errorMessage);
            }
        };

        const displayTip = (index) => {
            const tip = financialTips[index];
            tipsModalEl.innerHTML = `
                <div class="bg-white dark:bg-gray-800 w-full max-w-2xl m-4 rounded-2xl shadow-xl flex flex-col h-auto max-h-[80vh]">
                    <div class="flex justify-between items-center p-4 border-b dark:border-gray-700"><h3 class="text-xl font-semibold flex items-center gap-2"><i data-lucide="lightbulb" class="text-teal-500"></i>Tips Financieros</h3><button class="js-close-modal p-1 rounded-full"><i data-lucide="x"></i></button></div>
                    <div class="flex-1 p-6 overflow-y-auto">
                        <h4 class="text-2xl font-bold text-slate-800 dark:text-slate-100">${tip.title}</h4>
                        <p class="text-lg mt-2 text-slate-600 dark:text-slate-300">${tip.short_description}</p>
                        <details class="mt-4"><summary class="cursor-pointer font-semibold text-indigo-600 dark:text-indigo-400">Ver detalles</summary><div class="mt-2 prose dark:prose-dark max-w-none">${marked.parse(tip.details + "\n\n**Sugerencia:** " + tip.actionable_advice)}</div></details>
                    </div>
                    <div class="flex justify-between items-center p-4 border-t dark:border-gray-700">
                        <button id="prev-tip-btn" class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-slate-200 dark:bg-gray-700 hover:bg-slate-300 dark:hover:bg-gray-600 disabled:opacity-50"><i data-lucide="arrow-left"></i> Anterior</button>
                        <span class="text-sm font-medium">${index + 1} / ${financialTips.length}</span>
                        <button id="next-tip-btn" class="flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-md bg-slate-200 dark:bg-gray-700 hover:bg-slate-300 dark:hover:bg-gray-600 disabled:opacity-50">Siguiente <i data-lucide="arrow-right"></i></button>
                    </div>
                </div>`;
            lucide.createIcons();
            tipsModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(tipsModalEl));
            const prevBtn = tipsModalEl.querySelector('#prev-tip-btn');
            const nextBtn = tipsModalEl.querySelector('#next-tip-btn');
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === financialTips.length - 1;
            prevBtn.addEventListener('click', () => displayTip(--currentTipIndex));
            nextBtn.addEventListener('click', () => displayTip(++currentTipIndex));
        };

        const displayTipsError = (message) => {
            tipsModalEl.innerHTML = `<div class="bg-white dark:bg-gray-800 w-full max-w-md m-4 p-6 rounded-2xl shadow-xl text-center"><p>${message}</p><button id="test-api-btn" class="mt-2 px-4 py-2 bg-yellow-600 text-white rounded-md mr-2">Probar API</button><button class="js-close-modal mt-4 px-4 py-2 bg-indigo-600 text-white rounded-md">Cerrar</button></div>`;
            tipsModalEl.querySelector('.js-close-modal').addEventListener('click', () => closeModal(tipsModalEl));
            tipsModalEl.querySelector('#test-api-btn').addEventListener('click', testApiConnection);
        };

        const testApiConnection = async () => {
            console.log("Probando conexi√≥n con API...");
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: "Responde solo con: 'API funcionando correctamente'" }]
                        }]
                    })
                });

                console.log("Status de prueba:", response.status);

                if (response.ok) {
                    const result = await response.json();
                    console.log("Prueba exitosa:", result);
                    alert("‚úÖ API funcionando correctamente");
                } else {
                    const errorText = await response.text();
                    console.error("Error en prueba:", response.status, errorText);
                    alert(`‚ùå Error ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error("Error de conexi√≥n:", error);
                alert(`‚ùå Error de conexi√≥n: ${error.message}`);
            }
        };

        const initAppEventListeners = () => {
            console.log('üîß Inicializando event listeners...');

            // Verificar que los elementos existan
            console.log('üîç Verificando elementos del DOM:');
            console.log('predictiveDashboardBtn:', predictiveDashboardBtn);
            console.log('backupManagementBtn:', backupManagementBtn);

            addTransactionBtn.addEventListener('click', () => openTransactionModal());
            transactionListEl.addEventListener('click', handleTransactionListClick);
            editBudgetBtn.addEventListener('click', openBudgetModal);
            aiAssistantBtn.addEventListener('click', openAiChatModal);
            tipsBtn.addEventListener('click', openTipsModal);
            proactiveInsightsBtn.addEventListener('click', openProactiveInsightsModal);

            // Event listeners con verificaci√≥n
            if (predictiveDashboardBtn) {
                predictiveDashboardBtn.addEventListener('click', openPredictiveDashboard);
                console.log('‚úÖ Event listener agregado para Dashboard Predictivo (principal)');
            } else {
                console.error('‚ùå predictiveDashboardBtn no encontrado');
            }



            if (backupManagementBtn) {
                backupManagementBtn.addEventListener('click', openBackupManagement);
                console.log('‚úÖ Event listener agregado para Gesti√≥n de Backups');
            } else {
                console.error('‚ùå backupManagementBtn no encontrado');
            }

            // Event listener para Testing se configura en la inicializaci√≥n del sistema de testing

            manageCategoriesBtn.addEventListener('click', openCategoriesModal);
            manageAssetsBtn.addEventListener('click', openAssetsModal);
            manageLiabilitiesBtn.addEventListener('click', openLiabilitiesModal);
            manageAccountsPayableBtn.addEventListener('click', openAccountsPayableModal);

            console.log('‚úÖ Event listeners inicializados');
        };

        const initAuth = () => {
            console.log('üî• Inicializando Firebase con configuraci√≥n compat...');

            // Usar Firebase v9 compat
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();

            console.log('‚úÖ Firebase inicializado correctamente');

            // üß™ Inicializar Sistema de Testing Avanzado (independiente de autenticaci√≥n)
            const initializeTestingSystem = () => {
                try {
                    console.log('üß™ Inicializando sistema de testing avanzado...');
                    console.log('üîç Verificando dependencias:');
                    console.log('  - TestingFramework:', typeof TestingFramework !== 'undefined');
                    console.log('  - TestRunner:', typeof TestRunner !== 'undefined');
                    console.log('  - TestingUI:', typeof TestingUI !== 'undefined');
                    console.log('  - expect:', typeof expect !== 'undefined');
                    console.log('  - window.appTests:', !!window.appTests);

                    // Verificar que las clases est√©n disponibles
                    if (typeof TestingFramework === 'undefined') {
                        console.warn('‚ö†Ô∏è TestingFramework no disponible - verifica que testing-framework.js se haya cargado');
                        return;
                    }

                    if (typeof TestRunner === 'undefined') {
                        console.warn('‚ö†Ô∏è TestRunner no disponible - verifica que test-runner.js se haya cargado');
                        return;
                    }

                    if (typeof TestingUI === 'undefined') {
                        console.warn('‚ö†Ô∏è TestingUI no disponible - verifica que test-ui.js se haya cargado');
                        return;
                    }

                    if (typeof expect === 'undefined') {
                        console.warn('‚ö†Ô∏è expect no disponible - verifica que assertions.js se haya cargado');
                        return;
                    }

                    // El framework ya est√° inicializado en app-tests.js
                    testingFramework = window.appTests;

                    if (testingFramework) {
                        console.log('‚úÖ window.appTests encontrado, inicializando componentes...');

                        testRunner = new TestRunner();
                        testRunner.initialize(testingFramework);
                        console.log('‚úÖ TestRunner inicializado');

                        testingUI = new TestingUI();
                        testingUI.initialize(testRunner);
                        console.log('‚úÖ TestingUI inicializado');

                        // Event listener del bot√≥n Testing removido - bot√≥n eliminado de la interfaz

                        console.log('‚úÖ Sistema de testing inicializado correctamente');
                    } else {
                        console.warn('‚ö†Ô∏è Testing framework no disponible en window.appTests');
                        console.warn('   Esto puede deberse a un error en app-tests.js');
                        console.warn('   Verifica la consola para errores de sintaxis');
                    }
                } catch (testingError) {
                    console.error('‚ùå Error inicializando sistema de testing:', testingError);
                    console.error('‚ùå Stack trace:', testingError.stack);
                }
            };

            // Inicializar sistema de testing despu√©s de un delay para asegurar que todos los scripts se hayan cargado
            setTimeout(initializeTestingSystem, 2000);

            // Intentar nuevamente si la primera vez falla
            setTimeout(() => {
                if (!testingUI) {
                    console.log('üîÑ Reintentando inicializaci√≥n del sistema de testing...');
                    initializeTestingSystem();
                }
            }, 5000);

            // Configurar listener de autenticaci√≥n
            auth.onAuthStateChanged(user => user ? showApp(user) : showAuth());

            // Configurar event listeners
            authForm.addEventListener('submit', handleAuthFormSubmit);
            authToggleBtn.addEventListener('click', toggleAuthMode);
            forgotPasswordBtn.addEventListener('click', handlePasswordReset);
            logoutBtn.addEventListener('click', handleLogout);
            themeToggle.addEventListener('click', toggleTheme);
            initAppEventListeners();

            console.log('‚úÖ Event listeners configurados');
        };

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            applyTheme(savedTheme);

            // üîê Sistema simplificado - secure-config.js maneja la inicializaci√≥n
            console.log('üîê DOM cargado, secure-config.js se encargar√° de la inicializaci√≥n');
        });
    </script>
</body>
</html>
