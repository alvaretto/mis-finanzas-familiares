name: ðŸš€ Deploy to GitHub Pages with Secure Config

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”’ Generate Secure Config
        run: |
          # Crear config.js con credenciales reales desde secrets
          cat > config.js << 'EOF'
          // ðŸŒ CONFIGURACIÃ“N PARA GITHUB PAGES - GENERADA AUTOMÃTICAMENTE
          // Este archivo es generado dinÃ¡micamente por GitHub Actions
          // Las credenciales se almacenan de forma segura en GitHub Secrets
          
          // âš ï¸ IMPORTANTE: Esta configuraciÃ³n es pÃºblica pero segura
          // - Firebase estÃ¡ configurado con reglas de seguridad apropiadas
          // - API Key de Gemini restringida solo para alvaretto.github.io
          // - Los datos estÃ¡n protegidos por autenticaciÃ³n Firebase
          // - Ideal para acceso mÃ³vil y uso familiar desde mÃºltiples dispositivos
          
          // ðŸ”’ CONFIGURACIÃ“N DUAL:
          // - GitHub Pages: Usa este archivo (generado automÃ¡ticamente)
          // - Local: Usa config.js para desarrollo con credenciales privadas
          
          // ðŸ” API Key de Gemini (restringida por dominio)
          const GEMINI_API_KEY = "${{ secrets.GEMINI_API_KEY }}";
          
          // ðŸ”¥ ConfiguraciÃ³n de Firebase (con reglas de seguridad estrictas)
          const firebaseConfig = {
              apiKey: "${{ secrets.FIREBASE_API_KEY }}",
              authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
              projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
              storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
              messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
              appId: "${{ secrets.FIREBASE_APP_ID }}",
              measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };
          
          // ðŸ·ï¸ ID de la aplicaciÃ³n
          const appId = '${{ secrets.FIREBASE_PROJECT_ID }}';
          
          // ðŸš€ Exportar configuraciÃ³n para uso en GitHub Pages
          window.APP_CONFIG = {
              GEMINI_API_KEY,
              firebaseConfig,
              appId,
              isPublicDeployment: true,
              generatedAt: new Date().toISOString()
          };
          
          // ðŸ“¢ Mensaje informativo
          console.log('ðŸŒ AplicaciÃ³n ejecutÃ¡ndose en GitHub Pages');
          console.log('ðŸ”’ ConfiguraciÃ³n generada de forma segura');
          console.log('ðŸ”¥ Firebase configurado para uso familiar');
          console.log('ðŸ“± Listo para acceso desde mÃ³viles');
          console.log('ðŸ“‚ Repositorio: https://github.com/alvaretto/mis-finanzas-familiares');
          EOF
          
          echo "âœ… config.js generado con credenciales seguras"

      - name: ðŸ” Verificar ConfiguraciÃ³n
        run: |
          echo "ðŸ“‹ Verificando que config.js fue generado correctamente..."
          if [ -f "config.js" ]; then
            echo "âœ… config.js existe"
            echo "ðŸ“ TamaÃ±o: $(wc -c < config.js) bytes"
            echo "ðŸ“ Primeras lÃ­neas:"
            head -5 config.js
          else
            echo "âŒ ERROR: config.js no fue generado"
            exit 1
          fi

      - name: ðŸ“„ Setup Pages
        uses: actions/configure-pages@v4

      - name: ðŸ“¦ Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… Deployment Success
        run: |
          echo "ðŸŽ‰ Despliegue completado exitosamente!"
          echo "ðŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ðŸ“± La aplicaciÃ³n deberÃ­a funcionar en mÃ³vil en 2-3 minutos"
