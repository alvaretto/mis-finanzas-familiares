// üß† SISTEMA DE MEMORIA AVANZADO PARA FinGenius
// Desaf√≠o 1: Asistente IA Conversacional Avanzado

class AIMemorySystem {
    constructor() {
        this.userProfile = {
            spendingPatterns: [],
            financialGoals: [],
            riskTolerance: 'moderate',
            familySize: 2,
            monthlyIncome: 0,
            preferredCategories: new Map(),
            behaviorInsights: [],
            lastUpdated: new Date().toISOString()
        };
        
        this.conversationHistory = [];
        this.contextMemory = new Map(); // Memoria de contexto por temas
        this.learningData = {
            frequentQuestions: new Map(),
            userPreferences: new Map(),
            successfulAdvice: [],
            feedbackHistory: []
        };
        
        this.initialized = false;
    }

    // üîÑ Inicializar sistema de memoria
    async initialize(userId) {
        this.userId = userId;
        await this.loadUserProfile();
        await this.loadConversationHistory();
        await this.loadLearningData();
        this.initialized = true;
        console.log('üß† Sistema de memoria IA inicializado para usuario:', userId);
    }

    // üíæ Cargar perfil del usuario desde Firebase
    async loadUserProfile() {
        try {
            const profileDoc = await firebase.firestore()
                .doc(`artifacts/${window.appId}/ai_memory_data/${this.userId}`)
                .get();
            
            if (profileDoc.exists) {
                this.userProfile = { ...this.userProfile, ...profileDoc.data() };
                console.log('‚úÖ Perfil de usuario cargado desde memoria');
            } else {
                // Crear perfil inicial basado en datos existentes
                await this.createInitialProfile();
            }
        } catch (error) {
            console.error('‚ùå Error cargando perfil:', error);
        }
    }

    // üéØ Crear perfil inicial analizando transacciones existentes
    async createInitialProfile() {
        try {
            // Analizar transacciones para crear perfil inicial
            const transactions = window.transactions || [];
            const analysis = this.analyzeTransactionPatterns(transactions);
            
            this.userProfile = {
                ...this.userProfile,
                spendingPatterns: analysis.patterns,
                preferredCategories: analysis.topCategories,
                monthlyIncome: analysis.avgIncome,
                behaviorInsights: analysis.insights,
                lastUpdated: new Date().toISOString()
            };

            await this.saveUserProfile();
            console.log('üéØ Perfil inicial creado basado en transacciones');
        } catch (error) {
            console.error('‚ùå Error creando perfil inicial:', error);
        }
    }

    // üìä Analizar patrones de transacciones
    analyzeTransactionPatterns(transactions) {
        const patterns = [];
        const categoryCount = new Map();
        const monthlyTotals = new Map();
        let totalIncome = 0;
        let incomeCount = 0;

        transactions.forEach(t => {
            const date = new Date(t.date || t.createdAt?.toDate?.() || Date.now());
            const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
            
            // Contar categor√≠as
            const categoryKey = `${t.category}${t.subcategory ? ` ‚Ä∫ ${t.subcategory}` : ''}`;
            categoryCount.set(categoryKey, (categoryCount.get(categoryKey) || 0) + 1);
            
            // Calcular ingresos promedio
            if (t.type === 'income') {
                totalIncome += t.amount;
                incomeCount++;
            }
            
            // Totales mensuales
            if (!monthlyTotals.has(monthKey)) {
                monthlyTotals.set(monthKey, { income: 0, expense: 0 });
            }
            monthlyTotals.get(monthKey)[t.type] += t.amount;
        });

        // Generar insights
        const insights = [];
        const topCategories = Array.from(categoryCount.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([category, count]) => ({ category, frequency: count }));

        if (topCategories.length > 0) {
            insights.push(`Tu categor√≠a m√°s frecuente es "${topCategories[0].category}"`);
        }

        const avgIncome = incomeCount > 0 ? totalIncome / incomeCount : 0;
        if (avgIncome > 0) {
            insights.push(`Tu ingreso promedio por transacci√≥n es ${this.formatCurrency(avgIncome)}`);
        }

        return {
            patterns: Array.from(monthlyTotals.entries()).map(([month, totals]) => ({
                month,
                income: totals.income,
                expense: totals.expense,
                balance: totals.income - totals.expense
            })),
            topCategories: new Map(topCategories.map(item => [item.category, item.frequency])),
            avgIncome,
            insights
        };
    }

    // üí¨ Cargar historial de conversaciones
    async loadConversationHistory() {
        try {
            const historyDoc = await firebase.firestore()
                .doc(`artifacts/${window.appId}/ai_memory_data/${this.userId}`)
                .get();
            
            if (historyDoc.exists) {
                const data = historyDoc.data();
                this.conversationHistory = data.conversations?.history || [];
                this.contextMemory = new Map(data.contextMemory || []);
                console.log('üí¨ Historial de conversaciones cargado');
            }
        } catch (error) {
            console.error('‚ùå Error cargando historial:', error);
        }
    }

    // üéì Cargar datos de aprendizaje
    async loadLearningData() {
        try {
            const learningDoc = await firebase.firestore()
                .doc(`artifacts/${window.appId}/ai_memory_data/${this.userId}`)
                .get();
            
            if (learningDoc.exists) {
                const data = learningDoc.data();
                const learningData = data.learning || {};
                this.learningData = {
                    frequentQuestions: new Map(learningData.frequentQuestions || []),
                    userPreferences: new Map(learningData.userPreferences || []),
                    successfulAdvice: learningData.successfulAdvice || [],
                    feedbackHistory: learningData.feedbackHistory || []
                };
                console.log('üéì Datos de aprendizaje cargados');
            }
        } catch (error) {
            console.error('‚ùå Error cargando datos de aprendizaje:', error);
        }
    }

    // üíæ Guardar perfil de usuario
    async saveUserProfile() {
        try {
            await firebase.firestore()
                .doc(`artifacts/${window.appId}/ai_memory_data/${this.userId}`)
                .set({ profile: this.userProfile }, { merge: true });
        } catch (error) {
            console.error('‚ùå Error guardando perfil:', error);
        }
    }

    // üíæ Guardar historial de conversaciones
    async saveConversationHistory() {
        try {
            await firebase.firestore()
                .doc(`artifacts/${window.appId}/ai_memory_data/${this.userId}`)
                .set({
                    conversations: {
                        history: this.conversationHistory.slice(-50), // Mantener √∫ltimas 50 conversaciones
                        contextMemory: Array.from(this.contextMemory.entries()),
                        lastUpdated: new Date().toISOString()
                    }
                }, { merge: true });
        } catch (error) {
            console.error('‚ùå Error guardando historial:', error);
        }
    }

    // üíæ Guardar datos de aprendizaje
    async saveLearningData() {
        try {
            await firebase.firestore()
                .doc(`artifacts/${window.appId}/ai_memory_data/${this.userId}`)
                .set({
                    learning: {
                        frequentQuestions: Array.from(this.learningData.frequentQuestions.entries()),
                        userPreferences: Array.from(this.learningData.userPreferences.entries()),
                        successfulAdvice: this.learningData.successfulAdvice,
                        feedbackHistory: this.learningData.feedbackHistory,
                        lastUpdated: new Date().toISOString()
                    }
                }, { merge: true });
        } catch (error) {
            console.error('‚ùå Error guardando datos de aprendizaje:', error);
        }
    }

    // üß† Procesar nueva conversaci√≥n
    async processConversation(userMessage, aiResponse) {
        if (!this.initialized) return;

        const conversation = {
            timestamp: new Date().toISOString(),
            userMessage,
            aiResponse,
            context: this.extractContext(userMessage)
        };

        this.conversationHistory.push(conversation);
        
        // Actualizar memoria de contexto
        this.updateContextMemory(conversation);
        
        // Aprender de la conversaci√≥n
        this.learnFromConversation(conversation);
        
        // Guardar cambios
        await this.saveConversationHistory();
        await this.saveLearningData();
    }

    // üéØ Extraer contexto de la conversaci√≥n
    extractContext(message) {
        const contexts = [];
        const lowerMessage = message.toLowerCase();
        
        // Detectar temas financieros
        if (lowerMessage.includes('presupuesto') || lowerMessage.includes('budget')) {
            contexts.push('presupuesto');
        }
        if (lowerMessage.includes('ahorro') || lowerMessage.includes('ahorrar')) {
            contexts.push('ahorro');
        }
        if (lowerMessage.includes('gasto') || lowerMessage.includes('gastar')) {
            contexts.push('gastos');
        }
        if (lowerMessage.includes('inversi√≥n') || lowerMessage.includes('invertir')) {
            contexts.push('inversiones');
        }
        if (lowerMessage.includes('deuda') || lowerMessage.includes('pr√©stamo')) {
            contexts.push('deudas');
        }
        
        return contexts;
    }

    // üîÑ Actualizar memoria de contexto
    updateContextMemory(conversation) {
        conversation.context.forEach(context => {
            if (!this.contextMemory.has(context)) {
                this.contextMemory.set(context, []);
            }
            
            const contextHistory = this.contextMemory.get(context);
            contextHistory.push({
                timestamp: conversation.timestamp,
                userMessage: conversation.userMessage,
                aiResponse: conversation.aiResponse
            });
            
            // Mantener solo las √∫ltimas 10 conversaciones por contexto
            if (contextHistory.length > 10) {
                contextHistory.shift();
            }
        });
    }

    // üéì Aprender de la conversaci√≥n
    learnFromConversation(conversation) {
        // Contar preguntas frecuentes
        const questionKey = this.normalizeQuestion(conversation.userMessage);
        const currentCount = this.learningData.frequentQuestions.get(questionKey) || 0;
        this.learningData.frequentQuestions.set(questionKey, currentCount + 1);
        
        // Detectar preferencias del usuario
        this.detectUserPreferences(conversation);
    }

    // üîç Detectar preferencias del usuario
    detectUserPreferences(conversation) {
        const message = conversation.userMessage.toLowerCase();
        
        // Detectar preferencias de comunicaci√≥n
        if (message.includes('detallado') || message.includes('explicaci√≥n')) {
            this.learningData.userPreferences.set('communication_style', 'detailed');
        } else if (message.includes('r√°pido') || message.includes('resumen')) {
            this.learningData.userPreferences.set('communication_style', 'concise');
        }
        
        // Detectar intereses financieros
        if (message.includes('inversi√≥n') || message.includes('invertir')) {
            const currentInterest = this.learningData.userPreferences.get('investment_interest') || 0;
            this.learningData.userPreferences.set('investment_interest', currentInterest + 1);
        }
    }

    // üîß Normalizar pregunta para detecci√≥n de patrones
    normalizeQuestion(question) {
        return question.toLowerCase()
            .replace(/[¬ø?¬°!]/g, '')
            .replace(/\s+/g, ' ')
            .trim()
            .substring(0, 50); // Primeras 50 caracteres
    }

    // üí∞ Formatear moneda
    formatCurrency(amount) {
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0
        }).format(amount);
    }

    // üéØ Generar contexto personalizado para IA
    generatePersonalizedContext() {
        if (!this.initialized) return '';

        let context = `Informaci√≥n del usuario:\n`;
        
        // Perfil b√°sico
        context += `- Tama√±o familiar: ${this.userProfile.familySize} personas\n`;
        context += `- Tolerancia al riesgo: ${this.userProfile.riskTolerance}\n`;
        
        if (this.userProfile.monthlyIncome > 0) {
            context += `- Ingreso promedio: ${this.formatCurrency(this.userProfile.monthlyIncome)}\n`;
        }
        
        // Patrones de gasto
        if (this.userProfile.preferredCategories.size > 0) {
            context += `- Categor√≠as m√°s frecuentes: ${Array.from(this.userProfile.preferredCategories.keys()).slice(0, 3).join(', ')}\n`;
        }
        
        // Insights de comportamiento
        if (this.userProfile.behaviorInsights.length > 0) {
            context += `- Insights: ${this.userProfile.behaviorInsights.slice(0, 2).join('; ')}\n`;
        }
        
        // Historial de conversaciones relevantes
        const recentConversations = this.conversationHistory.slice(-3);
        if (recentConversations.length > 0) {
            context += `\nConversaciones recientes:\n`;
            recentConversations.forEach((conv, index) => {
                context += `${index + 1}. Usuario: "${conv.userMessage.substring(0, 50)}..."\n`;
                context += `   FinGenius: "${conv.aiResponse.substring(0, 50)}..."\n`;
            });
        }
        
        // Preferencias de comunicaci√≥n
        const commStyle = this.learningData.userPreferences.get('communication_style');
        if (commStyle) {
            context += `\nEstilo de comunicaci√≥n preferido: ${commStyle === 'detailed' ? 'detallado' : 'conciso'}\n`;
        }
        
        return context;
    }

    // üìä Obtener estad√≠sticas de memoria
    getMemoryStats() {
        return {
            conversationsCount: this.conversationHistory.length,
            contextsTracked: this.contextMemory.size,
            frequentQuestionsCount: this.learningData.frequentQuestions.size,
            userPreferencesCount: this.learningData.userPreferences.size,
            profileLastUpdated: this.userProfile.lastUpdated,
            isInitialized: this.initialized
        };
    }
}

// üåü Instancia global del sistema de memoria
window.AIMemorySystem = AIMemorySystem;
